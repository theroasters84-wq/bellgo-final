<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    
    <title>Delivery</title>
    <link rel="icon" type="image/png" href="shop.png">
    <link rel="apple-touch-icon" href="shop.png">
    
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Delivery">

    <link rel="manifest" id="dynamicManifest">

    <script src="https://js.stripe.com/v3/"></script>

    <script>
        (function() {
            const params = new URLSearchParams(window.location.search);
            const pName = params.get('name');
            let pStore = params.get('store');

            if (!pStore) {
                const pathParts = window.location.pathname.split('/');
                const shopIndex = pathParts.indexOf('shop');
                if (shopIndex !== -1 && pathParts[shopIndex + 1]) {
                    pStore = pathParts[shopIndex + 1];
                }
            }

            if (pName) {
                document.title = decodeURIComponent(pName);
                let metaTitle = document.querySelector('meta[name="apple-mobile-web-app-title"]');
                if(metaTitle) metaTitle.setAttribute('content', decodeURIComponent(pName));
            }

            const manifestLink = document.getElementById('dynamicManifest');
            let manifestUrl = `manifest.json?icon=shop`; 
            if (pStore) manifestUrl += `&store=${encodeURIComponent(pStore)}`;
            if (pName) manifestUrl += `&name=${encodeURIComponent(pName)}`;
            
            manifestLink.setAttribute('href', manifestUrl);
        })();
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        .header { height: 60px; background: #1e1e1e; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333; flex-shrink: 0; z-index: 10; }
        .store-info { display: flex; flex-direction: column; }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .btn-logout { background: #D32F2F; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }
        
        .btn-header-install { display: none; background: #00E676; color: black; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; animation: pulse 2s infinite; }

        /* LOGIN SCREEN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .btn-google { background: #DB4437; color: white; border: none; padding: 15px 25px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-top: 20px; box-shadow: 0 4px 15px rgba(219,68,55,0.4); }
        .btn-install-app { display: none; margin-top: 20px; background: transparent; border: 2px solid #FFD700; color: #FFD700; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 14px; }

        /* OVERLAYS */
        .overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .details-box { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; text-align: center; }
        .inp-detail { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; font-size: 16px; width: 100%; }
        .btn-save-details { padding: 12px; background: #00E676; color: black; border: none; border-radius: 5px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; width: 100%; }

        /* PAYMENT BUTTONS */
        .btn-pay { width: 100%; padding: 15px; margin: 5px 0; border-radius: 8px; border: 1px solid #444; background: #333; color: white; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-pay:active { background: #FFD700; color: black; transform: scale(0.98); }
        .btn-pay:disabled { opacity: 0.5; cursor: not-allowed; background: #222; border-color: #333; color: #555; }

        /* MAIN LAYOUT */
        #appContent { display: none; flex-direction: column; height: 100%; width: 100%; position: relative; }

        #menuContainer { flex: 1; overflow-y: auto; padding: 10px; background: #121212; display: flex; flex-direction: column; gap: 15px; padding-bottom: 120px; /* Space for hidden panel */ transition: all 0.3s ease; }
        
        .category-block { width: 100%; }
        .category-title { color: #FFD700; font-weight: bold; font-size: 16px; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 2px; text-transform: uppercase; }
        .category-items { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .item-box { 
            background: #222; border: 1px solid #444; padding: 12px 14px; border-radius: 8px; 
            color: #eee; font-size: 15px; cursor: pointer; transition: transform 0.1s; user-select: none; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .item-box:active { transform: scale(0.95); background: #333; border-color: #FFD700; }
        .item-name { font-style: italic; }
        .item-price { background: #00E676; color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 13px; margin-left: 8px; }

        /* ORDER PANEL - SLIDING */
        .order-panel { 
            background: #1a1a1a; 
            border-top: 2px solid #333; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
            z-index: 20; 
            height: 45%; /* Default Height (approx 1/2) */
            transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }
        .order-panel.minimized { height: 50px; overflow: hidden; } /* Small strip */

        /* Panel Header (Toggle) */
        .panel-header-bar {
            height: 40px; background: #252525; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; flex-shrink: 0;
        }
        .toggle-icon { font-size: 20px; color: #aaa; transition: transform 0.3s; }
        .order-panel.minimized .toggle-icon { transform: rotate(180deg); }

        .panel-content { padding: 10px; display: flex; flex-direction: column; flex: 1; height: 100%; overflow: hidden; }

        .address-bar { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .btn-edit { background: none; border: 1px solid #555; color: #FFD700; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        textarea.order-text { flex: 1; width: 100%; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; font-size: 16px; resize: none; margin-bottom: 8px; transition: border-color 0.2s, background-color 0.2s; }
        textarea.order-text.flash { border-color: #00E676; background-color: #2a2a2a; }
        
        .btn-send { width: 100%; padding: 15px; background: #FFD700; color: black; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; flex-shrink: 0; }
        .btn-send:disabled { background: #555; color: #aaa; cursor: not-allowed; }

        #liveTotal { text-align: right; color: #00E676; font-size: 20px; font-weight: bold; margin-bottom: 10px; flex-shrink: 0; }

        /* USER EXTRAS MODAL */
        .extras-grid { display: flex; flex-wrap: wrap; gap: 8px; max-height: 300px; overflow-y: auto; margin: 15px 0; }
        .extra-option { 
            background: #333; border: 1px solid #555; padding: 10px; border-radius: 6px; 
            color: white; font-size: 14px; cursor: pointer; user-select: none; flex: 1 1 45%; 
            display: flex; justify-content: space-between;
        }
        .extra-option.selected { background: #00E676; color: black; border-color: #00E676; font-weight: bold; }
        
        /* STATUS OVERLAY */
        #statusOverlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 0; background: rgba(0,0,0,0.95); transition: height 0.3s; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; }
        .status-content { text-align: center; width: 80%; display: flex; flex-direction: column; align-items: center; }
        .status-icon { font-size: 70px; margin-bottom: 20px; animation: pulse 1.5s infinite; }
        .status-text { font-size: 24px; font-weight: bold; color: white; margin-bottom: 10px; }
        .status-sub { font-size: 15px; color: #aaa; }
        .btn-new-order { margin-top: 20px; padding: 12px 25px; background: #00E676; color: black; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; display: none; box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4); width: 100%; }
        .btn-minimize { margin-top: 15px; background: transparent; border: 1px solid #555; color: #aaa; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        .store-closed-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .closed-text { font-size: 30px; color: #D32F2F; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h1 style="color:#FFD700;">BellGo Delivery ğŸ›µ</h1>
        <p style="color:#aaa;">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ¯Î»ÎµÏ„Îµ</p>
        <button class="btn-google" onclick="App.loginGoogle()">
            <span>G</span> Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google
        </button>
        <button id="btnInstallLogin" class="btn-install-app" onclick="App.installPWA()">ğŸ“² Î•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— APP</button>
    </div>

    <div id="detailsOverlay" class="overlay-screen">
        <div class="details-box">
            <h3 style="color:#FFD700; margin:0;">ğŸ“ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚</h3>
            <input type="text" id="inpName" class="inp-detail" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ±Ï‚">
            <input type="text" id="inpAddress" class="inp-detail" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· (Ï€.Ï‡. Î•ÏÎ¼Î¿Ï 15)">
            <input type="text" id="inpFloor" class="inp-detail" placeholder="ÎŒÏÎ¿Ï†Î¿Ï‚ / ÎšÎ¿Ï…Î´Î¿ÏÎ½Î¹">
            <input type="tel" id="inpPhone" class="inp-detail" placeholder="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿ Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚">
            <button class="btn-save-details" onclick="App.saveDetails()">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î— & Î£Î¥ÎÎ•Î§Î•Î™Î‘</button>
        </div>
    </div>

    <div id="paymentOverlay" class="overlay-screen">
        <div class="details-box">
            <h3 style="color:#FFD700;">Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</h3>
            <button class="btn-pay" id="payCash" onclick="App.confirmPayment('ğŸ’µ ÎœÎ•Î¤Î¡Î—Î¤Î‘')">ğŸ’µ ÎœÎ•Î¤Î¡Î—Î¤Î‘</button>
            <button class="btn-pay" id="payCard" onclick="App.confirmPayment('ğŸ’³ ÎšÎ‘Î¡Î¤Î‘')">ğŸ’³ ÎšÎ‘Î¡Î¤Î‘</button>
            <button onclick="document.getElementById('paymentOverlay').style.display='none'" style="background:transparent; border:none; color:#aaa; margin-top:15px; font-size:14px; cursor:pointer;">Î‘ÎšÎ¥Î¡Î©Î£Î—</button>
        </div>
    </div>
    
    <div id="closedOverlay" class="store-closed-overlay">
        <div class="closed-text">ğŸ”´ ÎšÎ›Î•Î™Î£Î¤ÎŸ</div>
        <p style="color:#aaa;">Î¤Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± Î´ÎµÎ½ Î´Î­Ï‡ÎµÏ„Î±Î¹ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®.</p>
    </div>

    <div id="userExtrasModal" class="overlay-screen">
        <div class="details-box">
            <h3 style="color:#FFD700; margin:0;" id="userExtrasTitle">Î•Ï€Î¹Î»Î¿Î³Î­Ï‚</h3>
            <div id="userExtrasList" class="extras-grid"></div>
            <button class="btn-save-details" onclick="App.confirmExtras()">Î Î¡ÎŸÎ£Î˜Î—ÎšÎ—</button>
            <button onclick="document.getElementById('userExtrasModal').style.display='none'" style="background:transparent; border:none; color:#aaa; margin-top:10px; cursor:pointer;">Î‘ÎšÎ¥Î¡Î©Î£Î—</button>
        </div>
    </div>

    <div id="appContent">
        <div class="header">
            <div class="store-info">
                <span id="storeNameHeader" style="font-weight:bold; font-size:16px; color:#FFD700;">...</span>
                <small style="color:#aaa; font-size:10px;">Delivery App</small>
            </div>
            <div class="header-actions">
                <button id="btnInstallHeader" class="btn-header-install" onclick="App.installPWA()">ğŸ“² APP</button>
                <button class="btn-logout" onclick="App.logout()">EXIT</button>
            </div>
        </div>

        <div id="menuContainer">
            <div style="text-align:center; color:#555; margin-top:50px;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎºÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…...</div>
        </div>

        <div id="orderPanel" class="order-panel">
            <div class="panel-header-bar" onclick="App.toggleOrderPanel()">
                <div style="font-size:12px; color:#aaa; margin-right:10px;">ÎšÎ‘Î›Î‘Î˜Î™ / Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î—</div>
                <div id="panelIcon" class="toggle-icon">â–¼</div>
            </div>
            <div class="panel-content">
                <div class="address-bar">
                    <span id="displayAddress">...</span>
                    <button class="btn-edit" onclick="App.editDetails()">âœï¸ Î‘Î»Î»Î±Î³Î®</button>
                </div>
                
                <textarea id="orderText" class="order-text" 
                    placeholder="Î“ÏÎ¬ÏˆÏ„Îµ ÎµÎ´Ï...&#10;(âš ï¸ Î“Î¹Î± Ï€Î»Î·ÏÏ‰Î¼Î® Î¼Îµ ÎšÎ‘Î¡Î¤Î‘, ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÎ±Ï„Î¬Î»Î¿Î³Î¿!)" 
                    oninput="App.handleInput()">
                </textarea>
                
                <div id="liveTotal">Î£Î¥ÎÎŸÎ›ÎŸ: 0.00â‚¬</div>

                <button id="btnSendOrder" class="btn-send" onclick="App.requestPayment()">Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘Î£ ğŸš€</button>
            </div>
        </div>

        <div id="statusOverlay">
            <div class="status-content">
                <div id="statusIcon" class="status-icon">â³</div>
                <div id="statusText" class="status-text">Î‘Î½Î±Î¼Î¿Î½Î®...</div>
                <div id="statusSub" class="status-sub">ÎœÎ·Î½ ÎºÎ»ÎµÎ¯Î½ÎµÏ„Îµ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®</div>
                <button id="btnNewOrder" class="btn-new-order" onclick="App.resetForNewOrder()">â• ÎÎ•Î‘ Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘</button>
                <button class="btn-minimize" onclick="App.minimizeStatus()">â–¼ Î Î™Î£Î© Î£Î¤ÎŸ ÎœÎ•ÎÎŸÎ¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(err => console.log('âŒ SW Error:', err));
        }

        // --- INSTALL LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btnLogin = document.getElementById('btnInstallLogin');
            if(btnLogin) btnLogin.style.display = 'block';
            const btnHeader = document.getElementById('btnInstallHeader');
            if(btnHeader) btnHeader.style.display = 'block';
        });

        const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        if (isIos() && !window.navigator.standalone) {
             document.getElementById('btnInstallLogin').style.display = 'block';
             document.getElementById('btnInstallHeader').style.display = 'block';
        }

        const firebaseConfig = { 
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
            authDomain: "bellgo-5dbe5.firebaseapp.com", 
            projectId: "bellgo-5dbe5", 
            storageBucket: "bellgo-5dbe5.firebasestorage.app", 
            messagingSenderId: "799314495253", 
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const messaging = getMessaging(app);

        const params = new URLSearchParams(window.location.search);
        let TARGET_STORE = params.get('store');
        if (!TARGET_STORE) {
            const pathParts = window.location.pathname.split('/');
            const shopIndex = pathParts.indexOf('shop');
            if (shopIndex !== -1 && pathParts[shopIndex + 1]) { TARGET_STORE = pathParts[shopIndex + 1]; }
        }
        const PRELOADED_NAME = params.get('name'); 

        let currentUser = null;
        let customerDetails = JSON.parse(localStorage.getItem('bellgo_customer_info') || 'null');
        let activeOrderState = JSON.parse(localStorage.getItem('bellgo_active_order') || 'null');
        const ORDER_TIMEOUT_MS = 60 * 60 * 1000; 

        window.App = {
            // ... (Install, Login, Logout remain same)
            installPWA: async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') { document.getElementById('btnInstallLogin').style.display = 'none'; document.getElementById('btnInstallHeader').style.display = 'none'; } deferredPrompt = null; } else if (isIos()) { alert("Î“Î¹Î± ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÏƒÎµ iPhone:\n1. Î Î±Ï„Î®ÏƒÏ„Îµ Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ 'Share' (ÎºÎ¬Ï„Ï‰)\n2. Î•Ï€Î¹Î»Î­Î¾Ï„Îµ 'Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î·Î½ ÎŸÎ¸ÏŒÎ½Î· Î‘Ï†ÎµÏ„Î·ÏÎ¯Î±Ï‚'"); } },
            loginGoogle: () => { signInWithPopup(auth, provider).catch(e => alert("Login Error: " + e.message)); },
            logout: () => { signOut(auth).then(() => location.reload()); },

            checkDetails: () => {
                document.getElementById('loginScreen').style.display = 'none';
                if (!customerDetails) {
                    document.getElementById('detailsOverlay').style.display = 'flex';
                    if (currentUser && currentUser.displayName) { document.getElementById('inpName').value = currentUser.displayName; }
                } else { App.startApp(); }
            },

            saveDetails: () => {
                const name = document.getElementById('inpName').value.trim();
                const address = document.getElementById('inpAddress').value.trim();
                const floor = document.getElementById('inpFloor').value.trim();
                const phone = document.getElementById('inpPhone').value.trim();
                if (!name || !address || !phone) return alert("Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Î²Î±ÏƒÎ¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±!");
                customerDetails = { name, address, floor, phone };
                localStorage.setItem('bellgo_customer_info', JSON.stringify(customerDetails));
                document.getElementById('detailsOverlay').style.display = 'none';
                App.startApp();
            },
            editDetails: () => { document.getElementById('appContent').style.display = 'none'; document.getElementById('detailsOverlay').style.display = 'flex'; document.getElementById('inpName').value = customerDetails.name; document.getElementById('inpAddress').value = customerDetails.address; document.getElementById('inpFloor').value = customerDetails.floor; document.getElementById('inpPhone').value = customerDetails.phone; },

            startApp: () => {
                document.getElementById('appContent').style.display = 'flex';
                document.body.addEventListener('click', () => { const audio = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"); audio.play().catch(()=>{}); }, { once: true });

                if (PRELOADED_NAME) {
                    const cleanName = decodeURIComponent(PRELOADED_NAME);
                    document.getElementById('storeNameHeader').innerText = cleanName;
                    document.title = cleanName;
                    let maniUrl = `manifest.json?name=${PRELOADED_NAME}&icon=shop`;
                    if (TARGET_STORE) maniUrl += `&store=${TARGET_STORE}`;
                    document.getElementById('dynamicManifest').setAttribute('href', maniUrl);
                } else if(TARGET_STORE) { document.getElementById('storeNameHeader').innerText = TARGET_STORE.split('@')[0].toUpperCase(); }
                
                document.getElementById('displayAddress').innerText = `ğŸ“ ${customerDetails.address}, ${customerDetails.floor}`;
                App.checkActiveOrderStorage();
                App.connectSocket();
                App.requestNotifyPermission(); 
            },

            requestNotifyPermission: async () => {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === "granted") {
                        const registration = await navigator.serviceWorker.ready;
                        const token = await getToken(messaging, { vapidKey: "BDUWH0UaYagUPXGB8BM59VFRBW8FMbgOy7YcbBHxT4aJ6rN0Jms-0dGWXIODGYWoSSHomos4gg1GOTZn6k70JcM", serviceWorkerRegistration: registration }); 
                        if (token) {
                            localStorage.setItem('fcm_token', token);
                            if(window.socket && window.socket.connected) { window.socket.emit('join-store', { storeName: TARGET_STORE, username: customerDetails.name + " (Î ÎµÎ»Î¬Ï„Î·Ï‚)", role: 'customer', token: token, isNative: false }); }
                        }
                    }
                } catch (error) { console.error("Notification Error:", error); }
            },

            checkActiveOrderStorage: () => {
                if (activeOrderState) {
                    const now = Date.now();
                    if (activeOrderState.status === 'ready' && (now - activeOrderState.timestamp > ORDER_TIMEOUT_MS)) {
                        localStorage.removeItem('bellgo_active_order');
                        activeOrderState = null;
                        App.resetUI();
                    } else { App.updateStatusUI(activeOrderState.status); }
                }
            },

            // --- STRIPE RETURN HANDLER ---
            checkStripeReturn: () => {
                const urlP = new URLSearchParams(window.location.search);
                const status = urlP.get('payment_status');
                if (status === 'success') {
                    const saved = localStorage.getItem('bellgo_temp_card_order');
                    if (saved) {
                        const orderData = JSON.parse(saved);
                        App.sendOrder(orderData.items, 'ğŸ’³ ÎšÎ‘Î¡Î¤Î‘ [Î Î›Î—Î¡Î©Î˜Î—ÎšÎ• âœ…]');
                        localStorage.removeItem('bellgo_temp_card_order');
                        const cleanUrl = window.location.pathname + window.location.search.replace(/[?&]payment_status=[^&]+/, '');
                        window.history.replaceState({}, document.title, cleanUrl);
                    }
                } else if (status === 'cancel') { alert("Î— Ï€Î»Î·ÏÏ‰Î¼Î® Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎµ."); }
            },

            connectSocket: () => {
                if (window.socket && window.socket.connected) return;
                window.socket = io({ transports: ['polling', 'websocket'], reconnection: true });
                const socket = window.socket;

                socket.on('connect', () => {
                    socket.emit('join-store', { storeName: TARGET_STORE, username: customerDetails.name + " (Î ÎµÎ»Î¬Ï„Î·Ï‚)", role: 'customer', token: localStorage.getItem('fcm_token'), isNative: false });
                    setTimeout(() => { App.checkStripeReturn(); }, 1000);
                });

                socket.on('menu-update', (data) => { App.renderMenu(data); });

                socket.on('store-settings-update', (settings) => {
                    if (settings) {
                        if (settings.name) {
                            const newName = settings.name;
                            document.getElementById('storeNameHeader').innerText = newName;
                            document.title = newName;
                            if (!new URLSearchParams(window.location.search).get('name')) {
                                const currentParams = new URLSearchParams(window.location.search);
                                currentParams.set('name', newName);
                                window.history.replaceState({}, '', `${window.location.pathname}?${currentParams.toString()}`);
                            }
                        }
                        const closedOverlay = document.getElementById('closedOverlay');
                        const btnSend = document.getElementById('btnSendOrder');
                        if (settings.statusCustomer === false) {
                            closedOverlay.style.display = 'flex';
                            if(btnSend) { btnSend.disabled = true; btnSend.innerText = "â›” Î¤ÎŸ ÎšÎ‘Î¤Î‘Î£Î¤Î—ÎœÎ‘ Î•Î™ÎÎ‘Î™ ÎšÎ›Î•Î™Î£Î¤ÎŸ"; }
                        } else {
                            closedOverlay.style.display = 'none';
                            if(btnSend) { btnSend.disabled = false; btnSend.innerText = "Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘Î£ ğŸš€"; }
                        }
                    }
                });

                socket.on('orders-update', (orders) => {
                    const mySocketUsername = customerDetails.name + " (Î ÎµÎ»Î¬Ï„Î·Ï‚)";
                    const myOrder = orders.find(o => o.from === mySocketUsername);
                    if (myOrder) {
                        if (!activeOrderState || activeOrderState.status !== myOrder.status) {
                            activeOrderState = { id: myOrder.id, status: myOrder.status, timestamp: Date.now() };
                            localStorage.setItem('bellgo_active_order', JSON.stringify(activeOrderState));
                            App.updateStatusUI(myOrder.status);
                        }
                    }
                });
            },

            // --- NEW RENDER MENU WITH EXTRAS ---
            renderMenu: (data) => {
                const container = document.getElementById('menuContainer');
                container.innerHTML = '';
                let menu = [];
                try {
                    if(typeof data === 'string' && data.startsWith('[')) { menu = JSON.parse(data); } 
                    else if (typeof data === 'object') { menu = data; } 
                    else { const items = (data || "").split('\n'); menu = [{ name: "ÎšÎ‘Î¤Î‘Î›ÎŸÎ“ÎŸÎ£", items: items }]; }
                } catch(e) { menu = []; }

                if(Array.isArray(menu)) {
                    menu.sort((a,b) => (a.order || 99) - (b.order || 99));
                    menu.forEach(cat => {
                        const title = document.createElement('div');
                        title.className = 'category-title';
                        title.innerText = cat.name;
                        const itemsDiv = document.createElement('div');
                        itemsDiv.className = 'category-items';

                        cat.items.forEach(item => {
                            // Support old string items and new object items
                            let itemName = "", itemPrice = 0, itemExtras = [];
                            if (typeof item === 'string') {
                                const parts = item.split(':');
                                itemName = parts[0].trim();
                                if(parts.length > 1) itemPrice = parseFloat(parts[parts.length-1]) || 0;
                            } else {
                                itemName = item.name;
                                itemPrice = item.price;
                                itemExtras = item.extras || [];
                            }

                            if(itemName) {
                                const box = document.createElement('div');
                                box.className = 'item-box';
                                box.innerHTML = `<span class="item-name">${itemName}</span>${itemPrice > 0 ? `<span class="item-price">${itemPrice}â‚¬</span>` : ''}`;
                                
                                box.onclick = () => { App.handleItemClick(itemName, itemPrice, itemExtras); };
                                itemsDiv.appendChild(box);
                            }
                        });
                        const wrapper = document.createElement('div');
                        wrapper.className = 'category-block';
                        wrapper.appendChild(title);
                        wrapper.appendChild(itemsDiv);
                        container.appendChild(wrapper);
                    });
                }
            },

            // --- EXTRAS LOGIC ---
            currentItem: null,
            tempSelectedExtras: [],

            handleItemClick: (name, price, extras) => {
                if (!extras || extras.length === 0) {
                    // No extras, add directly
                    App.addToOrder(name, price);
                } else {
                    // Open Modal
                    App.currentItem = { name, price };
                    App.tempSelectedExtras = [];
                    const list = document.getElementById('userExtrasList');
                    list.innerHTML = '';
                    
                    document.getElementById('userExtrasTitle').innerText = name;
                    
                    extras.forEach((ex, idx) => {
                        const btn = document.createElement('div');
                        btn.className = 'extra-option';
                        btn.innerHTML = `<span>${ex.name}</span><span>${ex.price > 0 ? `+${ex.price}â‚¬` : ''}</span>`;
                        btn.onclick = () => {
                            // Toggle Selection
                            if (btn.classList.contains('selected')) {
                                btn.classList.remove('selected');
                                App.tempSelectedExtras = App.tempSelectedExtras.filter(e => e.name !== ex.name);
                            } else {
                                btn.classList.add('selected');
                                App.tempSelectedExtras.push(ex);
                            }
                        };
                        list.appendChild(btn);
                    });
                    document.getElementById('userExtrasModal').style.display = 'flex';
                }
            },

            confirmExtras: () => {
                if (!App.currentItem) return;
                let finalText = App.currentItem.name;
                let totalPrice = App.currentItem.price;
                
                // Construct String: "Freddo:2.5 +Meli:0.5 +Gala:0"
                // Actually server calculates total by summing items with :PRICE.
                // So we append extras as items with "+ " prefix
                
                App.addToOrder(App.currentItem.name, App.currentItem.price);
                
                App.tempSelectedExtras.forEach(ex => {
                     App.addToOrder(`  + ${ex.name}`, ex.price);
                });

                document.getElementById('userExtrasModal').style.display = 'none';
            },

            addToOrder: (name, price) => {
                const txt = document.getElementById('orderText');
                const entry = price > 0 ? `${name}:${price}` : name;
                
                if (txt.value.trim() === '') txt.value = `1 ${entry}`;
                else txt.value += `\n1 ${entry}`;
                
                txt.scrollTop = txt.scrollHeight;
                App.handleInput(); 
                
                // If adding via modal, make sure bar is visible
                const panel = document.getElementById('orderPanel');
                if (panel.classList.contains('minimized')) {
                    App.toggleOrderPanel();
                }
            },

            // --- TOGGLE ORDER PANEL ---
            toggleOrderPanel: () => {
                const p = document.getElementById('orderPanel');
                const icon = document.getElementById('panelIcon');
                if(p.classList.contains('minimized')) {
                    p.classList.remove('minimized');
                    icon.style.transform = 'rotate(0deg)';
                } else {
                    p.classList.add('minimized');
                    icon.style.transform = 'rotate(180deg)';
                }
            },

            handleInput: () => {
                const text = document.getElementById('orderText').value.trim();
                const lines = text.split('\n');
                let validForCard = true;
                let total = 0;
                if (text.length === 0) validForCard = false;

                for (const line of lines) {
                    if (!line.trim()) continue;
                    let qty = 1; let rest = line;
                    const qtyMatch = line.match(/^(\d+)\s+(.*)/);
                    if(qtyMatch) { qty = parseInt(qtyMatch[1]); rest = qtyMatch[2]; }

                    if(rest.includes(':')) {
                        const parts = rest.split(':');
                        const priceVal = parseFloat(parts[parts.length-1]);
                        if(!isNaN(priceVal)) { total += qty * priceVal; } 
                        else { validForCard = false; }
                    } else if (line.trim().startsWith('+')) {
                         // Extra item (might have price)
                    } else { 
                        // Item without price
                         validForCard = false; 
                    }
                }
                document.getElementById('liveTotal').innerText = `Î£Î¥ÎÎŸÎ›ÎŸ: ${total.toFixed(2)}â‚¬`;
                const btnCard = document.getElementById('payCard');
                if (validForCard && total > 0) {
                    btnCard.disabled = false;
                    btnCard.innerHTML = "ğŸ’³ ÎšÎ‘Î¡Î¤Î‘";
                } else {
                    btnCard.disabled = true;
                    btnCard.innerHTML = "ğŸ’³ ÎšÎ‘Î¡Î¤Î‘ (ÎœÎ· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î·)";
                }
                return total;
            },

            requestPayment: () => {
                const items = document.getElementById('orderText').value.trim();
                if (!items) return alert("Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿!");
                App.handleInput();
                document.getElementById('paymentOverlay').style.display = 'flex';
            },

            confirmPayment: (method) => {
                const items = document.getElementById('orderText').value.trim();
                if(method === 'ğŸ’³ ÎšÎ‘Î¡Î¤Î‘') {
                    App.payWithCard(items);
                } else {
                    App.sendOrder(items, method);
                    document.getElementById('paymentOverlay').style.display = 'none';
                }
            },

            payWithCard: async (items) => {
                const totalAmount = App.handleInput();
                if(totalAmount <= 0) return alert("Î£Ï†Î¬Î»Î¼Î± Ï€Î¿ÏƒÎ¿Ï.");
                localStorage.setItem('bellgo_temp_card_order', JSON.stringify({ items: items, amount: totalAmount }));
                try {
                    const res = await fetch('/create-order-payment', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ amount: totalAmount, storeName: TARGET_STORE })
                    });
                    const data = await res.json();
                    if(data.url) { window.location.href = data.url; } 
                    else { alert("Î£Ï†Î¬Î»Î¼Î± Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚: " + (data.error || "Î†Î³Î½Ï‰ÏƒÏ„Î¿")); }
                } catch(e) { alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ Server."); }
            },

            sendOrder: (items, method) => {
                const fullText = `[DELIVERY ğŸ›µ]\nğŸ‘¤ ${customerDetails.name}\nğŸ“ ${customerDetails.address}\nğŸ¢ ${customerDetails.floor}\nğŸ“ ${customerDetails.phone}\n${method}\n---\n${items}`;
                activeOrderState = { id: Date.now(), status: 'pending', timestamp: Date.now() };
                localStorage.setItem('bellgo_active_order', JSON.stringify(activeOrderState));
                window.socket.emit('new-order', fullText);
                App.showStatus('pending'); // âœ… Wait for Admin (Cooking)
                document.getElementById('orderText').value = ''; 
                document.getElementById('liveTotal').innerText = "Î£Î¥ÎÎŸÎ›ÎŸ: 0.00â‚¬";
            },

            minimizeStatus: () => { document.getElementById('statusOverlay').style.height = '0'; },

            showStatus: (status) => {
                const overlay = document.getElementById('statusOverlay');
                const icon = document.getElementById('statusIcon');
                const text = document.getElementById('statusText');
                const sub = document.getElementById('statusSub');
                const btnNew = document.getElementById('btnNewOrder');

                overlay.style.height = '100%'; 
                btnNew.style.display = 'none'; 

                let timeString = "";
                if (activeOrderState && activeOrderState.timestamp) {
                    const date = new Date(activeOrderState.timestamp);
                    timeString = date.toLocaleTimeString('el-GR', {hour: '2-digit', minute:'2-digit'});
                }

                if (status === 'pending') {
                    icon.innerText = 'â³'; text.innerText = 'Î£Ï„Î¬Î»Î¸Î·ÎºÎµ! Î‘Î½Î±Î¼Î¿Î½Î®...'; sub.innerText = 'Î¤Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±';
                } else if (status === 'cooking') {
                    icon.innerText = 'ğŸ‘¨â€ğŸ³'; text.innerText = 'Î•Ï„Î¿Î¹Î¼Î¬Î¶ÎµÏ„Î±Î¹!'; sub.innerText = 'Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î­Î³Î¹Î½Îµ Î±Ï€Î¿Î´ÎµÎºÏ„Î®';
                } else if (status === 'ready') {
                    icon.innerText = 'ğŸ›µ'; text.innerText = `Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± (${timeString}) Î­ÏÏ‡ÎµÏ„Î±Î¹!`; sub.innerText = 'ÎŸ Î´Î¹Î±Î½Î¿Î¼Î­Î±Ï‚ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ';
                    btnNew.style.display = 'block'; 
                }
            },

            updateStatusUI: (status) => { App.showStatus(status); },

            resetForNewOrder: () => {
                if(confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Î½Î­Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±;")) {
                    localStorage.removeItem('bellgo_active_order');
                    activeOrderState = null;
                    document.getElementById('statusOverlay').style.height = '0';
                    document.getElementById('orderText').value = '';
                }
            },

            resetUI: () => { document.getElementById('statusOverlay').style.height = '0'; }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUser = user; App.checkDetails(); } 
            else { document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('appContent').style.display = 'none'; }
        });
    </script>
</body>
</html>
