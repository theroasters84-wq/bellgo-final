<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Delivery</title>
    <link rel="manifest" href="manifest.json">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        .header { height: 60px; background: #1e1e1e; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333; flex-shrink: 0; }
        .store-info { display: flex; flex-direction: column; }
        .btn-logout { background: #D32F2F; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }

        /* LOGIN SCREEN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .btn-google { background: #DB4437; color: white; border: none; padding: 15px 25px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-top: 20px; box-shadow: 0 4px 15px rgba(219,68,55,0.4); }

        /* DETAILS FORM OVERLAY */
        #detailsOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .details-box { background: #222; padding: 20px; border-radius: 10px; border: 1px solid #444; width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .inp-detail { padding: 12px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; font-size: 16px; }
        .btn-save-details { padding: 12px; background: #00E676; color: black; border: none; border-radius: 5px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }

        /* MAIN CONTENT */
        #appContent { display: none; flex-direction: column; height: 100%; width: 100%; }

        /* MENU AREA */
        #menuContainer {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #121212;
        }
        .category-title { color: #FFD700; font-weight: bold; font-size: 16px; margin: 15px 0 5px 0; border-bottom: 1px solid #333; padding-bottom: 5px; text-transform: uppercase; }
        .category-items { display: flex; flex-wrap: wrap; gap: 8px; }
        .item-box { background: #222; border: 1px solid #444; padding: 12px 15px; border-radius: 8px; color: #eee; font-size: 15px; font-style: italic; cursor: pointer; transition: transform 0.1s; }
        .item-box:active { transform: scale(0.95); background: #333; border-color: #FFD700; }

        /* ORDER AREA (BOTTOM) */
        .order-panel { height: 35%; background: #1a1a1a; border-top: 2px solid #333; display: flex; flex-direction: column; padding: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        
        .address-bar { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .btn-edit { background: none; border: 1px solid #555; color: #FFD700; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        textarea.order-text { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; font-size: 16px; resize: none; margin-bottom: 8px; }
        
        .btn-send { width: 100%; padding: 15px; background: #FFD700; color: black; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* STATUS BAR OVERLAY */
        #statusOverlay { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0; 
            background: rgba(0,0,0,0.9); transition: height 0.3s; 
            overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; 
        }
        .status-content { text-align: center; }
        .status-icon { font-size: 50px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .status-text { font-size: 20px; font-weight: bold; color: white; }
        .status-sub { font-size: 14px; color: #aaa; margin-top: 5px; }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h1 style="color:#FFD700;">BellGo Delivery ğŸ›µ</h1>
        <p style="color:#aaa;">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ¯Î»ÎµÏ„Îµ</p>
        <button class="btn-google" onclick="App.loginGoogle()">
            <span>G</span> Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google
        </button>
    </div>

    <div id="detailsOverlay">
        <div class="details-box">
            <h3 style="color:#FFD700; text-align:center; margin:0;">ğŸ“ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚</h3>
            <input type="text" id="inpName" class="inp-detail" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ±Ï‚">
            <input type="text" id="inpAddress" class="inp-detail" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· (Ï€.Ï‡. Î•ÏÎ¼Î¿Ï 15)">
            <input type="text" id="inpFloor" class="inp-detail" placeholder="ÎŒÏÎ¿Ï†Î¿Ï‚ / ÎšÎ¿Ï…Î´Î¿ÏÎ½Î¹">
            <input type="tel" id="inpPhone" class="inp-detail" placeholder="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿ Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚">
            <button class="btn-save-details" onclick="App.saveDetails()">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î— & Î£Î¥ÎÎ•Î§Î•Î™Î‘</button>
        </div>
    </div>

    <div id="appContent">
        <div class="header">
            <div class="store-info">
                <span id="storeNameHeader" style="font-weight:bold; font-size:16px; color:#FFD700;">...</span>
                <small style="color:#aaa; font-size:10px;">Delivery App</small>
            </div>
            <button class="btn-logout" onclick="App.logout()">EXIT</button>
        </div>

        <div id="menuContainer">
            <div style="text-align:center; color:#555; margin-top:50px;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎºÎ±Ï„Î±Î»ÏŒÎ³Î¿Ï…...</div>
        </div>

        <div class="order-panel">
            <div class="address-bar">
                <span id="displayAddress">...</span>
                <button class="btn-edit" onclick="App.editDetails()">âœï¸ Î‘Î»Î»Î±Î³Î®</button>
            </div>
            <textarea id="orderText" class="order-text" placeholder="Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÎ±Ï‚..."></textarea>
            <button class="btn-send" onclick="App.sendOrder()">Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘Î£ ğŸš€</button>
        </div>

        <div id="statusOverlay">
            <div class="status-content">
                <div id="statusIcon" class="status-icon">â³</div>
                <div id="statusText" class="status-text">Î‘Î½Î±Î¼Î¿Î½Î® ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·Ï‚...</div>
                <div id="statusSub" class="status-sub">ÎœÎ·Î½ ÎºÎ»ÎµÎ¯Î½ÎµÏ„Îµ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        // Firebase Config
        const firebaseConfig = { 
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
            authDomain: "bellgo-5dbe5.firebaseapp.com", 
            projectId: "bellgo-5dbe5", 
            storageBucket: "bellgo-5dbe5.firebasestorage.app", 
            messagingSenderId: "799314495253", 
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const messaging = getMessaging(app);

        // Get Store from URL
        const params = new URLSearchParams(window.location.search);
        const TARGET_STORE = params.get('store'); // e.g. ?store=admin@gmail.com

        if (!TARGET_STORE) {
            alert("âš ï¸ Î›Î¬Î¸Î¿Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚!");
            document.body.innerHTML = "<h2 style='text-align:center; padding:20px;'>Store Not Found</h2>";
        }

        let currentUser = null;
        let customerDetails = JSON.parse(localStorage.getItem('bellgo_customer_info') || 'null');
        let currentOrderId = null;

        window.App = {
            loginGoogle: () => {
                signInWithPopup(auth, provider).catch(e => alert("Login Error: " + e.message));
            },

            logout: () => {
                signOut(auth).then(() => location.reload());
            },

            checkDetails: () => {
                if (!customerDetails) {
                    // Show form
                    document.getElementById('detailsOverlay').style.display = 'flex';
                    if (currentUser) {
                        document.getElementById('inpName').value = currentUser.displayName;
                    }
                } else {
                    App.startApp();
                }
            },

            saveDetails: () => {
                const name = document.getElementById('inpName').value.trim();
                const address = document.getElementById('inpAddress').value.trim();
                const floor = document.getElementById('inpFloor').value.trim();
                const phone = document.getElementById('inpPhone').value.trim();

                if (!name || !address || !phone) return alert("Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Î²Î±ÏƒÎ¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±!");

                customerDetails = { name, address, floor, phone };
                localStorage.setItem('bellgo_customer_info', JSON.stringify(customerDetails));
                document.getElementById('detailsOverlay').style.display = 'none';
                App.startApp();
            },

            editDetails: () => {
                document.getElementById('detailsOverlay').style.display = 'flex';
                document.getElementById('inpName').value = customerDetails.name;
                document.getElementById('inpAddress').value = customerDetails.address;
                document.getElementById('inpFloor').value = customerDetails.floor;
                document.getElementById('inpPhone').value = customerDetails.phone;
            },

            startApp: () => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContent').style.display = 'flex';
                document.getElementById('storeNameHeader').innerText = TARGET_STORE.split('@')[0].toUpperCase();
                
                // Update Address Bar
                document.getElementById('displayAddress').innerText = `ğŸ“ ${customerDetails.address}, ${customerDetails.floor}`;

                App.connectSocket();
            },

            connectSocket: () => {
                if (window.socket && window.socket.connected) return;
                window.socket = io({ transports: ['polling', 'websocket'], reconnection: true });
                const socket = window.socket;

                socket.on('connect', () => {
                    // Join as Customer
                    socket.emit('join-store', { 
                        storeName: TARGET_STORE, 
                        username: customerDetails.name + " (Î ÎµÎ»Î¬Ï„Î·Ï‚)", 
                        role: 'customer', 
                        isNative: false 
                    });
                });

                // Receive Menu
                socket.on('menu-update', (data) => {
                    App.renderMenu(data);
                });

                // Listen for my order status updates
                socket.on('orders-update', (orders) => {
                    if (!currentOrderId) return;
                    
                    const myOrder = orders.find(o => o.id === currentOrderId);
                    if (myOrder) {
                        App.updateStatusUI(myOrder.status);
                    } else {
                        // If order disappeared (closed by admin)
                        if (document.getElementById('statusOverlay').style.height === '100%') {
                            alert("Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ!");
                            App.resetUI();
                        }
                    }
                });
            },

            renderMenu: (data) => {
                const container = document.getElementById('menuContainer');
                container.innerHTML = '';

                let menu = [];
                try {
                    if(typeof data === 'string' && data.startsWith('[')) {
                        menu = JSON.parse(data);
                    } else if (typeof data === 'object') {
                        menu = data;
                    } else {
                        const items = (data || "").split('\n');
                        menu = [{ name: "ÎšÎ‘Î¤Î‘Î›ÎŸÎ“ÎŸÎ£", items: items }];
                    }
                } catch(e) { menu = []; }

                if(Array.isArray(menu)) {
                    menu.sort((a,b) => (a.order || 99) - (b.order || 99));
                    menu.forEach(cat => {
                        const title = document.createElement('div');
                        title.className = 'category-title';
                        title.innerText = cat.name;
                        
                        const itemsDiv = document.createElement('div');
                        itemsDiv.className = 'category-items';

                        cat.items.forEach(item => {
                            if(item && item.trim()) {
                                const box = document.createElement('div');
                                box.className = 'item-box';
                                box.innerText = item.trim();
                                // Prevent keyboard hide on tap
                                const handleAdd = (e) => {
                                    if (e.cancelable) e.preventDefault(); 
                                    App.addToOrder(item.trim());
                                };
                                box.addEventListener('mousedown', handleAdd);
                                box.addEventListener('touchstart', handleAdd);
                                itemsDiv.appendChild(box);
                            }
                        });

                        const wrapper = document.createElement('div');
                        wrapper.appendChild(title);
                        wrapper.appendChild(itemsDiv);
                        container.appendChild(wrapper);
                    });
                }
            },

            addToOrder: (item) => {
                const txt = document.getElementById('orderText');
                let lines = txt.value.split('\n').filter(l => l.trim() !== '');
                let found = false;

                // Smart Qty
                for (let i = 0; i < lines.length; i++) {
                    let regex = new RegExp(`^(\\d+)?\\s*${item.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}$`);
                    let match = lines[i].match(regex);
                    if (match) {
                        let currentQty = parseInt(match[1] || '1');
                        lines[i] = `${currentQty + 1} ${item}`;
                        found = true;
                        break;
                    }
                }
                if (!found) lines.push(item);
                txt.value = lines.join('\n');
                txt.scrollTop = txt.scrollHeight;
            },

            sendOrder: () => {
                const items = document.getElementById('orderText').value.trim();
                if (!items) return alert("Î¤Î¿ ÎºÎ±Î»Î¬Î¸Î¹ ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î¿!");

                // Construct full order text for Admin
                const fullText = `[DELIVERY ğŸ›µ]\nğŸ‘¤ ${customerDetails.name}\nğŸ“ ${customerDetails.address}\nğŸ¢ ${customerDetails.floor}\nğŸ“ ${customerDetails.phone}\n---\n${items}`;

                // Set ID to track status
                currentOrderId = Date.now(); // Using timestamp logic same as socket sender
                
                // Emitting the order manually to match server expectations
                // We need to patch the client-side socket emission slightly or assume server uses timestamp
                // Actually server assigns ID = Date.now(). We need to rely on identifying our order by sender name initially or better logic.
                // For this simple version, we trust the username matching.
                
                window.socket.emit('new-order', fullText);
                
                // Hack: We estimate ID will be close to now, but better rely on user filtering
                // Wait for update
                App.showStatus('pending');
                document.getElementById('orderText').value = ''; // Clear
            },

            showStatus: (status) => {
                const overlay = document.getElementById('statusOverlay');
                const icon = document.getElementById('statusIcon');
                const text = document.getElementById('statusText');
                const sub = document.getElementById('statusSub');

                overlay.style.height = '100%'; // Show Full Overlay

                if (status === 'pending') {
                    icon.innerText = 'â³';
                    text.innerText = 'Î£Ï„Î¬Î»Î¸Î·ÎºÎµ! Î‘Î½Î±Î¼Î¿Î½Î®...';
                    sub.innerText = 'Î¤Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± ÎµÎ»Î­Î³Ï‡ÎµÎ¹ Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±';
                } else if (status === 'cooking') {
                    icon.innerText = 'ğŸ‘¨â€ğŸ³';
                    text.innerText = 'Î•Ï„Î¿Î¹Î¼Î¬Î¶ÎµÏ„Î±Î¹!';
                    sub.innerText = 'Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± Î­Î³Î¹Î½Îµ Î±Ï€Î¿Î´ÎµÎºÏ„Î®';
                } else if (status === 'ready') {
                    icon.innerText = 'ğŸ›µ';
                    text.innerText = 'ÎˆÏÏ‡ÎµÏ„Î±Î¹!';
                    sub.innerText = 'ÎŸ Î´Î¹Î±Î½Î¿Î¼Î­Î±Ï‚ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ / Î•Î¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î·';
                }
            },

            updateStatusUI: (status) => {
                App.showStatus(status);
            },

            resetUI: () => {
                document.getElementById('statusOverlay').style.height = '0';
                currentOrderId = null;
            }
        };

        // AUTH STATE
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                App.checkDetails();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContent').style.display = 'none';
            }
        });

    </script>
</body>
</html>
