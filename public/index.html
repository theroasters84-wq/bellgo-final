<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
    <title>Bellgo Driver</title>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; user-select: none; }
        .hidden { display: none !important; }
        .screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .btn { background: #ffc107; color: black; padding: 18px; border-radius: 12px; width: 90%; border: none; font-weight: bold; font-size: 1.2em; margin: 10px 0; }
        input { width: 85%; padding: 15px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #111; color: white; text-align: center; font-size: 1em; }
        
        /* CHAT */
        #chat-box { width: 95%; background: #111; border: 1px solid #333; border-radius: 10px; margin: 15px 0; display: flex; flex-direction: column; height: 40vh; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; text-align: left; font-size: 0.9em; border-bottom: 1px solid #333; }
        .msg { margin-bottom: 5px; padding: 8px; border-radius: 5px; word-wrap: break-word; }
        .msg.mine { background: #333; text-align: right; color: #ffc107; }
        .msg.others { background: #222; text-align: left; color: #fff; }

        /* ALERT & LOCK */
        #order-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f00; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; animation: flash 0.5s infinite; }
        @keyframes flash { 50% { background: #900; } }
        #fake-lock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <div id="unlock-screen" class="screen">
        <h1 style="color:#ffc107; font-size: 3em;">BELLGO</h1>
        <button class="btn" onclick="initApp()">Î•ÎšÎšÎ™ÎÎ—Î£Î—</button>
    </div>

    <div id="login-screen" class="screen hidden">
        <h2>Î•Î™Î£ÎŸÎ”ÎŸÎ£</h2>
        <input type="text" id="shop" placeholder="ÎœÎ±Î³Î±Î¶Î¯">
        <input type="password" id="pass" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ (1234)">
        <input type="text" id="name" placeholder="ÎŒÎ½Î¿Î¼Î±">
        <button class="btn" onclick="login('driver')">Î”Î™Î‘ÎÎŸÎœÎ•Î‘Î£ ğŸ›µ</button>
        <button class="btn" style="background:#333; color:#fff" onclick="login('admin')">ADMIN ğŸ› ï¸</button>
    </div>

    <div id="driver-ui" class="screen hidden">
        <div style="width:100%; display:flex; justify-content:space-between; padding:10px;">
            <span id="d-name" style="color:#ffc107; font-weight:bold;">DRIVER</span>
            <span style="color:#0f0;">â— ONLINE</span>
        </div>
        
        <div id="chat-box">
            <div id="chat-messages"></div>
            <div style="display:flex; padding:5px;">
                <input type="text" id="chat-in" placeholder="ÎœÎ®Î½Ï…Î¼Î±..." style="flex:1; margin:0;">
                <button onclick="sendChat()" style="background:#ffc107; border:none; padding:0 15px; border-radius:0 10px 10px 0;">â¤</button>
            </div>
        </div>

        <button class="btn" style="background:#222; color:white; border:1px solid #444" onclick="toggleLock()">ğŸ”’ FAKE LOCK</button>
        <button onclick="logout()" style="background:none; color:#666; border:none; margin-top:20px;">Logout</button>
    </div>

    <div id="order-layer" onclick="acceptOrder()">
        <h1 style="font-size:3em;">ÎšÎ›Î—Î£Î—!</h1>
        <p>Î Î‘Î¤Î‘ VOLUME BUTTON</p>
    </div>
    <div id="fake-lock" onclick="toggleLock()"><br><br><small style="color:#333">Tap to unlock</small></div>
    <audio id="snd" src="alert.mp3" loop></audio>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER_URL = 'https://bellgo-final.onrender.com'; // Î’Î¬Î»Îµ Ï„Î¿ ÏƒÏ‰ÏƒÏ„ÏŒ URL
        let socket, auth;
        const snd = document.getElementById('snd');
        const PushNotifications = (window.Capacitor && window.Capacitor.Plugins) ? window.Capacitor.Plugins.PushNotifications : null;

        function initApp() {
            document.getElementById('unlock-screen').classList.add('hidden');
            socket = io(SERVER_URL, { transports: ['websocket'] });

            socket.on('connect', () => {
                checkAuth();
                if(PushNotifications) setupPush();
            });

            // Î•Î”Î© Î•Î™ÎÎ‘Î™ Î— Î”Î™ÎŸÎ¡Î˜Î©Î£Î—: Î‘ÎšÎŸÎ¥Î•Î™ Î¤ÎŸ Î£Î©Î£Î¤ÎŸ EVENT
            socket.on('order-notification', () => triggerAlert());
            socket.on('chat-message', (data) => addMsg(data));
        }

        function login(role) {
            const name = document.getElementById('name').value;
            const pass = document.getElementById('pass').value;
            if(pass !== "1234") return alert("Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚");
            
            auth = { name, role };
            localStorage.setItem('auth', JSON.stringify(auth));
            socket.emit('login', auth); // Î£Ï„Î­Î»Î½ÎµÎ¹ login ÏƒÏ„Î¿Î½ server
            
            document.getElementById('login-screen').classList.add('hidden');
            if(role === 'driver') {
                document.getElementById('driver-ui').classList.remove('hidden');
                document.getElementById('d-name').innerText = name.toUpperCase();
            } else {
                window.location.href = "shop.html"; // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Admin Ï€Î¬ÎµÎ¹ ÏƒÏ„Î¿ shop.html
            }
        }

        function checkAuth() {
            const saved = localStorage.getItem('auth');
            if(saved) {
                auth = JSON.parse(saved);
                socket.emit('login', auth);
                if(auth.role === 'driver') {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('driver-ui').classList.remove('hidden');
                    document.getElementById('d-name').innerText = auth.name.toUpperCase();
                } else { window.location.href = "shop.html"; }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        function sendChat() {
            const txt = document.getElementById('chat-in').value;
            if(txt) {
                socket.emit('chat-message', { user: auth.name, text: txt });
                document.getElementById('chat-in').value = '';
            }
        }

        function addMsg(data) {
            const box = document.getElementById('chat-messages');
            const isMe = data.user === auth?.name;
            box.innerHTML += `<div class="msg ${isMe ? 'mine' : 'others'}"><b>${data.user}:</b> ${data.text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function triggerAlert() {
            document.getElementById('order-layer').style.display = 'flex';
            snd.play().catch(e=>console.log("No Audio"));
            if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
        }

        function acceptOrder() {
            document.getElementById('order-layer').style.display = 'none';
            snd.pause(); snd.currentTime = 0;
            if(navigator.vibrate) navigator.vibrate(0);
            socket.emit('chat-message', { user: 'SYSTEM', text: `âœ… ${auth.name} Î±Ï€Î¿Î´Î­Ï‡Î¸Î·ÎºÎµ!` });
        }

        window.addEventListener('keydown', (e) => {
            if((e.key==="VolumeUp" || e.key==="VolumeDown") && document.getElementById('order-layer').style.display==='flex'){
                e.preventDefault(); acceptOrder();
            }
        });

        function toggleLock() {
            const l = document.getElementById('fake-lock');
            l.style.display = l.style.display === 'block' ? 'none' : 'block';
        }

        function logout() { localStorage.clear(); location.reload(); }

        async function setupPush() {
            await PushNotifications.requestPermissions();
            await PushNotifications.register();
            PushNotifications.addListener('pushNotificationReceived', () => triggerAlert());
        }
    </script>
</body>
</html>
