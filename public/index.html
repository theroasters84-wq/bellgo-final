<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; media-src * data: blob:;">
    <title>Bellgo Unified</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; text-align: center; user-select: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        .screen { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        
        input, select { width: 90%; padding: 15px; margin: 8px 0; background: #111; border: 1px solid #444; color: white; text-align: center; border-radius: 8px; font-size: 16px; }
        .btn { width: 95%; padding: 18px; margin: 10px 0; background: #ffc107; color: black; border: none; font-weight: bold; font-size: 18px; border-radius: 8px; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid #ffc107; color: #ffc107; }
        .setting-row { display: flex; justify-content: space-between; width: 90%; margin: 10px 0; align-items: center; background: #222; padding: 10px; border-radius: 8px; }

        #drivers-container { width: 100%; height: 50vh; overflow-y: auto; margin-bottom: 10px; border: 1px solid #333; padding: 10px; border-radius: 10px; background: #111; }
        .driver-card { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; }
        .btn-call { background: #ff4444; color: white; border: none; padding: 10px 20px; font-weight: bold; border-radius: 5px; font-size: 1.1em; transition: 0.3s; }
        .btn-accepted { background: #00cc00 !important; color: white !important; transform: scale(1.1); }

        #chat-ui { width: 100%; height: 45vh; display: flex; flex-direction: column; border: 1px solid #333; background: #0a0a0a; border-radius: 8px; margin-top: 10px; margin-bottom: 10px; }
        #chat-msgs { flex: 1; overflow-y: auto; text-align: left; padding: 10px; font-size: 14px; }
        .msg { margin-bottom: 8px; padding: 5px; }
        .mine { color: #ffc107; text-align: right; }
        .theirs { color: #00ccff; text-align: left; }
        #admin-chat-ui { width: 100%; height: 30vh; border:1px solid #333; background:#111; display:flex; flex-direction:column; border-radius: 8px;}

        #alert-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: red; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; animation: flash 0.5s infinite; cursor: pointer; }
        @keyframes flash { 50% { background: #900; } }
        
        #fake-lock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10000; display: none; }
        
        /* AUDIO ELEMENTS */
        audio { display: none; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ffc107; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1 style="color:#ffc107; letter-spacing: 2px; font-size: 3em;">BELLGO v23</h1>
        <input type="text" id="shop" placeholder="ÎŸÎÎŸÎœÎ‘ ÎœÎ‘Î“Î‘Î–Î™ÎŸÎ¥">
        <input type="password" id="pass" placeholder="ÎšÎ©Î”Î™ÎšÎŸÎ£">
        <input type="text" id="name" placeholder="Î¤ÎŸ ÎŸÎÎŸÎœÎ‘ Î£ÎŸÎ¥">
        <select id="role-select" style="padding:15px; font-size:1.1em;">
            <option value="driver">ğŸ›µ Î”Î™Î‘ÎÎŸÎœÎ•Î‘Î£ / Î£Î•Î¡Î’Î™Î¤ÎŸÎ¡ÎŸÎ£</option>
            <option value="admin">ğŸ’» KATAÎ£Î¤Î—ÎœÎ‘ (ADMIN)</option>
        </select>
        <button class="btn" onclick="attemptLogin()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
        <div id="logs" style="width:90%; height:150px; background:#222; color:#0f0; font-family:monospace; font-size:10px; overflow-y:scroll; text-align:left; padding:5px; margin-top:20px;">
            Î‘Î½Î±Î¼Î¿Î½Î®...
        </div>
    </div>

    <div id="driver-ui" class="screen hidden">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
            <h2 id="d-label" style="color:#ffc107; margin:0;">DRIVER</h2>
            <span style="color:#0f0">â— ONLINE</span>
        </div>
        <div class="setting-row">
            <span>ğŸ”Š Î‰Ï‡Î¿Ï‚ (Loop)</span>
            <label class="switch"><input type="checkbox" id="sound-toggle" checked><span class="slider"></span></label>
        </div>
        <div class="setting-row">
            <span>ğŸ“³ Î”ÏŒÎ½Î·ÏƒÎ· (Loop)</span>
            <label class="switch"><input type="checkbox" id="vib-toggle" checked><span class="slider"></span></label>
        </div>
        <div id="chat-ui">
            <div id="chat-msgs"></div>
            <div style="display:flex; border-top:1px solid #333; padding: 5px;">
                <input type="text" id="c-in" placeholder="ÎœÎ®Î½Ï…Î¼Î±..." style="border:none; margin:0; width:80%;">
                <button onclick="sendChat()" style="width:20%; background:#ffc107; border:none; font-weight:bold; border-radius: 5px;">â¤</button>
            </div>
        </div>
        <div style="width:100%; display:flex; gap:10px;">
            <button class="btn btn-outline" style="flex:1; margin:0;" onclick="toggleLock()">ğŸ”’ LOCK</button>
            <button onclick="logout()" style="flex:1; background:#333; color:white; border:none; border-radius:8px; margin:0;">EXIT</button>
        </div>
    </div>

    <div id="admin-ui" class="screen hidden">
        <h2 style="color:#ffc107; margin-bottom:5px;">ADMIN PANEL</h2>
        <p style="color:#888; margin-top:0;" id="shop-label">SHOP</p>
        <div id="drivers-container"><p style="color:#666; text-align:center; padding-top:20px;">Î‘Î½Î±Î¼Î¿Î½Î®...</p></div>
        <div id="admin-chat-ui">
            <div id="admin-chat-msgs" style="flex:1; overflow-y:auto; padding:5px; text-align:left;"></div>
            <div style="display:flex;">
                <input type="text" id="a-in" placeholder="Chat..." style="flex:1; margin:0; border:none;">
                <button onclick="sendAdminChat()" style="background:#444; color:white; border:none; padding:10px; width:60px;">â¤</button>
            </div>
        </div>
        <button onclick="logout()" style="background:none; border:none; color:#666; margin-top:10px;">Logout</button>
    </div>

    <div id="alert-layer" onclick="acceptOrder()">
        <h1 style="font-size:3em; color:white">ÎšÎ›Î—Î£Î—!</h1>
        <p style="font-size:1.5em; color:white">Î Î‘Î¤Î‘ ÎŸÎ˜ÎŸÎÎ—</p>
    </div>
    <div id="fake-lock" onclick="toggleLock()"><div style="color:#222; margin-top:50px;">Touch to Unlock</div></div>

    <audio id="snd-alert" src="alert.mp3" loop preload="auto"></audio>
    <audio id="snd-silent" loop autoplay preload="auto"></audio>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER = 'https://bellgo-final.onrender.com';
        let socket, auth;
        const sndAlert = document.getElementById('snd-alert');
        const sndSilent = document.getElementById('snd-silent');
        
        // 1. Î”ÎŸÎšÎ™ÎœÎ‘Î£ÎœÎ•ÎÎŸ SILENT MP3 (10 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± Î±Ï€ÏŒÎ»Ï…Ï„Î·Ï‚ Î·ÏƒÏ…Ï‡Î¯Î±Ï‚)
        // Î‘Ï…Ï„ÏŒ Ï„Î¿ string ÎµÎ¯Î½Î±Î¹ Ï€Î¹Î¿ Î±Î¾Î¹ÏŒÏ€Î¹ÏƒÏ„Î¿ Î±Ï€ÏŒ Ï„Î¿ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿
        const SILENT_MP3 = "data:audio/mp3;base64,SUQzBAAAAAABAFRYWFgAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUWFhYAAAAEQAAA21pbm9yX3ZlcnNpb24AMABUWFhYAAAAHAAAA2NvbXBhdGlibGVfYnJhbmRzAG1wNDJpc29tAFRTU0UAAAAPAAADTGF2ZjU3LjU2LjEwMAAAAAAAAAAAAAAA//tQZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIQAABQoODxQUGRkdHSImJioqNDQ4OD4+QkJISExMTFVWVlhZWV1dYmJmampta2tvcHB0dHZ2enp+foCAhISEiIiNjY6OkpKTk5WYmJqanJygoKSkpKurrKyxsXOzs7u7vLyAwMDFxcjIyMzM0NDU1Njc3N7e4ODi4uPk5OXl6enubnKv7wAAADlMYXZjNTcuNjQuMTAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//tQZAAABAAAAAAAAAAAAEAAABIQA78AIgAAAAAAJAAAAAAAAAAAB//tQZAAAAAAAIAAAABAAABIQA78AIgAAAAAAJAAAAAAAAAAAB//tQZAAAAAAAIAAAABAAABIQA78AIgAAAAAAJAAAAAAAAAAAB";
        sndSilent.src = SILENT_MP3;

        let vibrationInterval = null, heartbeatInterval = null, wakeLock = null, keepAliveInterval = null;

        function log(msg) {
            const el = document.getElementById('logs');
            el.innerHTML = `> ${msg}<br>` + el.innerHTML;
            console.log(msg);
        }

        // 2. Î•ÎÎ•Î¡Î“ÎŸÎ ÎŸÎ™Î—Î£Î— BACKGROUND MODE (Î’Î•Î›Î¤Î™Î©ÎœÎ•ÎÎ—)
        // ÎšÎ±Î»ÎµÎ¯Ï„Î±Î¹ ÎœÎ•Î¤Î‘ Ï„Î¿ deviceready Î±Î»Î»Î¬ Î Î¡Î™Î Ï„Î¿ Login Î³Î¹Î± ÏƒÎ¹Î³Î¿Ï…ÏÎ¹Î¬
        document.addEventListener('deviceready', function () {
            if (window.cordova && cordova.plugins && cordova.plugins.backgroundMode) {
                // Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Î· Î¼Ï€Î¬ÏÎ±
                cordova.plugins.backgroundMode.setDefaults({ 
                    title: "Bellgo Active", 
                    text: "Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï„ÏÎ­Ï‡ÎµÎ¹ ÏƒÏ„Î¿ Ï€Î±ÏÎ±ÏƒÎºÎ®Î½Î¹Î¿",
                    ticker: "Bellgo Ready",
                    silent: false, // Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ false Î³Î¹Î± Î½Î± Î´ÎµÎ¯Î¾ÎµÎ¹ Ï„Î·Î½ Î¼Ï€Î¬ÏÎ± ÏƒÎµ Î½ÎµÏŒÏ„ÎµÏÎ± Android
                    resume: true, 
                    hidden: false 
                });
                
                // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·
                cordova.plugins.backgroundMode.enable();
                
                // Extra ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
                cordova.plugins.backgroundMode.on('activate', function() {
                    cordova.plugins.backgroundMode.disableWebViewOptimizations(); 
                    requestWakeLock();
                    // Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ· Î®Ï‡Î¿Ï… Î±Î½ ÎºÎ¿Ï€ÎµÎ¯
                    if(sndSilent.paused) sndSilent.play().catch(e=>console.log(e));
                });
                
                log("ğŸ“± Background Mode: ENABLED (Check Bar)");
            } else {
                log("âš ï¸ Background Mode Plugin NOT FOUND");
            }
        }, false);

        function attemptLogin() {
            const s = document.getElementById('shop').value.trim();
            const p = document.getElementById('pass').value;
            const n = document.getElementById('name').value.trim();
            const r = document.getElementById('role-select').value;

            if(p !== "1234") return alert("Î›Î¬Î¸Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚");
            if(!s || !n) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€ÎµÎ´Î¯Î±");

            // 3. EKKINHÎ£Î— Î—Î§Î©Î ÎœÎ• USER INTERACTION
            // Î•Î´Ï "Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÎ½Î¿Ï…Î¼Îµ" Ï„Î¿Î½ browser
            log("ğŸ”Š Unlocking Audio...");
            
            // Î Î±Î¯Î¶Î¿Ï…Î¼Îµ Ï„Î¿ silent ÎºÎ±Î¹ Ï„Î¿ alert ÏƒÏ„Î¹Î³Î¼Î¹Î±Î¯Î±
            sndSilent.play().then(() => log("âœ… Silent Playing")).catch(e => log("âŒ Silent Error: " + e.message));
            
            sndAlert.volume = 1.0;
            sndAlert.load();
            sndAlert.play().then(() => { 
                sndAlert.pause(); 
                sndAlert.currentTime = 0; 
                log("âœ… Alert Unlocked");
            }).catch(e => log("âš ï¸ Alert Warning: " + e.message));

            requestWakeLock();
            
            // Watcher (Keep Alive Loop)
            if (keepAliveInterval) clearInterval(keepAliveInterval);
            keepAliveInterval = setInterval(() => {
                if(sndSilent.paused) {
                    sndSilent.play().catch(e=>{});
                }
                requestWakeLock();
            }, 5000); 

            auth = { shop: s, name: n, role: r };
            localStorage.setItem('unified_auth_v23', JSON.stringify(auth));
            
            initUI();
            connect();
        }

        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        function initUI() {
            document.getElementById('login-screen').classList.add('hidden');
            if(auth.role === 'driver') {
                document.getElementById('driver-ui').classList.remove('hidden');
                document.getElementById('d-label').innerText = auth.name.toUpperCase();
            } else {
                document.getElementById('admin-ui').classList.remove('hidden');
                document.getElementById('shop-label').innerText = auth.shop.toUpperCase();
            }
        }

        function connect() {
            log("ğŸŒ Connecting...");
            socket = io(SERVER, { transports: ['websocket'] });

            socket.on('connect', () => {
                log("âœ… Connected to Server!");
                socket.emit('login', auth);
                if(auth.role === 'driver') {
                    if(heartbeatInterval) clearInterval(heartbeatInterval);
                    heartbeatInterval = setInterval(() => { if(socket.connected) socket.emit('heartbeat', { name: auth.name }); }, 5000);
                    setTimeout(setupPush, 1000); 
                }
            });

            socket.on('update-drivers-list', (drivers) => {
                if(auth.role !== 'admin') return;
                const list = document.getElementById('drivers-container');
                list.innerHTML = ""; 
                drivers.forEach(d => {
                    list.innerHTML += `<div class="driver-card"><span style="font-size:1.2em; color:white; font-weight:bold;">ğŸ›µ ${d.name}</span><button id="btn-${d.name}" class="btn-call" onclick="callDriver('${d.name}')">ÎšÎ›Î—Î£Î— ğŸ””</button></div>`;
                });
            });

            socket.on('order-accepted', (driverName) => {
                if(auth.role !== 'admin') return;
                const btn = document.getElementById(`btn-${driverName}`);
                if(btn) {
                    btn.classList.add('btn-accepted'); btn.innerText = "Î‘Î ÎŸÎ”ÎŸÎ§Î—! âœ…"; btn.disabled = false;
                    setTimeout(() => { btn.classList.remove('btn-accepted'); btn.innerText = "ÎšÎ›Î—Î£Î— ğŸ””"; }, 4000);
                }
            });

            socket.on('order-notification', () => { if(auth.role === 'driver') triggerAlert(); });
            socket.on('chat-message', (data) => {
                const box = auth.role === 'driver' ? document.getElementById('chat-msgs') : document.getElementById('admin-chat-msgs');
                box.innerHTML += `<div class="msg ${data.user === auth.name ? 'mine' : 'theirs'}"><b>${data.user}:</b> ${data.text}</div>`;
                box.scrollTop = box.scrollHeight;
            });
        }

        function callDriver(targetName) {
            socket.emit('call-driver', targetName);
            const btn = document.getElementById(`btn-${targetName}`);
            if(btn) { btn.classList.add('btn-calling'); btn.innerText = "ÎšÎ›Î—Î£Î—..."; btn.disabled = true; }
        }

        function sendAdminChat() {
            const txt = document.getElementById('a-in').value;
            if(txt) { socket.emit('chat-message', { shop: auth.shop, user: auth.name, text: txt }); document.getElementById('a-in').value = ''; }
        }
        function sendChat() {
            const txt = document.getElementById('c-in').value;
            if(txt) { socket.emit('chat-message', { shop: auth.shop, user: auth.name, text: txt }); document.getElementById('c-in').value = ''; }
        }

        function triggerAlert() {
            if(document.getElementById('alert-layer').style.display === 'flex') return;
            
            // FORCE PLAY
            sndAlert.currentTime = 0; 
            sndAlert.play().catch(e => log("Alert Play Error: " + e));

            document.getElementById('alert-layer').style.display = 'flex';
            if(document.getElementById('fake-lock').style.display === 'block') document.getElementById('fake-lock').style.display = 'none';
            
            if(document.getElementById('vib-toggle').checked && navigator.vibrate) {
                navigator.vibrate([1000, 500, 1000, 500]); 
                if (vibrationInterval) clearInterval(vibrationInterval);
                vibrationInterval = setInterval(() => { navigator.vibrate([1000, 500, 1000, 500]); }, 3000);
            }
        }

        function acceptOrder() {
            document.getElementById('alert-layer').style.display = 'none';
            sndAlert.pause(); sndAlert.currentTime = 0;
            if(sndSilent.paused) sndSilent.play().catch(e=>{});
            if(vibrationInterval) clearInterval(vibrationInterval);
            if(navigator.vibrate) navigator.vibrate(0);
            socket.emit('accept-order', { shop: auth.shop, driverName: auth.name });
            requestWakeLock();
        }

        function logout() { if(socket) socket.emit('force-logout', auth); localStorage.clear(); location.reload(); }

        // --- PUSH NOTIFICATIONS ---
        async function setupPush() {
            log("3. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Push Plugin...");
            if (!window.Capacitor || !window.Capacitor.Plugins || !window.Capacitor.Plugins.PushNotifications) {
                log("âŒ ERROR: Plugin not found");
                return;
            }

            const PushNotifications = window.Capacitor.Plugins.PushNotifications;
            
            try {
                const perm = await PushNotifications.requestPermissions();
                if (perm.receive === 'granted') {
                    await PushNotifications.register();
                } else {
                    log("âŒ Î†Î´ÎµÎ¹Î± Push Î±Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ!");
                }

                PushNotifications.addListener('registration', (token) => {
                    auth.fcmToken = token.value;
                    socket.emit('update-token', { name: auth.name, token: token.value });
                    // Î‘Î¦Î‘Î™Î¡Î•Î£Î‘ÎœÎ• Î¤ÎŸ ALERT Î•Î”Î©! Î¤Î©Î¡Î‘ ÎœÎŸÎÎŸ LOG
                    log("âœ… TOKEN OK: " + token.value.substring(0, 5) + "..."); 
                });

                PushNotifications.addListener('registrationError', (err) => {
                    log("âŒ Reg Error: " + JSON.stringify(err));
                });

                PushNotifications.addListener('pushNotificationReceived', () => triggerAlert());
                PushNotifications.addListener('pushNotificationActionPerformed', () => triggerAlert());
            } catch(e) {
                log("âš ï¸ Push Exception: " + JSON.stringify(e));
            }
        }

        function toggleLock() {
            const l = document.getElementById('fake-lock');
            l.style.display = l.style.display === 'block' ? 'none' : 'block';
        }

        const saved = localStorage.getItem('unified_auth_v23');
        if(saved) {
            auth = JSON.parse(saved);
            initUI();
            connect();
        }
    </script>
</body>
</html>
