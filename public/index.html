<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo System</title>
    <style>
        /* CSS STYLES */
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; }
        
        input { padding: 15px; margin: 10px; width: 80%; border-radius: 8px; border: 1px solid #444; background: #222; color: white; font-size: 18px; text-align: center; }
        
        .btn { padding: 18px; font-size: 18px; border-radius: 12px; width: 90%; margin: 8px; font-weight: bold; border: none; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.96); }
        
        .btn-green { background-color: #00C853; } 
        .btn-blue { background-color: #2962FF; }  
        .btn-red { background-color: #D50000; }   
        
        /* ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ Î£ÎµÏÎ²Î¹Ï„ÏŒÏÏ‰Î½ */
        .btn-user { background-color: #37474F; border: 1px solid #546E7A; margin: 5px; width: 45%; display: inline-block; font-size: 16px; padding: 15px; }
        .btn-user:active { background-color: #00C853; }

        /* STOP OVERLAY */
        .stop-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #b71c1c; z-index: 5000; flex-direction: column; justify-content: center; align-items: center; animation: pulse 0.5s infinite; }
        .btn-stop-big { width: 90%; height: 40%; font-size: 40px; background: white; color: red; border-radius: 20px; font-weight: 900; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }

        /* CHAT */
        #chatContainer { flex: 1; width: 95%; background: #1a1a1a; border-radius: 10px 10px 0 0; margin-top: auto; display: flex; flex-direction: column; border-top: 2px solid #333; max-height: 35vh; }
        #chatMessages { flex: 1; overflow-y: auto; text-align: left; padding: 10px; font-size: 14px; color: #ccc; }
        .chat-input-area { display: flex; width: 100%; }
        .chat-input { flex:1; margin:0; border-radius:0 0 0 10px; border:none; border-top:1px solid #444; }
        .chat-btn { width:60px; margin:0; border-radius:0 0 10px 0; }
        
        .msg-sys { color: #fdd835; font-style: italic; font-size: 12px; margin-bottom: 4px; }
        .msg-usr { color: #fff; margin-bottom: 4px; }

        #usersContainer { max-height: 40vh; overflow-y: auto; width: 100%; padding-bottom: 10px; }

        @keyframes pulse { 0% { background-color: #b71c1c; } 50% { background-color: #ff0000; } 100% { background-color: #b71c1c; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen" style="display:flex;">
        <h2 style="color:#00C853;">BELLGO CONNECT</h2>
        <input type="text" id="storeName" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î³Î±Î¶Î¹Î¿Ï">
        <input type="text" id="username" placeholder="ÎŒÎ½Î¿Î¼Î± Î§ÏÎ®ÏƒÏ„Î·">
        <input type="password" id="password" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ (1234)" inputmode="numeric">
        
        <div style="margin-top:20px; width:100%; display:flex; justify-content:center; gap:10px;">
            <button class="btn btn-green" style="width:45%" onclick="attemptLogin('admin')">ADMIN</button>
            <button class="btn btn-blue" style="width:45%" onclick="attemptLogin('staff')">STAFF</button>
        </div>
        <p id="loginError" style="color:red; display:none;">Î›Î¬Î¸Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚!</p>
    </div>

    <div id="adminScreen" class="screen">
        <div style="padding:10px; width:100%; background:#222; border-bottom:1px solid #444;">
            <h3 id="adminHeader" style="margin:0;">Admin Panel</h3>
        </div>
        
        <button class="btn btn-red" onclick="triggerAlarm(null)">ğŸ“¢ ÎšÎ›Î—Î£Î— Î£Î• ÎŸÎ›ÎŸÎ¥Î£</button>
        
        <p style="color:#888; font-size:12px; margin-top:10px;">Î”Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒ:</p>
        <div id="usersContainer">
            </div>

        <div id="chatContainer">
            <div id="chatMessagesAdmin"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInputAdmin" class="chat-input" placeholder="ÎœÎ®Î½Ï…Î¼Î±...">
                <button class="btn btn-blue chat-btn" onclick="sendChat('admin')">></button>
            </div>
        </div>
    </div>

    <div id="receiverScreen" class="screen">
        <div style="font-size: 80px; margin-bottom:20px;">ğŸ§</div>
        <h2 id="receiverHeader">Î‘Î½Î±Î¼Î¿Î½Î®...</h2>
        <p id="botStatus" style="color:#555; font-size:11px;">Bot: Waiting...</p>
        
        <button onclick="toggleFakeLock(true)" style="margin-top:30px; background:#222; color:#888; border:1px solid #444; padding:15px; border-radius:10px; width:60%;">
            ğŸ”’ Fake Lock
        </button>

        <div id="chatContainer" style="margin-top:auto;">
            <div id="chatMessagesStaff" style="flex:1; overflow-y:auto; text-align:left; padding:10px;"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInputStaff" class="chat-input" placeholder="ÎœÎ®Î½Ï…Î¼Î±...">
                <button class="btn btn-blue chat-btn" onclick="sendChat('staff')">></button>
            </div>
        </div>
    </div>

    <div id="stopOverlay" class="stop-overlay">
        <h1 style="color:white; font-size:50px; margin-bottom:10px;">ğŸ”” ÎšÎ›Î—Î£Î—</h1>
        <h2 id="callerName" style="color:yellow; margin-bottom:30px;">...</h2>
        <button class="btn btn-stop-big" onclick="stopAlarm()">STOP</button>
        <p style="color:white; font-size:12px; margin-top:20px;">(Î® Ï€Î¬Ï„Î± Volume Up)</p>
    </div>

    <div id="fakeLock" onclick="toggleFakeLock(false)" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:9000;">
        <div style="position:absolute; bottom:50px; width:100%; text-align:center; color:#333; font-size:12px;">Double Tap to Unlock</div>
    </div>

    <audio id="alertPlayer" preload="auto" loop playsinline><source src="alert.mp3" type="audio/mpeg"></audio>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        let myRole = '';
        let isRinging = false;
        let vibrationInterval = null;
        let audioContext = null;

        // --- 1. LOGIN & BOT START ---
        function attemptLogin(role) {
            const store = document.getElementById('storeName').value.trim();
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();

            if (!store || !user) { alert("Î’Î¬Î»Îµ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï ÎºÎ±Î¹ Ï‡ÏÎ®ÏƒÏ„Î·!"); return; }
            if (pass !== '1234') { document.getElementById('loginError').style.display = 'block'; return; }

            // ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î± "Silent Engines"
            initAudioEngine(); // Î‘Î½Ï„Î¯ Î³Î¹Î± silence.mp3
            if(role === 'staff') startNavBot(); // Fake GPS

            // Î¤ÏÎ­Ï‡Î¿Ï…Î¼Îµ Ï„Î¿ Fully Kiosk Bot
            runFullyKioskBot();

            // Î£ÏÎ½Î´ÎµÏƒÎ·
            socket.emit('join-store', { storeName: store, username: user, role: role });

            // Î‘Î»Î»Î±Î³Î® ÎŸÎ¸ÏŒÎ½Î·Ï‚
            document.getElementById('loginScreen').style.display = 'none';
            myRole = role;
            
            if (role === 'admin') {
                document.getElementById('adminScreen').style.display = 'flex';
                document.getElementById('adminHeader').innerText = "Admin: " + user;
            } else {
                document.getElementById('receiverScreen').style.display = 'flex';
                document.getElementById('receiverHeader').innerText = "Î“ÎµÎ¹Î± ÏƒÎ¿Ï… " + user;
            }
        }

        // --- 2. ADMIN: DYNAMIC USER BUTTONS ---
        socket.on('update-user-list', (users) => {
            if (myRole !== 'admin') return;
            const container = document.getElementById('usersContainer');
            container.innerHTML = ''; 

            if (users.length === 0) {
                container.innerHTML = '<p style="color:#555; font-size:12px;">ÎšÎ±Î½ÎµÎ¯Ï‚ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚...</p>';
                return;
            }

            users.forEach(u => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-user';
                btn.innerHTML = `ğŸ”” <b>${u.name}</b>`;
                // Î•Î”Î© Î•Î™ÎÎ‘Î™ Î— Î”Î™ÎŸÎ¡Î˜Î©Î£Î—: Î ÎµÏÎ½Î¬Î¼Îµ Ï„Î¿ ID ÏƒÏ‰ÏƒÏ„Î¬
                btn.onclick = function() { triggerAlarm(u.id); }; 
                container.appendChild(btn);
            });
        });

        function triggerAlarm(targetId) {
            console.log("Calling ID:", targetId); // Debug
            socket.emit('trigger-alarm', { targetId: targetId });
        }

        // --- 3. RECEIVER: ALARM LOGIC ---
        socket.on('ring-bell', (data) => {
            if (isRinging) return;
            isRinging = true;

            const sender = data.sender || "Admin";
            document.getElementById('callerName').innerText = sender;

            // Fully Kiosk Wake Up
            if (window.fully) {
                fully.turnScreenOn();
                fully.bringToForeground();
            }

            // Unlock Fake Lock
            toggleFakeLock(false);

            // Show Alarm
            document.getElementById('stopOverlay').style.display = 'flex';

            // Sound
            const player = document.getElementById('alertPlayer');
            player.currentTime = 0;
            player.volume = 1.0;
            player.play().catch(e => console.log("Play error:", e));

            // Vibration Pattern (BZZ-pause-BZZ)
            startVibration();
        });

        function stopAlarm() {
            if (!isRinging) return;
            isRinging = false;
            
            const player = document.getElementById('alertPlayer');
            player.pause();
            player.currentTime = 0;
            stopVibration();

            document.getElementById('stopOverlay').style.display = 'none';
        }

        // --- 4. FULLY KIOSK BOT (AUTO PERMISSIONS) ---
        function runFullyKioskBot() {
            const status = document.getElementById('botStatus');
            if (window.fully) {
                status.innerText = "Bot: Fully Kiosk Detected";
                
                try {
                    // 1. Î–Î·Ï„Î¬ÎµÎ¹ Overlay (Î ÎµÏ„Î¬Î³ÎµÏ„Î±Î¹ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î±Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î´Î¿Î¸ÎµÎ¯)
                    fully.requestOverlayPermission();

                    // 2. Î ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± Î±Î½ÎµÎ²Î¬ÏƒÎµÎ¹ Î­Î½Ï„Î±ÏƒÎ·
                    fully.setMusicVolume(100);

                    // 3. Î ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± ÎºÏÎ±Ï„Î®ÏƒÎµÎ¹ Î¿Î¸ÏŒÎ½Î· Î±Î½Î¿Î¹Ï‡Ï„Î® (PLUS Feature - Î¸Î± Î²Î³Î¬Î»ÎµÎ¹ Î¼Î®Î½Ï…Î¼Î±)
                    fully.setBooleanSetting("keepScreenOn", true);
                    fully.setBooleanSetting("unlockScreen", true);
                    
                    // 4. Î ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± Î±ÎºÎ¿ÏÏƒÎµÎ¹ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ (PLUS Feature)
                    fully.setBooleanSetting("listenVolumeButtons", true);

                    status.innerText = "Bot: Settings Applied";
                } catch (e) {
                    console.log("Bot Error (No License?): " + e);
                    status.innerText = "Bot: License Warning (Ignore)";
                }
            } else {
                status.innerText = "Bot: Browser Mode (Not Fully)";
            }
        }

        // --- 5. SILENT AUDIO ENGINE (No MP3 needed) ---
        function initAudioEngine() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                gain.gain.value = 0.0001; // Î£Ï‡ÎµÎ´ÏŒÎ½ ÏƒÎ¹Ï‰Ï€Î®
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start();
                console.log("Silent Audio Started");
            } catch(e) {
                console.log("Audio Context Error");
            }
        }

        // --- 6. NAV BOT (FAKE GPS) ---
        function startNavBot() {
            if ("geolocation" in navigator) {
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        (p) => console.log("Nav Pulse"),
                        (e) => console.log("Nav KeepAlive"),
                        {enableHighAccuracy:true}
                    );
                }, 20000);
            }
        }

        // --- 7. UTILS & CHAT ---
        function sendChat(role) {
            const inputId = role === 'admin' ? 'chatInputAdmin' : 'chatInputStaff';
            const input = document.getElementById(inputId);
            const msg = input.value.trim();
            if (msg) {
                socket.emit('send-chat', msg);
                input.value = '';
            }
        }

        socket.on('chat-message', (data) => {
            const line = document.createElement('div');
            if (data.sender === 'System') {
                line.className = 'msg-sys';
                line.innerText = `[INFO] ${data.text}`;
            } else {
                line.className = 'msg-usr';
                line.innerHTML = `<b style="color:#00C853">${data.sender}:</b> ${data.text}`;
            }

            const containers = [document.getElementById('chatMessagesAdmin'), document.getElementById('chatMessagesStaff')];
            containers.forEach(c => {
                if (c) {
                    c.appendChild(line.cloneNode(true));
                    c.scrollTop = c.scrollHeight;
                }
            });
        });

        // Volume Button Handler
        window.addEventListener('keydown', (e) => {
            const stopKeys = [179, 24, 25, 85, 13]; // PlayPause, VolUp, VolDown, Media, Enter
            if (stopKeys.includes(e.keyCode) || e.key === "VolumeUp" || e.key === "VolumeDown") {
                if (isRinging) {
                    stopAlarm();
                    e.preventDefault();
                }
            }
        });

        function startVibration() {
            if (navigator.vibrate) navigator.vibrate([1000, 200, 1000]);
            if (vibrationInterval) clearInterval(vibrationInterval);
            vibrationInterval = setInterval(() => {
                if (navigator.vibrate) navigator.vibrate([1000, 200, 1000]);
            }, 2500);
        }

        function stopVibration() {
            if (vibrationInterval) clearInterval(vibrationInterval);
            if (navigator.vibrate) navigator.vibrate(0);
        }

        function toggleFakeLock(enable) {
            document.getElementById('fakeLock').style.display = enable ? 'block' : 'none';
        }
    </script>
</body>
</html>
