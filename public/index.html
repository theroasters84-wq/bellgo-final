<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bellgo Driver</title>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; }
        .hidden { display: none !important; }
        .screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .btn { background: #ffc107; color: black; padding: 18px; border-radius: 12px; width: 85%; border: none; font-weight: bold; font-size: 1.1em; cursor: pointer; margin: 10px 0; }
        input { width: 80%; padding: 15px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #111; color: white; text-align: center; }
        #chat-box { width: 90%; background: #111; border: 1px solid #333; border-radius: 10px; margin: 15px 0; }
        #chat-messages { height: 150px; overflow-y: auto; padding: 10px; text-align: left; font-size: 0.9em; border-bottom: 1px solid #333; }
        #order-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f00; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; animation: flash 0.5s infinite; }
        @keyframes flash { 50% { background: #900; } }
        #fake-lock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <div id="unlock-screen" class="screen">
        <h1 style="color:#ffc107">BELLGO</h1>
        <button class="btn" onclick="initApp()">ΕΝΕΡΓΟΠΟΙΗΣΗ</button>
    </div>

    <div id="login-screen" class="screen hidden">
        <h2>ΕΙΣΟΔΟΣ</h2>
        <input type="text" id="shop" placeholder="ΜΑΓΑΖΙ">
        <input type="password" id="pass" placeholder="ΚΩΔΙΚΟΣ">
        <input type="text" id="name" placeholder="ΟΝΟΜΑ">
        <button class="btn" onclick="setRole('driver')">ΔΙΑΝΟΜΕΑΣ</button>
        <button class="btn" style="background:#333; color:white;" onclick="setRole('admin')">ADMIN</button>
    </div>

    <div id="driver-ui" class="screen hidden">
        <h2 id="d-name"></h2>
        <p style="color:#0f0">● ONLINE</p>
        <div id="chat-box">
            <div id="chat-messages"></div>
            <div style="display:flex; padding:5px;">
                <input type="text" id="chat-in" placeholder="Chat..." style="flex:1; margin:0; padding:10px;">
                <button onclick="sendChat()" style="background:#ffc107; border:none; padding:10px;">➤</button>
            </div>
        </div>
        <button class="btn" style="background:#111; color:white; border:1px solid #333" onclick="document.getElementById('fake-lock').style.display='block'">FAKE LOCK</button>
        <button onclick="logout()" style="background:none; color:#444; border:none; margin-top:10px;">Logout</button>
    </div>

    <div id="order-layer" onclick="acceptOrder()">
        <h1>ΚΛΗΣΗ!</h1>
        <p>ΠΑΤΑ ΕΔΩ Ή ΤΟ VOLUME BUTTON</p>
    </div>

    <div id="fake-lock" onclick="this.style.display='none'"></div>
    <audio id="snd" src="alert.mp3" loop></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket, auth;
        const snd = document.getElementById('snd');

        function initApp() {
            document.getElementById('unlock-screen').classList.add('hidden');
            const isAndroid = /Android/i.test(navigator.userAgent) || window.location.hostname === "";
            const url = isAndroid ? 'http://10.0.2.2:3000' : window.location.origin;
            socket = io(url, { transports: ['websocket'] });

            socket.on('connect', () => {
                console.log("Connected!");
                checkAuth();
            });

            socket.on('new-order', () => {
                if(auth?.isDriver) {
                    document.getElementById('order-layer').style.display = 'flex';
                    snd.play().catch(() => {});
                    if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200]);
                }
            });

            socket.on('new-chat-message', (data) => {
                const box = document.getElementById('chat-messages');
                if(box) {
                    box.innerHTML += `<div><b style="color:#ffc107">${data.user}:</b> ${data.text}</div>`;
                    box.scrollTop = box.scrollHeight;
                }
            });
        }

        window.addEventListener('keydown', (e) => {
            if(e.keyCode === 24 || e.keyCode === 25) { 
                if(document.getElementById('order-layer').style.display === 'flex') {
                    e.preventDefault();
                    acceptOrder();
                }
            }
        });

        function acceptOrder() {
            snd.pause(); snd.currentTime = 0;
            if(navigator.vibrate) navigator.vibrate(0);
            document.getElementById('order-layer').style.display = 'none';
            socket.emit('order-accepted', { driverName: auth.name, shopName: auth.shop });
        }

        function sendChat() {
            const m = document.getElementById('chat-in');
            if(m.value && socket) { socket.emit('send-chat-message', m.value); m.value=''; }
        }

        function setRole(role) {
            auth = { shop: document.getElementById('shop').value.toLowerCase().trim(), password: document.getElementById('pass').value, name: document.getElementById('name').value, isDriver: role === 'driver' };
            if(auth.password !== "1234") return alert("Λάθος κωδικός");
            localStorage.setItem('roasters_auth', JSON.stringify(auth));
            socket.emit('login', auth);
            showUI();
        }

        function checkAuth() {
            const saved = localStorage.getItem('roasters_auth');
            if(saved) { 
                auth = JSON.parse(saved); 
                socket.emit('login', auth); 
                showUI(); 
            } else { 
                document.getElementById('login-screen').classList.remove('hidden'); 
            }
        }

        function showUI() {
            document.getElementById('login-screen').classList.add('hidden');
            if(auth.isDriver) {
                document.getElementById('driver-ui').classList.remove('hidden');
                document.getElementById('d-name').innerText = auth.name.toUpperCase();
            } else { window.location.href = "shop.html"; }
        }

        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>