<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BellGo Setup</title>
    
    <style>
        /* Î¤ÎŸ CSS Î ÎŸÎ¥ Î•Î”Î©Î£Î•Î£ + Î Î¡ÎŸÎ£Î˜Î—ÎšÎ•Î£ Î“Î™Î‘ INPUTS */
        body { background-color: #121212; color: #fff; font-family: sans-serif; text-align: center; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* ÎŸÎ˜ÎŸÎÎ•Î£ */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s ease-in; }
        .active { display: flex; }

        /* INPUTS (Î¤Î‘ ÎšÎŸÎ¥Î¤Î‘ÎšÎ™Î‘ Î ÎŸÎ¥ Î“Î¡Î‘Î¦Î•Î™Î£) */
        input {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 15px;
            font-size: 22px;
            width: 80%;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            outline: none;
        }
        input:focus { border-color: #00E676; }

        /* ÎšÎŸÎ¥ÎœÎ Î™Î‘ */
        button { width: 90%; padding: 20px; font-size: 20px; margin: 10px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; color: white; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        
        .btn-pompos { background-color: #00C853; color: black; } /* Î ÏÎ¬ÏƒÎ¹Î½Î¿ Î³Î¹Î± Admin */
        .btn-dekths { background-color: #2962FF; } /* ÎœÏ€Î»Îµ Î³Î¹Î± Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï…Ï‚ */
        .btn-driver { background-color: #FF6D00; color: black; } /* Î Î¿ÏÏ„Î¿ÎºÎ±Î»Î¯ Î³Î¹Î± Î”Î¹Î±Î½Î¿Î¼ÎµÎ¯Ï‚ */
        .btn-next { background-color: #444; border: 1px solid white; margin-top: 20px;}

        /* ÎšÎ•Î™ÎœÎ•ÎÎ‘ */
        h1 { color: #00E676; margin-bottom: 10px; }
        h2 { color: #ccc; margin-bottom: 30px; font-weight: normal; }

        /* ALARM OVERLAY */
        #alarmScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: red; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; animation: flash 0.5s infinite; }
        @keyframes flash { 0% { background: red; } 50% { background: #500; } 100% { background: red; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stop-btn { width: 250px; height: 250px; border-radius: 50%; background: white; color: red; font-size: 40px; font-weight: 900; border: 10px solid yellow; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        .status-log { font-size: 12px; color: #555; position: fixed; bottom: 10px; width: 100%; }
    </style>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
</head>
<body>

    <div id="step1" class="screen active">
        <h1>ğŸ” Î’Î®Î¼Î± 1/4</h1>
        <h2>ÎŒÎ½Î¿Î¼Î± Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚</h2>
        <input type="text" id="storeNameInput" placeholder="Ï€.Ï‡. CoffeeIsland1">
        <button class="btn-next" onclick="goToStep(2)">Î•Î ÎŸÎœÎ•ÎÎŸ âœ</button>
    </div>

    <div id="step2" class="screen">
        <h1>ğŸ‘¤ Î’Î®Î¼Î± 2/4</h1>
        <h2>Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…</h2>
        <input type="text" id="usernameInput" placeholder="Ï€.Ï‡. Î“Î¹ÏÏÎ³Î¿Ï‚">
        <button class="btn-next" onclick="goToStep(3)">Î•Î ÎŸÎœÎ•ÎÎŸ âœ</button>
    </div>

    <div id="step3" class="screen">
        <h1>ğŸ‘” Î’Î®Î¼Î± 3/4</h1>
        <h2>Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¡ÏŒÎ»Î¿</h2>
        <button class="btn-pompos" onclick="selectRole('admin')">Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î¤Î—Î£ (Î ÎŸÎœÎ ÎŸÎ£)</button>
        <button class="btn-dekths" onclick="selectRole('waiter')">Î£Î•Î¡Î’Î™Î¤ÎŸÎ¡ÎŸÎ£ (Î”Î•ÎšÎ¤Î—Î£)</button>
        <button class="btn-driver" onclick="selectRole('driver')">Î”Î™Î‘ÎÎŸÎœÎ•Î‘Î£ (Î”Î•ÎšÎ¤Î—Î£)</button>
    </div>

    <div id="step4" class="screen">
        <h1>ğŸ”‘ Î’Î®Î¼Î± 4/4</h1>
        <h2>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î‘ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚</h2>
        <input type="password" id="passwordInput" placeholder="****">
        <button class="btn-pompos" onclick="finishSetup()">Î£Î¥ÎÎ”Î•Î£Î— âœ…</button>
    </div>

    <div id="mainApp" class="screen">
        <h1 id="displayStore" style="font-size: 20px; color: #666;">...</h1>
        <h2 id="displayUser" style="color: white; font-size: 30px; font-weight: bold;">...</h2>
        
        <div id="adminPanel" style="display:none; width: 100%;">
            <button class="btn-pompos" style="height: 200px; font-size: 40px;" onclick="triggerAlarm()">ğŸ”” ÎšÎ›Î—Î£Î— ğŸ””</button>
        </div>

        <div id="staffPanel" style="display:none;">
            <p style="color: #00E676; font-size: 20px;">ğŸŸ¢ ONLINE - Î‘ÎÎ‘ÎœÎŸÎÎ—...</p>
            <p style="font-size: 14px; color: #555;">ÎœÎ·Î½ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹Ï‚ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.</p>
        </div>

        <div class="status-log" id="statusLog">Î‘Î½Î±Î¼Î¿Î½Î®...</div>
    </div>

    <div id="alarmScreen">
        <h1 style="color:white; font-size: 50px;">ğŸš¨ ÎšÎ›Î—Î£Î—!</h1>
        <h2 id="callerName" style="color:yellow;">Î‘Î ÎŸ ÎšÎŸÎ¥Î–Î™ÎÎ‘</h2>
        <button class="stop-btn" onclick="stopAlarm()">STOP</button>
    </div>

    <audio id="siren" src="alert.mp3" loop></audio>
    <audio id="silence" loop>
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA//oeAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAP//AAAAAAAAAAAA//oeBkAAAAAAABIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq//oeBkAAACQAABIAAAAAAAAEgAAAAAAAAAAAAAAqr///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////AAA=" type="audio/mpeg">
    </audio>

    <script>
        const socket = io();
        let isFully = typeof fully !== 'undefined';
        let messaging = null;
        let myToken = null;

        // ÎœÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚ Î§ÏÎ®ÏƒÏ„Î·
        let userConfig = {
            store: "",
            name: "",
            role: "",
            password: ""
        };

        // --- FIREBASE (Î“Î™Î‘ CHROME) ---
        if (!isFully) {
            const firebaseConfig = {
                apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8",
                authDomain: "bellgo-5dbe5.firebaseapp.com",
                projectId: "bellgo-5dbe5",
                storageBucket: "bellgo-5dbe5.firebasestorage.app",
                messagingSenderId: "799314495253",
                appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c",
                measurementId: "G-379ETZJP8H"
            };
            try {
                firebase.initializeApp(firebaseConfig);
                messaging = firebase.messaging();
            } catch(e) { console.log("Firebase skipped."); }
        }

        // --- NAVIGATION STEPS ---
        function goToStep(stepNum) {
            // Validate Inputs
            if (stepNum === 2 && document.getElementById('storeNameInput').value.trim() === "") {
                alert("Î“ÏÎ¬ÏˆÎµ ÏŒÎ½Î¿Î¼Î± Î¼Î±Î³Î±Î¶Î¹Î¿Ï!"); return;
            }
            if (stepNum === 3 && document.getElementById('usernameInput').value.trim() === "") {
                alert("Î“ÏÎ¬ÏˆÎµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…!"); return;
            }

            // Hide all screens
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            // Show target screen
            document.getElementById('step' + stepNum).classList.add('active');
        }

        function selectRole(role) {
            userConfig.role = role;
            goToStep(4);
        }

        async function finishSetup() {
            // Î£Ï…Î»Î»Î¿Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
            userConfig.store = document.getElementById('storeNameInput').value.trim();
            userConfig.name = document.getElementById('usernameInput').value.trim();
            userConfig.password = document.getElementById('passwordInput').value.trim();

            if (userConfig.password === "") {
                alert("Î’Î¬Î»Îµ ÎºÏ‰Î´Î¹ÎºÏŒ!"); return;
            }

            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎšÏÏÎ¹Î±Ï‚ ÎŸÎ¸ÏŒÎ½Î·Ï‚
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('mainApp').classList.add('active');

            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· UI
            document.getElementById('displayStore').innerText = "ğŸ¢ " + userConfig.store;
            document.getElementById('displayUser').innerText = userConfig.name;

            // Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Î‘Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î¿ Î¡ÏŒÎ»Î¿
            if (userConfig.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
            } else {
                document.getElementById('staffPanel').style.display = 'block';
                // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Staff (Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚/Î”Î¹Î±Î½Î¿Î¼Î­Î±Ï‚), Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ Î½Î± Ï€Î¬ÏÎµÎ¹Ï‚ Token
                await getFirebaseToken();
            }

            // ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î‰Ï‡Î¿Ï… (Î‘Î¸ÏŒÏÏ…Î²Î¿)
            document.getElementById('silence').play().catch(e => console.log("Audio lock:", e));

            // FULLY KIOSK SETUP
            if (isFully) {
                fully.setBooleanSetting("keepScreenOn", true);
                fully.setBooleanSetting("unlockScreen", true);
                document.getElementById('statusLog').innerText = "Mode: Fully Kiosk ğŸ¤–";
            } else {
                document.getElementById('statusLog').innerText = "Mode: Web Browser ğŸŒ";
            }

            // Î£Î¥ÎÎ”Î•Î£Î— ÎœÎ• SERVER
            socket.emit('join-store', {
                storeName: userConfig.store,
                username: userConfig.name,
                role: userConfig.role,
                password: userConfig.password, // Î¤Î¿ ÏƒÏ„Î­Î»Î½Î¿Ï…Î¼Îµ Î³Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿ (Î±Î½ Ï„Î¿ Î²Î¬Î»Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ Î¼Î­Î»Î»Î¿Î½)
                fcmToken: myToken,
                device: isFully ? 'fully' : 'chrome'
            });
        }

        async function getFirebaseToken() {
            if (!isFully && messaging) {
                try {
                    document.getElementById('statusLog').innerText = "Î–Î·Ï„Î¬Ï‰ Token...";
                    myToken = await messaging.getToken();
                    console.log("Token:", myToken);
                    document.getElementById('statusLog').innerText = "âœ… Token OK";
                } catch(e) { 
                    console.log("Token failed"); 
                    document.getElementById('statusLog').innerText = "âš ï¸ No Token (Check Permissions)";
                }
            }
        }

        // --- ALARM LOGIC ---
        function triggerAlarm() {
            socket.emit('trigger-alarm');
        }

        socket.on('ring-bell', () => {
            console.log("âš¡ ALARM!");
            
            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ·
            document.getElementById('alarmScreen').style.display = 'flex';
            
            // Î‰Ï‡Î¿Ï‚
            const audio = document.getElementById('siren');
            audio.currentTime = 0;
            audio.play();

            // Fully Kiosk Wake Up
            if (isFully) {
                fully.turnScreenOn();
                fully.bringToForeground();
                fully.setMusicVolume(100);
            }
        });

        function stopAlarm() {
            document.getElementById('alarmScreen').style.display = 'none';
            document.getElementById('siren').pause();
            if (isFully) fully.turnScreenOff();
        }

    </script>
</body>
</html>
