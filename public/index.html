<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Ultimate</title>
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/190/190411.png">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        /* CSS STYLES */
        body { background-color: #121212; color: #fff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; text-align: center; margin: 0; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; -webkit-tap-highlight-color: transparent; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .active { display: flex !important; }
        
        h1 { margin-bottom: 20px; font-size: 30px; letter-spacing: 2px; }

        button { padding: 20px; font-size: 18px; margin: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; color: white; width: 85%; transition: 0.1s; -webkit-appearance: none; }
        button:active { transform: scale(0.95); opacity: 0.8; }

        .btn-setup { background: #333; color: #FF6D00; border: 1px solid #FF6D00; font-size: 14px; padding: 10px; width: auto; }
        .btn-pompos { background: #FF3D00; color: white; height: 80px; font-size: 22px; }
        .btn-dekths { background: #2962FF; color: white; height: 80px; font-size: 22px; }
        .btn-fake { background: #333; border: 1px solid #555; }
        
        .btn-apk { 
            background: linear-gradient(45deg, #00C853, #00E676); 
            color: black; 
            text-decoration: none; 
            padding: 15px; 
            border-radius: 10px; 
            font-weight: bold; 
            display: inline-block; 
            margin-bottom: 30px; 
            width: 80%;
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.3);
        }

        /* ALARM OVERLAY */
        #alarmOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: red; z-index: 9999999; flex-direction: column; align-items: center; justify-content: center; animation: flash 0.3s infinite; }
        @keyframes flash { 0% { background: #ff0000; } 50% { background: #000000; } 100% { background: #ff0000; } }
        
        .stop-btn { width: 250px; height: 250px; border-radius: 50%; background: white; color: red; font-size: 40px; font-weight: 900; border: 10px solid yellow; animation: pulse 0.5s infinite; box-shadow: 0 0 50px rgba(255,255,255,0.8); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #fakeLockScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 8888; flex-direction: column; align-items: center; justify-content: center; color: #333; }

        /* STATUS CLASSES FOR ADMIN BUTTON */
        .admin-accepted { background: #00E676 !important; color: black !important; border: 2px solid white; }
        .admin-calling { background: #FFD600 !important; color: black !important; animation: pulse 1s infinite; }
    </style>
</head>
<body>

    <div style="position:absolute; top:0; left:0; width:1px; height:1px; opacity:0.1; overflow:hidden;">
        <audio id="alertSound" src="alert.mp3" loop playsinline></audio>
        <audio id="silenceSound" src="silence.mp3" loop playsinline></audio>
    </div>

    <div id="loginScreen" class="screen active">
        <h1>BELLGO</h1>
        
        <a href="https://github.com/theroasters84-wq/bellgo-final/releases/download/v1.0.0/app-release.apk" class="btn-apk">
            ğŸ“² Download App (v1.0)
        </a>

        <div style="height: 20px;"></div>

        <button class="btn-pompos" onclick="startApp('admin')">Î•Î™ÎœÎ‘Î™ Î ÎŸÎœÎ ÎŸÎ£<br><span style="font-size:14px">(ÎšÎ¿Ï…Î¶Î¯Î½Î±/Admin)</span></button>
        <button class="btn-dekths" onclick="startApp('staff')">Î•Î™ÎœÎ‘Î™ Î”Î•ÎšÎ¤Î—Î£<br><span style="font-size:14px">(Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚/Î”Î¹Î±Î½Î¿Î¼Î­Î±Ï‚)</span></button>
    </div>

    <div id="pomposScreen" class="screen">
        <h1>Î ÎŸÎœÎ ÎŸÎ£</h1>
        <button id="btnCall" class="btn-pompos" onclick="triggerAlarm()">ğŸ”” ÎšÎ›Î—Î£Î—</button>
        <p id="statusMsg" style="color:#aaa; margin-top:20px;">Ready</p>
        <button class="btn-fake" onclick="location.reload()" style="margin-top:50px; width:50%;">Î•ÎÎŸÎ”ÎŸÎ£</button>
    </div>

    <div id="dekthsScreen" class="screen">
        <h1>Î”Î•ÎšÎ¤Î—Î£</h1>
        <h2 style="color:#00C853; border: 1px solid #00C853; padding: 10px; border-radius: 8px;">â— ONLINE</h2>
        <div style="margin-top: 40px;">
            <button class="btn-fake" onclick="enableFakeLock()">ğŸŒ™ FAKE LOCK (Black Screen)</button>
        </div>
        <p style="font-size:12px; color:#666; margin-top:20px;">*ÎœÎ·Î½ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹Ï‚ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.</p>
        <button class="btn-fake" onclick="location.reload()" style="margin-top:20px; width:50%;">Î•ÎÎŸÎ”ÎŸÎ£</button>
    </div>

    <div id="fakeLockScreen" onclick="disableFakeLock()">
        <p>Double Tap to Unlock</p>
    </div>

    <div id="alarmOverlay">
        <h1>ğŸš¨ ÎšÎ›Î—Î£Î—!</h1>
        <button class="stop-btn" onclick="stopAlarm()">STOP</button>
    </div>

    <script>
        const socket = io();
        let myFcmToken = null;
        let wakeLock = null;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8",
            authDomain: "bellgo-5dbe5.firebaseapp.com",
            projectId: "bellgo-5dbe5",
            storageBucket: "bellgo-5dbe5.firebasestorage.app",
            messagingSenderId: "799314495253",
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c",
            measurementId: "G-379ETZJP8H"
        };
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // --- AUDIO ENGINE ---
        const AudioEngine = {
            alert: document.getElementById('alertSound'),
            silence: document.getElementById('silenceSound'),
            
            playSilence() {
                this.alert.pause();
                this.alert.currentTime = 0;
                this.silence.volume = 0.1;
                this.silence.play().catch(e => console.log("User interaction needed"));
            },
            
            playAlert() {
                this.silence.pause();
                this.alert.volume = 1.0;
                this.alert.play().catch(e => console.error(e));
                if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
            }
        };

        // --- APP LOGIC ---
        async function startApp(role) {
            // Î–Î·Ï„Î¬Î¼Îµ Full Screen ÎºÎ±Î¹ Wakelock
            try {
                if(role === 'staff' && 'wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch(e) {}

            // Firebase Token (Î¼ÏŒÎ½Î¿ Î³Î¹Î± staff)
            if (role === 'staff') {
                try {
                    const token = await messaging.getToken();
                    if(token) myFcmToken = token;
                    console.log("Token:", token);
                } catch(e) { console.log("Token Error", e); }
                
                // ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î¿Î½ ÏƒÎ¹Ï‰Ï€Î·Î»ÏŒ Î®Ï‡Î¿ Î³Î¹Î± Î½Î± Î¼Î­Î½ÎµÎ¹ Î¾ÏÏ€Î½Î¹Î¿ Ï„Î¿ Android
                AudioEngine.playSilence();
            }

            // Î£ÏÎ½Î´ÎµÏƒÎ· Socket
            socket.emit('join-store', { 
                storeName: 'General', 
                username: role, 
                role: role,
                fcmToken: myFcmToken 
            });

            // Î‘Î»Î»Î±Î³Î® ÎŸÎ¸ÏŒÎ½Î·Ï‚
            document.getElementById('loginScreen').classList.remove('active');
            if (role === 'admin') document.getElementById('pomposScreen').classList.add('active');
            else document.getElementById('dekthsScreen').classList.add('active');

            // Setup Media Session Buttons (Î³Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿ Î±Ï€ÏŒ Lock Screen)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({ title: 'BellGo Active', artist: 'Waiting for calls...' });
                navigator.mediaSession.setActionHandler('play', stopAlarm);
                navigator.mediaSession.setActionHandler('pause', stopAlarm);
                navigator.mediaSession.setActionHandler('stop', stopAlarm);
            }
        }

        // --- ALARM SENDING (ADMIN) ---
        function triggerAlarm() {
            socket.emit('trigger-alarm');
            const btn = document.getElementById('btnCall');
            btn.innerHTML = "â³ ÎšÎ‘Î›Î•Î™...";
            btn.classList.add('admin-calling');
        }

        // --- ALARM RECEIVING (STAFF & FEEDBACK) ---
        socket.on('ring-bell', () => {
            document.getElementById('alarmOverlay').style.display = 'flex';
            AudioEngine.playAlert();
        });

        socket.on('kitchen-alarm', () => {
            // Î“Î¹Î± ÏƒÏ…Î¼Î²Î±Ï„ÏŒÏ„Î·Ï„Î± Î¼Îµ Ï„Î¿Î½ server ÎºÏÎ´Î¹ÎºÎ± Î±Î½ ÏƒÏ„Î­Î»Î½ÎµÎ¹ Î±Ï…Ï„ÏŒ Ï„Î¿ event
            document.getElementById('alarmOverlay').style.display = 'flex';
            AudioEngine.playAlert();
        });

        // --- FEEDBACK Î‘Î ÎŸÎ”ÎŸÎ§Î—Î£ (ADMIN) ---
        socket.on('alarm-receipt', (data) => {
            // Î‘Ï…Ï„ÏŒ Ï„ÏÎ­Ï‡ÎµÎ¹ ÏƒÏ„Î¿Î½ ADMIN ÏŒÏ„Î±Î½ Î¿ staff Ï€Î±Ï„Î®ÏƒÎµÎ¹ STOP
            const btn = document.getElementById('btnCall');
            btn.classList.remove('admin-calling');
            btn.classList.add('admin-accepted');
            btn.innerHTML = "âœ… Î— ÎšÎ›Î—Î£Î— Î‘Î ÎŸÎ”Î•ÎšÎ¤Î—ÎšÎ•";
            document.getElementById('statusMsg').innerText = `Î‘Ï€Î¿Î´Î¿Ï‡Î® Î±Ï€ÏŒ: ${data.name || 'Staff'}`;

            // Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 5 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
            setTimeout(() => {
                btn.classList.remove('admin-accepted');
                btn.innerHTML = "ğŸ”” ÎšÎ›Î—Î£Î—";
                document.getElementById('statusMsg').innerText = "Ready";
            }, 5000);
        });

        // --- STOPPING ALARM (STAFF) ---
        function stopAlarm() {
            // 1. Î¤Î¿Ï€Î¹ÎºÏŒ Î£Ï„Î±Î¼Î¬Ï„Î·Î¼Î±
            document.getElementById('alarmOverlay').style.display = 'none';
            AudioEngine.playSilence(); // Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ silence loop

            // 2. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Server (Î— Î”Î™ÎŸÎ¡Î˜Î©Î£Î—)
            // Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ Ï€Î¿Î»Î»Î­Ï‚ Ï†Î¿ÏÎ­Ï‚ Î³Î¹Î± ÏƒÎ¹Î³Î¿Ï…ÏÎ¹Î¬ ÏƒÏ„Î¿ Android
            socket.emit('alarm-ack');
            setTimeout(() => socket.emit('alarm-ack'), 200);
            setTimeout(() => socket.emit('alarm-ack'), 500);
        }

        // --- UTILS ---
        function enableFakeLock() {
            document.getElementById('fakeLockScreen').style.display = 'flex';
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        }
        function disableFakeLock() {
            document.getElementById('fakeLockScreen').style.display = 'none';
            if(document.exitFullscreen) document.exitFullscreen();
        }

        // Heartbeat Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ Ï„Î¿ socket
        setInterval(() => {
            if(socket.connected) socket.emit('heartbeat');
        }, 5000);

    </script>
</body>
</html>
