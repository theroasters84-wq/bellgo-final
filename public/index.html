<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Ultimate</title>
    <style>
        /* --- CSS STYLES --- */
        body { background-color: #121212; color: #ffffff; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        /* Buttons */
        .btn { padding: 20px; font-size: 20px; border: none; border-radius: 12px; margin: 10px; cursor: pointer; width: 85%; max-width: 350px; font-weight: bold; touch-action: manipulation; box-shadow: 0 4px 6px rgba(0,0,0,0.3); color: white; transition: transform 0.1s; z-index: 10; }
        .btn:active { transform: scale(0.96); }
        .btn-sender { background-color: #00C853; }
        .btn-receiver { background-color: #2962FF; }
        .btn-pip { background-color: #9C27B0; font-size: 16px; margin-top: 20px; }
        .btn-fake-lock { background-color: #424242; color: #aaa; font-size: 14px; margin-top: 10px; width: auto; padding: 10px 20px; }
        .btn-stop { background-color: #D50000; display: none; margin-top: 30px; animation: pulse 0.8s infinite; font-size: 24px; padding: 30px; z-index: 20; }
        .btn-logout { position: absolute; top: 15px; right: 15px; background: transparent; color: #666; border: 1px solid #444; padding: 5px 10px; font-size: 12px; border-radius: 5px; z-index: 20; }

        /* Screens */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 50px; /* Î§ÏÏÎ¿Ï‚ Î³Î¹Î± Î½Î± Î¼Î·Î½ Ï€Î±Ï„Î¬Î¼Îµ Ï„Î·Î½ Ï€Î±Î³Î¯Î´Î± ÎºÎ±Ï„Î¬ Î»Î¬Î¸Î¿Ï‚ */ }
        #setupScreen { display: flex; }

        /* Fake Lock Overlay */
        #fakeLockOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: black; z-index: 9000; }
        #fakeLockText { position: absolute; bottom: 50px; width: 100%; text-align: center; color: #333; font-size: 12px; }

        /* Animations */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .alarm-active { background-color: #ff0000 !important; }
        .strobe { animation: strobe-anim 0.2s infinite; }
        @keyframes strobe-anim { 0% { background-color: red; } 50% { background-color: white; } 100% { background-color: red; } }

        /* Hidden Elements for PiP */
        #pipVideo { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }

        /* --- INVISIBLE TRAPS (ÎŸÎ¹ Î Î±Î³Î¯Î´ÎµÏ‚) --- */
        .trap-zone {
            position: fixed;
            z-index: 99999; /* Î Î¬Î½Ï‰ Î±Ï€ÏŒ ÏŒÎ»Î± */
            background-color: transparent; /* Î‘ÏŒÏÎ±Ï„Î¿ */
            /* background-color: rgba(255, 0, 0, 0.3); ÎÎµ-ÏƒÏ‡Î¿Î»Î¯Î±ÏƒÎµ Î³Î¹Î± Î´Î¿ÎºÎ¹Î¼Î® */
        }
        .trap-bottom { bottom: 0; left: 0; width: 100%; height: 25px; } /* Swipe Up trap */
        .trap-right { top: 0; right: 0; width: 15px; height: 100%; } /* Back Swipe trap */
    </style>
</head>
<body>

    <div id="setupScreen" class="screen">
        <h2 style="margin-bottom: 40px;">BellGo Ultimate</h2>
        <button class="btn btn-sender" onclick="initMode('sender')">ğŸ”” Î ÎŸÎœÎ ÎŸÎ£ (Waiter)</button>
        <button class="btn btn-receiver" onclick="initMode('receiver')">ğŸ‘‚ Î”Î•ÎšÎ¤Î—Î£ (Kitchen)</button>
        <p style="color: #444; margin-top: 40px; font-size: 12px;">v4.0 Trap & Media Hacks</p>
    </div>

    <div id="senderScreen" class="screen">
        <button class="btn-logout" onclick="location.reload()">Exit</button>
        <h1>Î ÎŸÎœÎ ÎŸÎ£</h1>
        <button class="btn btn-sender" id="triggerBtn" onclick="sendAlert()">ğŸ”” ÎšÎ›Î—Î£Î—</button>
        <p id="senderStatus" style="color: #888; margin-top: 20px;">ÎˆÏ„Î¿Î¹Î¼Î¿</p>
    </div>

    <div id="receiverScreen" class="screen">
        <button class="btn-logout" onclick="location.reload()">Exit</button>
        <h1>Î”Î•ÎšÎ¤Î—Î£</h1>
        
        <div style="font-size: 60px; margin: 10px;">ğŸ‘‚</div>
        <p id="statusText" style="color: #aaa;">Î‘Î½Î±Î¼Î¿Î½Î®...</p>

        <button class="btn btn-pip" onclick="togglePiP()">ğŸ“º BACKGROUND MODE (Manual)</button>
        <button class="btn btn-fake-lock" onclick="toggleFakeLock(true)">ğŸ”’ Black Screen</button>

        <button class="btn btn-stop" id="stopBtn" onclick="stopAlarm()">ğŸ”• STOP ALARM</button>
    </div>

    <div id="trapBottom" class="trap-zone trap-bottom" ontouchstart="tryAutoPiP()"></div>
    <div id="trapRight" class="trap-zone trap-right" ontouchstart="tryAutoPiP()"></div>

    <div id="fakeLockOverlay" onclick="toggleFakeLock(false)">
        <div id="fakeLockText">Double tap to unlock</div>
    </div>

    <audio id="silencePlayer" loop playsinline>
        <source src="silence.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="alertPlayer" preload="auto" loop playsinline>
        <source src="alert.mp3" type="audio/mpeg">
    </audio>

    <canvas id="canvas" width="100" height="100" style="display:none;"></canvas>
    <video id="pipVideo" muted playsinline></video>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        let wakeLock = null;
        let heartbeatInterval = null;
        let vibrationInterval = null;

        // --- 1. VIBRATION LOGIC ---
        function startVibration() {
            if (navigator.vibrate) {
                if (vibrationInterval) clearInterval(vibrationInterval);
                const pattern = [500, 200, 500, 1000];
                navigator.vibrate(pattern);
                const totalDuration = pattern.reduce((a, b) => a + b, 0);
                vibrationInterval = setInterval(() => {
                    navigator.vibrate(pattern);
                }, totalDuration);
            }
        }

        function stopVibration() {
            if (vibrationInterval) clearInterval(vibrationInterval);
            if (navigator.vibrate) navigator.vibrate(0);
        }

        // --- 2. PiP & TRAP HACK ---
        const canvas = document.getElementById('canvas');
        const video = document.getElementById('pipVideo');
        const ctx = canvas.getContext('2d');
        let pipColorToggle = false;

        // Î–Ï‰Î³ÏÎ±Ï†Î¯Î¶Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ canvas Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ Î¶Ï‰Î½Ï„Î±Î½ÏŒ
        ctx.fillStyle = 'green';
        ctx.fillRect(0, 0, 100, 100);
        const stream = canvas.captureStream(10);
        video.srcObject = stream;

        setInterval(() => {
            pipColorToggle = !pipColorToggle;
            ctx.fillStyle = pipColorToggle ? '#00C853' : '#2962FF';
            ctx.fillRect(0, 0, 100, 100);
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText("LIVE", 20, 55);
        }, 1000);

        async function togglePiP() {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await video.play();
                    await video.requestPictureInPicture();
                }
            } catch (error) {
                console.log("PiP Error:", error);
            }
        }

        // Î— ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… ÎºÎ±Î»ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¹Ï‚ "Î Î±Î³Î¯Î´ÎµÏ‚"
        function tryAutoPiP() {
            if (!document.pictureInPictureElement) {
                console.log("Trap Triggered! Attempting Auto-PiP...");
                video.play().then(() => {
                    video.requestPictureInPicture().catch(e => console.log("Auto-PiP blocked"));
                }).catch(e => console.log("Video not ready"));
            }
        }

        // --- 3. MEDIA SESSION (Control from Lock Screen) ---
        function setupAdvancedBackground() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'ğŸš¨ ÎšÎ›Î—Î£Î— Î‘Î ÎŸ ÎšÎŸÎ¥Î–Î™ÎÎ‘',
                    artist: 'Î Î¬Ï„Î± PAUSE/NEXT Î³Î¹Î± Î‘Ï€Î¿Î´Î¿Ï‡Î®',
                    album: 'BellGo System',
                    artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/565/565422.png', sizes: '512x512', type: 'image/png' }]
                });

                // ÎŸÎ›Î‘ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ ÎºÎ¬Î½Î¿Ï…Î½ STOP
                const stopHandler = () => { console.log("Stopped from BG"); stopAlarm(); };
                
                navigator.mediaSession.setActionHandler('pause', stopHandler);
                navigator.mediaSession.setActionHandler('previoustrack', stopHandler);
                navigator.mediaSession.setActionHandler('nexttrack', stopHandler);
                navigator.mediaSession.setActionHandler('play', stopHandler);
            }

            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        // --- 4. ANTI-SLEEP & INIT ---
        async function enableAntiSleep() {
            const silence = document.getElementById('silencePlayer');
            silence.volume = 0.01;
            try { await silence.play(); } catch(e) {}

            try {
                if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen');
            } catch (e) {}

            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if (socket.connected) socket.emit('keep-alive');
            }, 30000);
        }

        function initMode(mode) {
            enableAntiSleep();
            setupAdvancedBackground();
            document.getElementById('setupScreen').style.display = 'none';
            
            if (mode === 'sender') {
                document.getElementById('senderScreen').style.display = 'flex';
            } else {
                document.getElementById('receiverScreen').style.display = 'flex';
                setupReceiverLogic();
            }
        }

        // --- 5. SENDER ---
        function sendAlert() {
            const btn = document.getElementById('triggerBtn');
            btn.disabled = true;
            btn.innerText = "Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î—...";
            btn.style.opacity = "0.7";
            socket.emit('trigger-alarm');

            setTimeout(() => {
                btn.disabled = false;
                btn.innerText = "ğŸ”” ÎšÎ›Î—Î£Î—";
                btn.style.opacity = "1";
                document.getElementById('senderStatus').innerText = "Î£Ï„Î¬Î»Î¸Î·ÎºÎµ: " + new Date().toLocaleTimeString();
            }, 1000);
        }

        // --- 6. RECEIVER ---
        function setupReceiverLogic() {
            socket.on('ring-bell', () => {
                console.log("ALARM RECEIVED!");
                
                toggleFakeLock(false); // ÎÏÏ€Î½Î± Î¿Î¸ÏŒÎ½Î·

                const alertPlayer = document.getElementById('alertPlayer');
                alertPlayer.currentTime = 0;
                alertPlayer.volume = 1.0;
                
                // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Media Session ÏŒÏ„Î¹ Ï€Î±Î¯Î¶Î¿Ï…Î¼Îµ
                if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
                
                alertPlayer.play().catch(e => console.log("Interaction needed"));

                document.body.classList.add('alarm-active');
                document.body.classList.add('strobe');
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('statusText').innerText = "ğŸš¨ ÎšÎ›Î—Î£Î— Î£Î• Î•ÎÎ•Î›Î™ÎÎ— ğŸš¨";

                startVibration();

                if (document.hidden && Notification.permission === "granted") {
                    new Notification("ğŸš¨ ÎšÎŸÎ¥Î”ÎŸÎ¥ÎÎ™!", { body: "Î Î¬Ï„Î± Î³Î¹Î± Î¬Î½Î¿Î¹Î³Î¼Î±", tag: 'alarm' });
                }
            });
        }

        function stopAlarm() {
            const alertPlayer = document.getElementById('alertPlayer');
            alertPlayer.pause();
            alertPlayer.currentTime = 0;
            
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";

            stopVibration();
            
            document.body.classList.remove('alarm-active');
            document.body.classList.remove('strobe');
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('statusText').innerText = "Î‘Î½Î±Î¼Î¿Î½Î®...";
        }

        // --- 7. FAKE LOCK ---
        function toggleFakeLock(enable) {
            const overlay = document.getElementById('fakeLockOverlay');
            if (enable) {
                overlay.style.display = 'block';
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(e=>{});
            } else {
                overlay.style.display = 'none';
                if (document.exitFullscreen && document.fullscreenElement) document.exitFullscreen().catch(e=>{});
            }
        }
    </script>
</body>
</html>
