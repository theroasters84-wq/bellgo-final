<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BellGo Ultra v35</title>
<link rel="manifest" href="manifest.json">

<script src="/socket.io/socket.io.js"></script>

<style>
/* --- Î¥Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎ± CSS --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
/* Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î· CSS Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î±, ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ ÏƒÎ¿Ï… index.html */
</style>
</head>
<body>

<!-- --- Login / Main App / Alarm Overlay / Info Modal --- -->
<!-- ÎŒÎ»Î± Î¯Î´Î¹Î± ÏŒÏ€Ï‰Ï‚ Ï€ÏÎ¹Î½, Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î­Ï‚ ÏƒÏ„Î¹Ï‚ Î´Î¿Î¼Î­Ï‚ HTML --- -->

<script src="player.js"></script>
<audio id="snd-silent" loop preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

const firebaseConfig = { 
    apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
    authDomain: "bellgo-5dbe5.firebaseapp.com", 
    projectId: "bellgo-5dbe5", 
    storageBucket: "bellgo-5dbe5.firebasestorage.app", 
    messagingSenderId: "799314495253", 
    appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c",
    measurementId: "G-379ETZJP8H"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const messaging = getMessaging(app);
const provider = new GoogleAuthProvider();

const SILENT_WAV = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABGDZGF0YQQAAAAAAA==";
const keepAliveAudio = document.getElementById('snd-silent');
keepAliveAudio.src = SILENT_WAV;
keepAliveAudio.volume = 0.01; 

let isAlarmActive = false; 
let activeAlarmId = null;

document.addEventListener('visibilitychange', () => {
    if (document.hidden && isAlarmActive) {
        console.log("âš ï¸ Screen off while alarm active -> Auto Accept");
        App.acceptAlarm();
    }
});

// --- Media Session Handler ---
if ('mediaSession' in navigator) {
    const handleMediaAction = () => {
        if (isAlarmActive) {
            if (navigator.vibrate) navigator.vibrate(50);
            App.acceptAlarm();
        }
    };
    ['play','pause','stop','nexttrack','previoustrack','seekbackward','seekforward'].forEach(action => {
        navigator.mediaSession.setActionHandler(action, handleMediaAction);
    });
}

keepAliveAudio.addEventListener('pause', () => {
    if (window.userData && window.userData.role === 'admin') return;
    if (!isAlarmActive) {
        console.log("â™»ï¸ Silent keeper interrupted -> restarting...");
        keepAliveAudio.play().catch(()=>{});
    }
});

// --- Notifications Setup ---
async function setupNotifications() {
    if ('serviceWorker' in navigator) {
        try {
            const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                const token = await getToken(messaging, { vapidKey: "BDUWH0UaYagUPXGB8BM59VFRBW8FMbgOy7YcbBHxT4aJ6rN0Jms-0dGWXIODGYWoSSHomos4gg1GOTZn6k70JcM", serviceWorkerRegistration: reg });
                if (token) {
                    localStorage.setItem('fcm_token', token);
                    if (window.socket && window.socket.connected) {
                        window.socket.emit('update-token', { username: userData.name, token });
                    }
                }
            }
        } catch(e) { console.log("FCM Error:", e); }
    }
    onMessage(messaging, () => App.triggerAlarmScreen());
}

// --- App Logic (login, socket, alarm handling) ---
window.socket = null;
window.userData = { store: '', name: '', role: '' };
let isFirstLogin = true;

window.App = {
    loginStaff: () => {
        const store = document.getElementById('inpStoreEmail').value.trim().toLowerCase();
        const name = document.getElementById('inpMyName').value.trim();
        const role = document.getElementById('inpMyRole').value;
        if (!store || !name) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€ÎµÎ´Î¯Î±!");
        App.completeLogin({ store, name, role });
    },

    loginAdminGoogle: () => {
        signInWithPopup(auth, provider).then((result) => {
            const user = result.user;
            App.completeLogin({ store: user.email.toLowerCase(), name: user.displayName || "Admin", role: 'admin' });
        }).catch((error) => alert("Error: " + error.message));
    },

    completeLogin: (user) => {
        userData = user;
        localStorage.setItem('bellgo_session', JSON.stringify(userData));
        if (userData.role !== 'admin') keepAliveAudio.play().catch(()=>{});
        setupNotifications(); 
        App.finishLoginSequence();
    },

    finishLoginSequence: () => {
        const loginScreen = document.getElementById('loginScreen');
        if(loginScreen) loginScreen.style.display = 'none';
        const mainApp = document.getElementById('mainApp');
        if(mainApp) mainApp.style.display = 'flex';
        const headerName = document.getElementById('headerName');
        if(headerName) headerName.innerText = userData.name;
        const headerStore = document.getElementById('headerStore');
        if(headerStore) headerStore.innerText = userData.store;

        if(userData.role === 'admin') document.getElementById('staffPanel').classList.add('active');
        else document.getElementById('infoBtn').style.display = 'flex';

        App.connectSocket();
        App.startHeartbeat();
        App.startLocationTracking();
    },

    triggerAlarmScreen: () => {
        isAlarmActive = true;
        activeAlarmId = Date.now();
        if (userData.role !== 'admin') keepAliveAudio.pause();

        const overlay = document.getElementById('alarmOverlay');
        if (overlay) overlay.style.display = 'flex';

        const timeBadge = document.getElementById('alarmTimeBadge');
        if (timeBadge) {
            const now = new Date();
            timeBadge.innerText = "ÎÏÎ±: " + now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
        }

        // Media metadata
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'ğŸš¨ ÎšÎ›Î—Î£Î— Î‘Î ÎŸ ÎšÎŸÎ¥Î–Î™ÎÎ‘',
                artist: 'BellGo Alert',
                album: 'Î Î±Ï„Î®ÏƒÏ„Îµ Pause/Next Î³Î¹Î± Î‘Ï€Î¿Î´Î¿Ï‡Î®',
                artwork: [{ src: 'icon.png', sizes: '512x512', type: 'image/png' }]
            });
        }
    },

    acceptAlarm: () => {
        isAlarmActive = false;
        activeAlarmId = null;

        if(window.AudioEngine) { AudioEngine.init(); AudioEngine.stopAlarm(true); }
        if (userData.role !== 'admin') keepAliveAudio.play().catch(()=>{});

        const overlay = document.getElementById('alarmOverlay');
        if (overlay) overlay.style.display = 'none';

        const sendAccept = () => {
            if(socket && socket.connected) socket.emit('alarm-accepted');
        };
        if (socket && socket.connected) sendAccept();
        else {
            socket.connect();
            socket.once('connect', sendAccept);
        }
    },

    startLocationTracking: () => {
        if ('geolocation' in navigator && (userData.role==='waiter'||userData.role==='driver')) {
            navigator.geolocation.watchPosition(
                pos => console.log("GPS Ping:", pos.coords.latitude),
                err => console.log("GPS Error:", err),
                { enableHighAccuracy:true, maximumAge:0, timeout:10000 }
            );
        }
    },

    connectSocket: () => {
        if (socket && socket.connected) return;
        socket = io({ transports:['polling','websocket'], reconnection:true });
        window.socket = socket;

        socket.on('connect', () => {
            const connDot = document.getElementById('connDot');
            if(connDot) connDot.style.background = '#00E676';
            socket.emit('join-store', { storeName: userData.store, username: userData.name, role: userData.role, token: localStorage.getItem('fcm_token') });
        });
        socket.on('disconnect', () => { const connDot = document.getElementById('connDot'); if(connDot) connDot.style.background='red'; });
        socket.on('ring-bell', () => App.triggerAlarmScreen());
    },

    forceReconnect: () => { if(socket){ socket.disconnect(); setTimeout(()=>socket.connect(),300); } },
    startHeartbeat: () => { setInterval(()=>{ if(socket && socket.connected) socket.emit('heartbeat'); },3000); },

    checkSession: () => {
        const saved = localStorage.getItem('bellgo_session');
        if(saved) {
            userData = JSON.parse(saved);
            setupNotifications();
            App.finishLoginSequence();
            if (userData.role !== 'admin') keepAliveAudio.play().catch(()=>{});
        }
    }
};

window.onload = () => App.checkSession();
</script>
</body>
</html>
