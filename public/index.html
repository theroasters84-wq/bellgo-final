<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
    <title>Bellgo Unified</title>
    <style>
        /* --- Î£Î¤Î¥Î› (ÎœÎ‘Î¥Î¡ÎŸ/ÎšÎ™Î¤Î¡Î™ÎÎŸ) --- */
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; text-align: center; user-select: none; }
        .hidden { display: none !important; }
        .screen { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        
        /* INPUTS & BUTTONS */
        input, select { width: 85%; padding: 15px; margin: 8px 0; background: #111; border: 1px solid #444; color: white; text-align: center; border-radius: 8px; font-size: 16px; }
        .btn { width: 90%; padding: 18px; margin: 10px 0; background: #ffc107; color: black; border: none; font-weight: bold; font-size: 18px; border-radius: 8px; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid #ffc107; color: #ffc107; }

        /* ADMIN LIST STYLES */
        #drivers-container { width: 100%; max-height: 40vh; overflow-y: auto; margin-bottom: 20px; border: 1px solid #333; padding: 10px; border-radius: 10px; }
        .driver-card { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; }
        .btn-call { background: #ff4444; color: white; border: none; padding: 10px 20px; font-weight: bold; border-radius: 5px; }
        .btn-call:active { background: red; transform: scale(0.95); }

        /* CHAT STYLES */
        #chat-ui { width: 100%; height: 35vh; display: flex; flex-direction: column; border: 1px solid #333; background: #0a0a0a; border-radius: 8px; margin-top: 10px; }
        #chat-msgs { flex: 1; overflow-y: auto; text-align: left; padding: 10px; font-size: 14px; }
        .msg { margin-bottom: 5px; padding: 5px; }
        .mine { color: #ffc107; text-align: right; }
        .theirs { color: #00ccff; text-align: left; }

        /* ALERT LAYER (RED SCREEN) */
        #alert-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: red; z-index: 9999; display: none; flex-direction: column; justify-content: center; animation: flash 0.5s infinite; }
        @keyframes flash { 50% { background: #900; } }

        /* FAKE LOCK */
        #fake-lock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <h1 style="color:#ffc107; letter-spacing: 2px;">BELLGO</h1>
        
        <input type="text" id="shop" placeholder="ÎŸÎÎŸÎœÎ‘ ÎœÎ‘Î“Î‘Î–Î™ÎŸÎ¥ (Ï€.Ï‡. Roasters)">
        <input type="password" id="pass" placeholder="ÎšÎ©Î”Î™ÎšÎŸÎ£ (1234)">
        <input type="text" id="name" placeholder="Î¤ÎŸ ÎŸÎÎŸÎœÎ‘ Î£ÎŸÎ¥">
        
        <p style="color:#888; margin-top:10px;">Î•Î Î™Î›ÎŸÎ“Î— Î¡ÎŸÎ›ÎŸÎ¥:</p>
        <select id="role-select">
            <option value="driver">ğŸ›µ Î”Î™Î‘ÎÎŸÎœÎ•Î‘Î£ / Î£Î•Î¡Î’Î™Î¤ÎŸÎ¡ÎŸÎ£</option>
            <option value="admin">ğŸ’» KATAÎ£Î¤Î—ÎœÎ‘ (ADMIN)</option>
        </select>

        <button class="btn" onclick="attemptLogin()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
    </div>

    <div id="driver-ui" class="screen hidden">
        <h2 id="d-label" style="color:#ffc107">DRIVER</h2>
        <span style="color:#0f0">â— ONLINE</span>

        <div id="chat-ui">
            <div id="chat-msgs"></div>
            <div style="display:flex; border-top:1px solid #333;">
                <input type="text" id="c-in" placeholder="ÎœÎ®Î½Ï…Î¼Î±..." style="border:none; margin:0; width:80%;">
                <button onclick="sendChat()" style="width:20%; background:#ffc107; border:none; font-weight:bold;">></button>
            </div>
        </div>

        <button class="btn btn-outline" onclick="toggleLock()">ğŸ”’ FAKE LOCK</button>
        <button onclick="logout()" style="background:none; border:none; color:#666; margin-top:20px;">Logout</button>
    </div>

    <div id="admin-ui" class="screen hidden">
        <h2 style="color:#ffc107">ADMIN PANEL</h2>
        <p style="color:#888" id="shop-label">SHOP</p>

        <div style="width:100%; text-align:left; color:#ffc107; margin-bottom:5px;">Î”Î¹Î±Î½Î¿Î¼ÎµÎ¯Ï‚ Online:</div>
        <div id="drivers-container">
            <p style="color:#666; text-align:center;">Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚...</p>
        </div>

        <div id="admin-chat-ui" style="width:100%; height: 25vh; border:1px solid #333; background:#111; display:flex; flex-direction:column;">
            <div id="admin-chat-msgs" style="flex:1; overflow-y:auto; padding:5px; text-align:left;"></div>
            <div style="display:flex;">
                <input type="text" id="a-in" placeholder="Chat..." style="flex:1; margin:0; border:none;">
                <button onclick="sendAdminChat()" style="background:#444; color:white; border:none; padding:10px;">Send</button>
            </div>
        </div>
        <button onclick="logout()" style="background:none; border:none; color:#666; margin-top:20px;">Logout</button>
    </div>

    <div id="alert-layer" onclick="acceptOrder()">
        <h1 style="font-size:3em; color:white">ÎšÎ›Î—Î£Î—!</h1>
        <p style="font-size:1.5em; color:white">Î Î‘Î¤Î‘ ÎšÎŸÎ¥ÎœÎ Î™</p>
    </div>
    <div id="fake-lock" onclick="toggleLock()"></div>
    <audio id="snd" src="alert.mp3" loop></audio>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const SERVER = 'https://bellgo-final.onrender.com';
        let socket, auth;
        const snd = document.getElementById('snd');
        const PushNotifications = (window.Capacitor && window.Capacitor.Plugins) ? window.Capacitor.Plugins.PushNotifications : null;

        function attemptLogin() {
            const s = document.getElementById('shop').value.trim();
            const p = document.getElementById('pass').value;
            const n = document.getElementById('name').value.trim();
            const r = document.getElementById('role-select').value;

            if(p !== "1234") return alert("Î›Î¬Î¸Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚");
            if(!s || !n) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€ÎµÎ´Î¯Î±");

            auth = { shop: s, name: n, role: r };
            localStorage.setItem('unified_auth', JSON.stringify(auth));
            
            initUI();
            connect();
        }

        function initUI() {
            document.getElementById('login-screen').classList.add('hidden');
            
            if(auth.role === 'driver') {
                document.getElementById('driver-ui').classList.remove('hidden');
                document.getElementById('d-label').innerText = auth.name.toUpperCase();
            } else {
                document.getElementById('admin-ui').classList.remove('hidden');
                document.getElementById('shop-label').innerText = auth.shop.toUpperCase();
            }
        }

        function connect() {
            socket = io(SERVER, { transports: ['websocket'] });

            socket.on('connect', () => {
                socket.emit('login', auth);
                if(auth.role === 'driver') {
                    setInterval(() => { if(socket.connected) socket.emit('heartbeat'); }, 25000);
                    if(PushNotifications) setupPush();
                }
            });

            // --- ADMIN LOGIC: Î•ÎÎ—ÎœÎ•Î¡Î©Î£Î— Î›Î™Î£Î¤Î‘Î£ ---
            socket.on('update-drivers-list', (drivers) => {
                if(auth.role !== 'admin') return; // ÎœÏŒÎ½Î¿ Î¿ admin Ï„Î¿ Î²Î»Î­Ï€ÎµÎ¹
                
                const list = document.getElementById('drivers-container');
                list.innerHTML = ""; 
                
                if(drivers.length === 0) {
                    list.innerHTML = "<p style='color:#666; text-align:center;'>ÎšÎ±Î½ÎµÎ¯Ï‚ Online</p>";
                    return;
                }

                drivers.forEach(d => {
                    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï Î³Î¹Î± ÎºÎ¬Î¸Îµ Î¿Î´Î·Î³ÏŒ
                    list.innerHTML += `
                        <div class="driver-card">
                            <span style="font-size:1.1em; color:white;">ğŸ›µ ${d.name}</span>
                            <button class="btn-call" onclick="callDriver('${d.id}')">ÎšÎ›Î—Î£Î— ğŸ””</button>
                        </div>`;
                });
            });

            // --- DRIVER LOGIC: Î›Î—Î¨Î— ÎšÎ›Î—Î£Î—Î£ ---
            socket.on('order-notification', () => {
                if(auth.role === 'driver') triggerAlert();
            });

            // --- CHAT LOGIC (KOINO) ---
            socket.on('chat-message', (data) => {
                // Î•Ï€Î¹Î»Î¿Î³Î® Ï„Î¿Ï… ÏƒÏ‰ÏƒÏ„Î¿Ï ÎºÎ¿Ï…Ï„Î¹Î¿Ï Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿
                const box = auth.role === 'driver' ? document.getElementById('chat-msgs') : document.getElementById('admin-chat-msgs');
                const isMe = data.user === auth.name;
                box.innerHTML += `<div class="msg ${isMe ? 'mine' : 'theirs'}"><b>${data.user}:</b> ${data.text}</div>`;
                box.scrollTop = box.scrollHeight;
            });
        }

        // Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ Admin
        function callDriver(targetId) {
            socket.emit('call-driver', targetId); // ÎšÎ±Î»ÎµÎ¯ ÎœÎŸÎÎŸ Î±Ï…Ï„ÏŒÎ½
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î¼Î·Î½ÏÎ¼Î±Ï„Î¿Ï‚ ÏƒÏ„Î¿ chat ÏŒÏ„Î¹ Î­Î³Î¹Î½Îµ ÎºÎ»Î®ÏƒÎ·
            // socket.emit('chat-message', { shop: auth.shop, user: 'SYSTEM', text: `ğŸ”” ÎšÎ»Î®ÏƒÎ· Ï€ÏÎ¿Ï‚ Î´Î¹Î±Î½Î¿Î¼Î­Î±...` });
        }

        function sendAdminChat() {
            const txt = document.getElementById('a-in').value;
            if(txt) {
                socket.emit('chat-message', { shop: auth.shop, user: auth.name, text: txt });
                document.getElementById('a-in').value = '';
            }
        }

        // Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ Driver
        function sendChat() {
            const txt = document.getElementById('c-in').value;
            if(txt) {
                socket.emit('chat-message', { shop: auth.shop, user: auth.name, text: txt });
                document.getElementById('c-in').value = '';
            }
        }

        function triggerAlert() {
            document.getElementById('alert-layer').style.display = 'flex';
            snd.play().catch(e=>{});
            if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
        }

        function acceptOrder() {
            document.getElementById('alert-layer').style.display = 'none';
            snd.pause(); snd.currentTime = 0;
            if(navigator.vibrate) navigator.vibrate(0);
            socket.emit('chat-message', { shop: auth.shop, user: 'SYSTEM', text: `âœ… ÎŸ/Î— ${auth.name} Î­Î»Î±Î²Îµ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ·!` });
        }

        // ÎšÎ¿Î¹Î½Î­Ï‚ Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚
        window.addEventListener('keydown', (e) => {
            if((e.key === "VolumeUp" || e.key === "VolumeDown") && document.getElementById('alert-layer').style.display === 'flex') {
                acceptOrder();
            }
        });

        function toggleLock() {
            const l = document.getElementById('fake-lock');
            l.style.display = l.style.display === 'block' ? 'none' : 'block';
        }

        function logout() { localStorage.clear(); location.reload(); }

        async function setupPush() {
            await PushNotifications.requestPermissions();
            await PushNotifications.register();
            PushNotifications.addListener('pushNotificationReceived', () => triggerAlert());
        }

        // Auto Login
        const saved = localStorage.getItem('unified_auth');
        if(saved) {
            auth = JSON.parse(saved);
            initUI();
            connect();
        }
    </script>
</body>
</html>
