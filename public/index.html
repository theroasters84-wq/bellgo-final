<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Unified</title>
    <link rel="manifest" href="manifest.json">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        /* --- GENERAL --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        
        /* --- LOGIN SCREEN --- */
        #loginScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: #121212; z-index: 100; position: absolute; top: 0; left: 0; }
        h1 { margin-bottom: 20px; color: #00E676; font-size: 32px; }
        
        .input-group { width: 85%; margin-bottom: 12px; }
        input, select { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; font-size: 18px; text-align: center; -webkit-appearance: none; }
        select { text-align-last: center; } /* Center text in select for Chrome */
        
        .btn-login { width: 85%; padding: 15px; font-size: 20px; font-weight: bold; background: #00E676; color: black; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; }
        
        /* --- MAIN APP --- */
        #mainApp { display: none; flex-direction: column; height: 100%; width: 100%; }
        
        /* Header */
        .header { height: 55px; background: #1e1e1e; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #333; }
        .status-dot { width: 12px; height: 12px; background: red; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 5px red; }
        .user-info { font-size: 14px; color: #ccc; }
        .btn-logout { background: #D32F2F; color: white; border: none; padding: 5px 15px; border-radius: 4px; font-weight: bold; }

        /* Content Area (Split View) */
        .content { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Staff List (Left) - Only visible to Admin usually, or full width if mobile logic demands */
        .staff-panel { flex: 1; background: #121212; overflow-y: auto; border-right: 1px solid #333; padding: 10px; display: none; /* Hidden by default until role check */ }
        .staff-panel.active { display: block; }

        .btn-staff { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 8px; font-size: 18px; color: white; text-align: left; position: relative; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .btn-staff:active { transform: scale(0.98); }
        .btn-staff.waiter { background: #1565C0; border-left: 5px solid #64B5F6; }
        .btn-staff.driver { background: #E65100; border-left: 5px solid #FFB74D; }
        .btn-staff span.status { font-size: 12px; opacity: 0.7; font-weight: normal; }

        /* Chat Panel (Right) */
        .chat-panel { flex: 1.5; display: flex; flex-direction: column; background: #0a0a0a; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 16px; word-wrap: break-word; position: relative; }
        .msg .sender-name { font-size: 11px; margin-bottom: 4px; display: block; opacity: 0.8; font-weight: bold; }
        
        /* Styles based on sender */
        .msg.me { align-self: flex-end; background: #00E676; color: black; border-bottom-right-radius: 2px; }
        .msg.me .sender-name { text-align: right; color: #004d26; }
        
        .msg.other { align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.waiter { background: #1565C0; color: white; }
        .msg.driver { background: #E65100; color: white; }
        .msg.admin { background: #D32F2F; color: white; border: 1px solid yellow; }

        /* Chat Input */
        .chat-input { display: flex; padding: 10px; background: #1e1e1e; border-top: 1px solid #333; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .chat-input input { border-radius: 20px; text-align: left; padding-left: 15px; }
        .chat-input button { width: 50px; margin-left: 10px; border-radius: 50%; background: #00E676; border: none; font-size: 20px; cursor: pointer; }

        /* --- ALARM OVERLAY --- */
        #alarmOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; background: red; animation: flashBg 0.5s infinite; }
        @keyframes flashBg { 0% { background: #D50000; } 50% { background: #000000; } 100% { background: #D50000; } }
        
        .stop-btn { width: 220px; height: 220px; border-radius: 50%; background: white; color: red; font-size: 40px; font-weight: 900; border: 8px solid yellow; box-shadow: 0 0 60px rgba(255,255,255,0.8); cursor: pointer; animation: pulseBtn 0.8s infinite; }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Test Mode Style (Blue instead of Red) */
        #alarmOverlay.test-mode { background: #2962FF !important; animation: none; }
        #alarmOverlay.test-mode .stop-btn { color: #2962FF; border-color: white; animation: none; }

        /* --- HIDDEN MEDIA --- */
        .media-hidden { position: absolute; width: 1px; height: 1px; opacity: 0.01; overflow: hidden; pointer-events: none; }
    </style>
</head>
<body>

    <div class="media-hidden">
        <audio id="audioSilence" src="silence.mp3" loop playsinline></audio>
        <audio id="audioAlarm" src="alert.mp3" preload="auto" playsinline></audio>
        <video id="videoDummy" loop playsinline muted>
            <source src="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAu1tZGF0AAACrgYF//+q3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1MiByMjg1NCBlOWE1OTAzIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNyAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTEgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBkaXJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAA7mWIhAAz//727L4FNf2f0JcRLMXaSnA+KqSAgHc0wAAAAwAAAwAAJuKiZ0WFMeJsgAAAHGAFBCwCPCVC" type="video/mp4">
        </video>
    </div>

    <div id="loginScreen">
        <h1>üîî BellGo Login</h1>
        
        <div class="input-group">
            <input type="text" id="inpStore" placeholder="ŒåŒΩŒøŒºŒ± ŒúŒ±Œ≥Œ±Œ∂ŒπŒøœç (œÄ.œá. Coffee1)">
        </div>
        <div class="input-group">
            <input type="text" id="inpName" placeholder="Œ§Œø ŒåŒΩŒøŒºŒ¨ œÉŒøœÖ">
        </div>
        <div class="input-group">
            <input type="password" id="inpPass" placeholder="ŒöœâŒ¥ŒπŒ∫œåœÇ" inputmode="numeric">
        </div>
        <div class="input-group">
            <select id="inpRole">
                <option value="waiter">üü¶ Œ£ŒµœÅŒ≤ŒπœÑœåœÅŒøœÇ</option>
                <option value="driver">üüß ŒîŒπŒ±ŒΩŒøŒºŒ≠Œ±œÇ</option>
                <option value="admin">üü• ADMIN (ŒöŒøœÖŒ∂ŒØŒΩŒ±)</option>
            </select>
        </div>
        
        <button class="btn-login" onclick="App.login()">Œ£Œ•ŒùŒîŒïŒ£Œó</button>
    </div>

    <div id="mainApp">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <span id="connDot" class="status-dot"></span>
                <span id="headerInfo" class="user-info">...</span>
            </div>
            <button class="btn-logout" onclick="App.logout()">EXIT</button>
        </div>
        
        <div class="content">
            <div id="staffPanel" class="staff-panel">
                <div id="staffList"></div>
            </div>
            
            <div class="chat-panel">
                <div id="chatBox" class="chat-messages">
                    <div style="text-align:center; opacity:0.5; margin-top:20px;">ŒöŒ±ŒªŒ∑ŒºŒ≠œÅŒ±! Œ§Œø Chat ŒµŒØŒΩŒ±Œπ Œ≠œÑŒøŒπŒºŒø.</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="msgInput" placeholder="ŒìœÅŒ¨œàŒµ ŒºŒÆŒΩœÖŒºŒ±...">
                    <button onclick="App.sendChat()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alarmOverlay" onclick="AudioEngine.stopAlarm(true)">
        <div id="alarmText" style="color:white; font-size:30px; margin-bottom:20px; font-weight:bold;">üö® ŒöŒõŒóŒ£Œó!</div>
        <button id="alarmBtn" class="stop-btn">STOP</button>
        <div style="margin-top:20px; color:white; font-size:14px;">(ŒÆ œÄŒ¨œÑŒ± œÑŒø Œ∫ŒøœÖŒºœÄŒØ œÉœÑŒ± Œ±Œ∫ŒøœÖœÉœÑŒπŒ∫Œ¨)</div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8",
            authDomain: "bellgo-5dbe5.firebaseapp.com",
            projectId: "bellgo-5dbe5",
            storageBucket: "bellgo-5dbe5.firebasestorage.app",
            messagingSenderId: "799314495253",
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c",
            measurementId: "G-379ETZJP8H"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const messaging = firebase.messaging();
        } catch(e) { console.error("Firebase init error", e); }

        // --- GLOBAL STATE ---
        let socket = null;
        let userData = { store: '', name: '', role: '', pass: '' };
        let androidNotificationTimer = null;

        // --- AUDIO ENGINE ---
        const AudioEngine = {
            silence: document.getElementById('audioSilence'),
            alarm: document.getElementById('audioAlarm'),
            video: document.getElementById('videoDummy'),
            isRinging: false,

            init() {
                // Prepare Silence Loop
                this.silence.volume = 0.05;
                this.silence.onpause = () => {
                    if (!this.isRinging) {
                        console.log("‚ôªÔ∏è Silence Loop Restart");
                        this.silence.play().catch(e => {});
                    }
                };
                
                // Prepare Dummy Video (Anti-sleep)
                this.video.play().catch(e => {});

                // Setup Media Session (Lock Screen Controls)
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: "BellGo Active",
                        artist: "System Online",
                        album: "Connected"
                    });
                    const stopAction = () => this.stopAlarm(true);
                    // Map ALL buttons to stop alarm
                    ['play', 'pause', 'stop', 'previoustrack', 'nexttrack', 'seekbackward', 'seekforward'].forEach(action => {
                        navigator.mediaSession.setActionHandler(action, stopAction);
                    });
                }
            },

            triggerAlarm(isTest = false) {
                this.isRinging = true;
                this.silence.pause();
                
                this.alarm.currentTime = 0;
                this.alarm.volume = 1.0;
                this.alarm.play().catch(e => console.log("Alarm blocked"));

                // Vibration
                if(navigator.vibrate) navigator.vibrate([1000, 500, 1000, 500, 1000]);

                // Update Lock Screen
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata.title = isTest ? "üîî TEST TEST" : "üö® ŒöŒõŒóŒ£Œó ŒöŒüŒ•ŒñŒôŒùŒëŒ£!";
                    navigator.mediaSession.metadata.artist = "Œ†ŒëŒ§Œë PLAY ŒìŒôŒë ŒëŒ†ŒüŒîŒüŒßŒó";
                }

                // Show Overlay
                const overlay = document.getElementById('alarmOverlay');
                const btn = document.getElementById('alarmBtn');
                const txt = document.getElementById('alarmText');

                if (isTest) {
                    overlay.classList.add('test-mode');
                    txt.innerText = "üîä ŒïŒõŒïŒìŒßŒüŒ£ ŒóŒßŒüŒ•";
                    btn.innerText = "OK";
                } else {
                    overlay.classList.remove('test-mode');
                    txt.innerText = "üö® ŒöŒõŒóŒ£Œó ŒëŒ†Œü ŒöŒüŒ•ŒñŒôŒùŒë";
                    btn.innerText = "STOP";
                    this.handleNotifications(); // Handle OS specific notifications
                }
                overlay.style.display = 'flex';
            },

            stopAlarm(sendAck = false) {
                if (!this.isRinging && document.getElementById('alarmOverlay').style.display === 'none') return;

                const isTest = document.getElementById('alarmOverlay').classList.contains('test-mode');
                
                this.isRinging = false;
                this.alarm.pause();
                this.alarm.currentTime = 0;
                
                // Resume Silence
                this.silence.play().catch(e=>{});
                
                // Reset Lock Screen
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata.title = "BellGo Active";
                    navigator.mediaSession.metadata.artist = userData.store;
                }

                // Hide Overlay
                document.getElementById('alarmOverlay').style.display = 'none';

                // Clear Android Timer
                if (androidNotificationTimer) clearTimeout(androidNotificationTimer);

                // Logic specific actions
                if (isTest) {
                    App.finishLoginSequence();
                } else if (sendAck) {
                    if(socket) socket.emit('alarm-ack', { name: userData.name, store: userData.store });
                }
            },

            handleNotifications() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isAndroid = /Android/.test(navigator.userAgent);

                if (isIOS) {
                    // iPhone: Immediate Notification
                    this.sendLocalNotification("üö® ŒöŒõŒóŒ£Œó!", "Œó Œ∫ŒøœÖŒ∂ŒØŒΩŒ± œÉŒµ Œ∫Œ±ŒªŒµŒØ œÑœéœÅŒ±!");
                } else if (isAndroid) {
                    // Android: Wait 30s
                    if (androidNotificationTimer) clearTimeout(androidNotificationTimer);
                    androidNotificationTimer = setTimeout(() => {
                        if (this.isRinging) {
                            this.sendLocalNotification("üö® ŒëŒ†ŒëŒùŒ§ŒóŒ£Œï!", "Œó Œ∫ŒøœÖŒ∂ŒØŒΩŒ± œÄŒµœÅŒπŒºŒ≠ŒΩŒµŒπ 30Œ¥ŒµœÖœÑ!");
                        }
                    }, 30000);
                } else {
                    // Desktop/Other: Immediate
                    this.sendLocalNotification("üö® ŒöŒõŒóŒ£Œó!", "ŒöŒªŒÆœÉŒ∑ Œ±œÄœå Œ∫ŒøœÖŒ∂ŒØŒΩŒ±");
                }
            },

            sendLocalNotification(title, body) {
                if (Notification.permission === "granted") {
                    new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/10337/10337229.png' });
                }
            }
        };

        // --- APP LOGIC ---
        const App = {
            login() {
                const store = document.getElementById('inpStore').value.trim();
                const name = document.getElementById('inpName').value.trim();
                const pass = document.getElementById('inpPass').value.trim();
                const role = document.getElementById('inpRole').value;

                if (!store || !name || !pass) return alert("Œ£œÖŒºœÄŒªŒÆœÅœâœÉŒµ œåŒªŒ± œÑŒ± œÄŒµŒ¥ŒØŒ±!");

                userData = { store, name, role, pass };

                // 1. Initialise Audio Context
                AudioEngine.init();

                // 2. Trigger Fake Alarm (Test Mode) to force interaction
                AudioEngine.triggerAlarm(true);
            },

            finishLoginSequence() {
                // Called after user clicks "OK" on the test alarm
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('headerInfo').innerText = `${userData.name} (${userData.role}) | ${userData.store}`;

                // Setup View based on Role
                if (userData.role === 'admin') {
                    document.getElementById('staffPanel').classList.add('active');
                    // Admin gets smaller chat usually, but here equal split is requested roughly
                } else {
                    document.getElementById('staffPanel').classList.remove('active');
                }

                // Request Notification Permission
                Notification.requestPermission();
                
                // Get Firebase Token (Log only for now)
                try {
                    const messaging = firebase.messaging();
                    messaging.getToken({ vapidKey: 'BMc_...' }).then((currentToken) => { // Replace with your Vapid if needed, or leave generic
                        if (currentToken) console.log("FCM Token:", currentToken);
                    }).catch((err) => console.log('An error occurred while retrieving token. ', err));
                } catch(e){}

                this.connectSocket();
                this.startHeartbeat();
            },

            connectSocket() {
                socket = io(); // Assumes server is serving this file
                
                socket.on('connect', () => {
                    document.getElementById('connDot').style.background = '#00E676'; // Green
                    socket.emit('join-store', { 
                        storeName: userData.store, 
                        username: userData.name, 
                        role: userData.role,
                        pass: userData.pass
                    });
                });

                socket.on('disconnect', () => {
                    document.getElementById('connDot').style.background = 'red';
                });

                // INCOMING ALARM (Staff side)
                socket.on('ring-bell', () => AudioEngine.triggerAlarm(false));
                
                // KITCHEN ALARM (Admin side - rarely used but included)
                socket.on('kitchen-alarm', () => AudioEngine.triggerAlarm(false));

                // STAFF LIST UPDATE (Admin side)
                socket.on('staff-list-update', (list) => this.renderStaffList(list));

                // CHAT
                socket.on('chat-message', (data) => this.renderChat(data));
            },

            startHeartbeat() {
                setInterval(() => {
                    if (socket && socket.connected) {
                        socket.emit('heartbeat');
                        // Request WakeLock again
                        if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e=>{});
                    }
                }, 5000);
            },

            renderStaffList(list) {
                const container = document.getElementById('staffList');
                container.innerHTML = '';
                
                list.forEach(u => {
                    if (u.role === 'admin') return; // Don't show admins in list
                    
                    const btn = document.createElement('button');
                    btn.className = `btn-staff ${u.role}`;
                    btn.innerHTML = `
                        <span>${u.name}</span>
                        <span class="status" id="status-${u.name}">IDLE</span>
                    `;
                    
                    // Click to Call
                    btn.onclick = () => {
                        socket.emit('trigger-alarm', u.name);
                        // Visual Feedback
                        const statusSpan = btn.querySelector('.status');
                        statusSpan.innerText = "üìû CALLING...";
                        statusSpan.style.color = "yellow";
                        statusSpan.style.fontWeight = "bold";
                        
                        // Reset visual after 5s
                        setTimeout(() => {
                            statusSpan.innerText = "IDLE";
                            statusSpan.style.color = "white";
                            statusSpan.style.fontWeight = "normal";
                        }, 5000);
                    };

                    container.appendChild(btn);
                });
            },

            sendChat() {
                const inp = document.getElementById('msgInput');
                const txt = inp.value.trim();
                if (!txt) return;
                
                socket.emit('chat-message', { text: txt });
                inp.value = '';
            },

            renderChat(data) {
                const box = document.getElementById('chatBox');
                const div = document.createElement('div');
                
                const isMe = data.sender === userData.name;
                let roleClass = data.role || 'waiter';
                if (isMe) roleClass = 'me';
                
                div.className = `msg ${roleClass}`;
                if (!isMe) div.classList.add('other');

                div.innerHTML = `
                    <span class="sender-name">${isMe ? 'ŒïŒ≥œé' : data.sender}</span>
                    ${data.text}
                `;
                
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        };

        logout = function() {
            location.reload();
        }
    </script>
</body>
</html>
