<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Ultimate</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>

    <script src="setup-bot.js"></script>
    <script src="watchdog.js"></script>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <h1>BELLGO</h1>
        <div style="border:1px solid #FF6D00; padding:10px; border-radius:10px; margin-bottom:20px;">
            <p style="color:#FF6D00; margin:0;">ğŸ¤– Î ÏÏÏ„Î· Ï†Î¿ÏÎ¬;</p>
            <button class="btn-setup" onclick="SetupBot.run()">Î¡Î¥Î˜ÎœÎ™Î£Î— Î‘Î”Î•Î™Î©Î (AUTO)</button>
        </div>
        
        <button class="btn-pompos" onclick="startApp('admin')">Î•Î™ÎœÎ‘Î™ Î ÎŸÎœÎ ÎŸÎ£</button>
        <button class="btn-dekths" onclick="startApp('staff')">Î•Î™ÎœÎ‘Î™ Î”Î•ÎšÎ¤Î—Î£</button>
    </div>

    <div id="pomposScreen" class="screen">
        <h1>Î ÎŸÎœÎ ÎŸÎ£</h1>
        <button class="btn-pompos" onclick="triggerAlarm()">ğŸ”” ÎšÎ›Î—Î£Î—</button>
        <p id="statusMsg">Ready</p>
    </div>

    <div id="dekthsScreen" class="screen">
        <h1>Î”Î•ÎšÎ¤Î—Î£</h1>
        <h2 style="color:#00C853">â— ONLINE</h2>
        <button class="btn-fake" onclick="enableFakeLock()">ğŸŒ™ FAKE LOCK</button>
        <p style="font-size:12px; color:#666;">ÎœÎ·Î½ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹Ï‚ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î·.</p>
    </div>

    <div id="fakeLockScreen" onclick="disableFakeLock()">
        <p>Double Tap to Unlock</p>
    </div>

    <div id="alarmOverlay">
        <h1>ğŸš¨ ÎšÎ›Î—Î£Î—!</h1>
        <button class="stop-btn" onclick="stopAlarm()">STOP</button>
    </div>

    <audio id="alertSound" src="alert.mp3" loop></audio>
    <audio id="silenceSound" src="silence.mp3" loop></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myFcmToken = null;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8",
            authDomain: "bellgo-5dbe5.firebaseapp.com",
            projectId: "bellgo-5dbe5",
            storageBucket: "bellgo-5dbe5.firebasestorage.app",
            messagingSenderId: "799314495253",
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c",
            measurementId: "G-379ETZJP8H"
        };
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // --- INIT APP ---
        async function startApp(role) {
            // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î´Î­ÎºÏ„Î·Ï‚, Ï€Î¬ÏÎµ Ï„Î¿ Token
            if (role === 'staff') {
                try {
                    const token = await messaging.getToken();
                    if(token) myFcmToken = token;
                    console.log("Token:", token);
                } catch(e) { console.log("Token Error", e); }
                
                // ÎÎµÎºÎ¯Î½Î± Ï„Î± Robots
                Watchdog.start();
                
                // ÎÎµÎºÎ¯Î½Î± Ï„Î¿Î½ ÏƒÎ¹Ï‰Ï€Î·Î»ÏŒ Î®Ï‡Î¿
                document.getElementById('silenceSound').volume = 0.05;
                document.getElementById('silenceSound').play().catch(()=>{});
            }

            // Î£ÏÎ½Î´ÎµÏƒÎ· Socket
            socket.emit('join-store', { 
                storeName: 'General', 
                username: role, 
                role: role,
                fcmToken: myFcmToken 
            });

            // Î‘Î»Î»Î±Î³Î® ÎŸÎ¸ÏŒÎ½Î·Ï‚
            document.getElementById('loginScreen').classList.remove('active');
            if (role === 'admin') document.getElementById('pomposScreen').classList.add('active');
            else document.getElementById('dekthsScreen').classList.add('active');

            // Media Session (ÎšÎ¿Ï…Î¼Ï€Î¹Î¬)
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({ title: 'BellGo Active' });
                navigator.mediaSession.setActionHandler('play', stopAlarm);
                navigator.mediaSession.setActionHandler('pause', stopAlarm);
            }
        }

        // --- ALARM LOGIC ---
        function triggerAlarm() {
            socket.emit('trigger-alarm');
            document.getElementById('statusMsg').innerText = "ÎšÎ±Î»ÎµÎ¯...";
            setTimeout(() => document.getElementById('statusMsg').innerText = "Ready", 3000);
        }

        socket.on('ring-bell', () => {
            // UI
            document.getElementById('alarmOverlay').style.display = 'flex';
            // Audio
            document.getElementById('alertSound').currentTime = 0;
            document.getElementById('alertSound').play();
            // Robots Attack
            Watchdog.triggerPanicMode();
        });

        function stopAlarm() {
            document.getElementById('alarmOverlay').style.display = 'none';
            document.getElementById('alertSound').pause();
            Watchdog.stopPanicMode();
        }

        // --- FAKE LOCK ---
        function enableFakeLock() {
            document.getElementById('fakeLockScreen').style.display = 'flex';
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        }
        function disableFakeLock() {
            document.getElementById('fakeLockScreen').style.display = 'none';
            if(document.exitFullscreen) document.exitFullscreen();
        }
    </script>
</body>
</html>
