<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
    <title>Bellgo Driver</title>
    <style>
        /* --- Î’Î‘Î£Î™ÎšÎŸ Î£Î¤Î¥Î› (ÎœÎ‘Î¥Î¡ÎŸ Î˜Î•ÎœÎ‘) --- */
        body { background: #000; color: white; font-family: sans-serif; text-align: center; margin: 0; overflow: hidden; user-select: none; }
        .hidden { display: none !important; }
        .screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        
        /* --- ÎšÎŸÎ¥ÎœÎ Î™Î‘ & INPUTS --- */
        .btn { background: #ffc107; color: black; padding: 18px; border-radius: 12px; width: 85%; border: none; font-weight: bold; font-size: 1.1em; cursor: pointer; margin: 10px 0; touch-action: manipulation; }
        input { width: 80%; padding: 15px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #111; color: white; text-align: center; font-size: 1em; }
        
        /* --- CHAT STYLES --- */
        #chat-box { width: 95%; background: #111; border: 1px solid #333; border-radius: 10px; margin: 15px 0; display: flex; flex-direction: column; height: 300px; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; text-align: left; font-size: 0.9em; border-bottom: 1px solid #333; }
        .msg { margin-bottom: 5px; padding: 5px; border-radius: 5px; }
        .msg.mine { background: #222; text-align: right; }
        .msg.others { background: #000; }
        
        /* --- RED ALERT SCREEN --- */
        #order-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f00; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; animation: flash 0.5s infinite; }
        @keyframes flash { 50% { background: #900; } }
        
        /* --- FAKE LOCK (BLACK SCREEN) --- */
        #fake-lock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10000; display: none; }
        .lock-hint { color: #333; font-size: 0.8em; margin-top: 50px; }
    </style>
</head>
<body>

    <div id="unlock-screen" class="screen">
        <h1 style="color:#ffc107; font-size: 3em;">BELLGO</h1>
        <p style="color:#666;">Unified Driver App</p>
        <button class="btn" onclick="initApp()">Î•ÎšÎšÎ™ÎÎ—Î£Î—</button>
    </div>

    <div id="login-screen" class="screen hidden">
        <h2 style="color:#ffc107">Î£Î¥ÎÎ”Î•Î£Î—</h2>
        <input type="text" id="shop" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î³Î±Î¶Î¹Î¿Ï (Ï€.Ï‡. Roasters)">
        <input type="password" id="pass" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ (1234)">
        <input type="text" id="name" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
        <br>
        <button class="btn" onclick="attemptLogin('driver')">Î•Î™Î£ÎŸÎ”ÎŸÎ£ Î©Î£ Î”Î™Î‘ÎÎŸÎœÎ•Î‘Î£ ğŸ›µ</button>
    </div>

    <div id="driver-ui" class="screen hidden">
        <div style="width:100%; display:flex; justify-content:space-between; padding:10px; box-sizing:border-box;">
            <span id="d-name" style="color:#ffc107; font-weight:bold;">DRIVER</span>
            <span style="color:#0f0;">â— ONLINE</span>
        </div>

        <div id="chat-box">
            <div id="chat-messages">
                <div style="color:#666; text-align:center; margin-top:10px;">ÎšÎ±Î»Ï‰ÏƒÎ®ÏÎ¸ÎµÏ‚ ÏƒÏ„Î¿ Chat!</div>
            </div>
            <div style="display:flex; padding:5px;">
                <input type="text" id="chat-in" placeholder="Î“ÏÎ¬ÏˆÎµ Î¼Î®Î½Ï…Î¼Î±..." style="flex:1; margin:0; padding:10px; text-align:left;">
                <button onclick="sendChat()" style="background:#ffc107; border:none; padding:0 20px; border-radius: 0 10px 10px 0; font-weight:bold;">â¤</button>
            </div>
        </div>

        <button class="btn" style="background:#222; color:white; border:1px solid #444" onclick="toggleFakeLock()">ğŸ”’ FAKE LOCK (ÎœÎ‘Î¥Î¡Î— ÎŸÎ˜ÎŸÎÎ—)</button>
        <button onclick="logout()" style="background:none; color:#666; border:none; margin-top:20px; text-decoration:underline;">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
    </div>

    <div id="order-layer" onclick="acceptOrder()">
        <h1 style="font-size:3em; color:white;">ğŸ”” ÎÎ•Î‘ ÎšÎ›Î—Î£Î—!</h1>
        <p style="font-size:1.5em; color:white;">Î Î‘Î¤Î‘ Î•Î”Î© Î‰ Î¤ÎŸ VOLUME BUTTON</p>
    </div>

    <div id="fake-lock" onclick="toggleFakeLock()">
        <div class="screen">
            <p class="lock-hint">Î Î±Ï„Î®ÏƒÏ„Îµ Î¿Ï€Î¿Ï…Î´Î®Ï€Î¿Ï„Îµ Î³Î¹Î± Î¾ÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î±</p>
        </div>
    </div>

    <audio id="snd" src="alert.mp3" loop></audio>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const { PushNotifications } = window.Capacitor.Plugins || {};
        let socket;
        let auth = null;
        const snd = document.getElementById('snd');
        const SERVER_URL = 'https://bellgo-final.onrender.com'; // TO URL Î£ÎŸÎ¥

        // --- 1. Î•ÎšÎšÎ™ÎÎ—Î£Î— ---
        function initApp() {
            document.getElementById('unlock-screen').classList.add('hidden');
            connectSocket();
        }

        function connectSocket() {
            socket = io(SERVER_URL, { transports: ['websocket'] });

            socket.on('connect', () => {
                console.log("Connected to Server!");
                checkAutoLogin();
                setupPush();
            });

            // Î›Î—Î¨Î— Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘Î£ (Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹ Î¼Îµ Ï„Î¿Î½ server.js)
            socket.on('order-notification', (data) => {
                triggerAlert(data);
            });

            // Î›Î—Î¨Î— CHAT (Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î±Î¹ÏÎ¹Î¬Î¶ÎµÎ¹ Î¼Îµ Ï„Î¿Î½ server.js)
            socket.on('chat-message', (data) => {
                appendMessage(data);
            });

            socket.on('disconnect', () => {
                console.log("Disconnected...");
            });
        }

        // --- 2. AUTHENTICATION ---
        function attemptLogin(role) {
            const shop = document.getElementById('shop').value.trim();
            const pass = document.getElementById('pass').value.trim();
            const name = document.getElementById('name').value.trim();

            if (!shop || !name) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÎŒÎ½Î¿Î¼Î± ÎºÎ±Î¹ ÎœÎ±Î³Î±Î¶Î¯!");
            if (pass !== "1234") return alert("Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚!");

            auth = { shop, name, role };
            localStorage.setItem('bellgo_auth', JSON.stringify(auth));
            
            // Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ Login ÏƒÏ„Î¿Î½ Server
            socket.emit('login', auth);
            showUI();
        }

        function checkAutoLogin() {
            const saved = localStorage.getItem('bellgo_auth');
            if (saved) {
                auth = JSON.parse(saved);
                socket.emit('login', auth);
                showUI();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        function showUI() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('driver-ui').classList.remove('hidden');
            document.getElementById('d-name').innerText = auth.name.toUpperCase();
        }

        function logout() {
            localStorage.removeItem('bellgo_auth');
            location.reload();
        }

        // --- 3. CHAT LOGIC ---
        function sendChat() {
            const input = document.getElementById('chat-in');
            const text = input.value.trim();
            if (text && socket) {
                // Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ ÏƒÏ„Î¿Î½ server: { user: 'Nikos', text: 'Geia sas' }
                socket.emit('chat-message', { user: auth.name, text: text });
                input.value = '';
            }
        }

        function appendMessage(data) {
            const box = document.getElementById('chat-messages');
            const isMe = data.user === auth?.name;
            
            // Î”Î¹Î±Î¼ÏŒÏÏ†Ï‰ÏƒÎ· HTML Î³Î¹Î± Ï„Î¿ Î¼Î®Î½Ï…Î¼Î±
            const html = `
                <div class="msg ${isMe ? 'mine' : 'others'}">
                    <b style="color: ${isMe ? '#ffc107' : '#00ccff'}">${data.user}:</b> ${data.text}
                </div>`;
            
            box.innerHTML += html;
            box.scrollTop = box.scrollHeight; // Auto-scroll ÎºÎ¬Ï„Ï‰
        }

        // --- 4. ALERT & VOLUME BUTTONS ---
        function triggerAlert(data) {
            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· ÎºÏŒÎºÎºÎ¹Î½Î·Ï‚ Î¿Î¸ÏŒÎ½Î·Ï‚ ÎœÎŸÎÎŸ Î±Î½ ÎµÎ¯Î¼Î±ÏƒÏ„Îµ Driver
            document.getElementById('order-layer').style.display = 'flex';
            
            // Î‰Ï‡Î¿Ï‚ ÎºÎ±Î¹ Î”ÏŒÎ½Î·ÏƒÎ·
            snd.play().catch(e => console.log("Audio play error:", e));
            if (navigator.vibrate) navigator.vibrate([1000, 500, 1000, 500, 1000]);
        }

        function acceptOrder() {
            // Î£Ï„Î±Î¼Î¬Ï„Î·Î¼Î± ÏƒÏ…Î½Î±Î³ÎµÏÎ¼Î¿Ï
            document.getElementById('order-layer').style.display = 'none';
            snd.pause();
            snd.currentTime = 0;
            if (navigator.vibrate) navigator.vibrate(0);

            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î¼Î­ÏƒÏ‰ Chat ÏŒÏ„Î¹ Ï„Î¿ Î»Î¬Î²Î±Î¼Îµ
            if (socket && auth) {
                socket.emit('chat-message', { user: 'SYSTEM', text: `âœ… ÎŸ ${auth.name} Î­Î»Î±Î²Îµ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ·!` });
            }
        }

        // Î‘ÎºÏÏŒÎ±ÏƒÎ· Volume Buttons (Hardware)
        window.addEventListener('keydown', (e) => {
            const isVolumeKey = (e.key === "VolumeUp" || e.key === "VolumeDown" || e.keyCode === 24 || e.keyCode === 25);
            const isAlertActive = document.getElementById('order-layer').style.display === 'flex';

            if (isVolumeKey && isAlertActive) {
                e.preventDefault(); // ÎœÎ·Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹Ï‚ Ï„Î·Î½ Î­Î½Ï„Î±ÏƒÎ·
                acceptOrder();      // Î‘Ï€Î¿Î´Î­Î¾Î¿Ï… Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ·
            }
        });

        // --- 5. FAKE LOCK ---
        function toggleFakeLock() {
            const lock = document.getElementById('fake-lock');
            lock.style.display = (lock.style.display === 'block') ? 'none' : 'block';
        }

        // --- 6. PUSH NOTIFICATIONS (CAPACITOR) ---
        async function setupPush() {
            if (!PushNotifications) return;
            try {
                const perm = await PushNotifications.requestPermissions();
                if (perm.receive === 'granted') {
                    await PushNotifications.register();
                }
                
                PushNotifications.addListener('pushNotificationReceived', (notification) => {
                    // ÎŒÏ„Î±Î½ Î­ÏÏ‡ÎµÏ„Î±Î¹ ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·, Î²Î±ÏÎ¬ÎµÎ¹ Î¿ ÏƒÏ…Î½Î±Î³ÎµÏÎ¼ÏŒÏ‚
                    triggerAlert();
                });
            } catch (e) {
                console.log("Push Setup Error:", e);
            }
        }
    </script>
</body>
</html>
