<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bellgo Driver</title>
    <style>
        /* BASIC STYLES */
        body { background: #000; color: white; font-family: -apple-system, BlinkMacSystemFont, sans-serif; text-align: center; margin: 0; overflow: hidden; }
        .hidden { display: none !important; }
        .screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; position: relative; }
        
        /* BUTTONS & INPUTS */
        .btn { background: #ffc107; color: black; padding: 18px; border-radius: 12px; width: 85%; border: none; font-weight: bold; font-size: 1.1em; cursor: pointer; margin: 10px 0; transition: 0.2s; }
        .btn:active { transform: scale(0.95); opacity: 0.8; }
        input { width: 80%; padding: 15px; margin: 8px 0; border-radius: 10px; border: 1px solid #333; background: #111; color: white; text-align: center; font-size: 16px; }
        
        /* CHAT */
        #chat-box { width: 90%; background: #111; border: 1px solid #333; border-radius: 10px; margin: 15px 0; display: flex; flex-direction: column; height: 300px; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; text-align: left; font-size: 0.9em; border-bottom: 1px solid #333; }
        
        /* ALARM LAYER */
        #order-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f00; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; animation: flash 0.5s infinite; }
        @keyframes flash { 50% { background: #900; } }
        
        /* FAKE LOCK */
        #fake-lock { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 10000; display: none; }
        
        /* APK BUTTON */
        .btn-apk-floating { position: absolute; top: 20px; right: 20px; background: #333; border: 1px solid #ffc107; color: #ffc107; padding: 8px 15px; font-size: 12px; text-decoration: none; border-radius: 20px; font-weight: bold; z-index: 1000; }
    </style>
</head>
<body>

    <div style="position:absolute; top:0; left:0; width:1px; height:1px; opacity:0.01; overflow:hidden;">
        <audio id="alertSound" src="alert.mp3" loop playsinline></audio>
        <audio id="silenceSound" src="silence.mp3" loop playsinline></audio>
    </div>

    <a href="https://github.com/theroasters84-wq/bellgo-final/releases/download/v1.0.0/app-release.apk" class="btn-apk-floating">ğŸ“² APP</a>

    <div id="unlock-screen" class="screen">
        <h1 style="color:#ffc107; font-size: 40px;">BELLGO</h1>
        <p style="color:gray; margin-bottom: 30px;">Driver Edition</p>
        <button class="btn" onclick="initApp()">Î•ÎÎ•Î¡Î“ÎŸÎ ÎŸÎ™Î—Î£Î—</button>
    </div>

    <div id="login-screen" class="screen hidden">
        <h2 style="color:#ffc107">Î•Î™Î£ÎŸÎ”ÎŸÎ£</h2>
        <input type="text" id="shop" placeholder="ÎœÎ‘Î“Î‘Î–Î™ (Ï€.Ï‡. CoffeeRoom1)">
        <input type="password" id="pass" placeholder="ÎšÎ©Î”Î™ÎšÎŸÎ£" inputmode="numeric">
        <input type="text" id="name" placeholder="Î¤ÎŸ ÎŸÎÎŸÎœÎ‘ Î£ÎŸÎ¥">
        <div style="height:20px"></div>
        <button class="btn" onclick="attemptLogin('driver')">Î•Î™Î£ÎŸÎ”ÎŸÎ£ Î”Î™Î‘ÎÎŸÎœÎ•Î‘</button>
        <button class="btn" style="background:#333; color:white;" onclick="attemptLogin('admin')">Î•Î™Î£ÎŸÎ”ÎŸÎ£ ADMIN</button>
    </div>

    <div id="driver-ui" class="screen hidden">
        <h2 id="d-name" style="color:#ffc107">DRIVER</h2>
        <p style="color:#0f0; border:1px solid #0f0; padding:5px 15px; border-radius:20px;">â— ONLINE</p>
        
        <div id="chat-box">
            <div id="chat-messages"></div>
            <div style="display:flex; padding:5px; background:#222;">
                <input type="text" id="chat-in" placeholder="Î“ÏÎ¬ÏˆÎµ Î¼Î®Î½Ï…Î¼Î±..." style="flex:1; margin:0; padding:10px; text-align:left;">
                <button onclick="sendChat()" style="background:#ffc107; border:none; padding:0 20px; border-radius:0 10px 10px 0; font-size:20px;">â¤</button>
            </div>
        </div>
        
        <button class="btn" style="background:#222; color:gray; border:1px solid #444" onclick="document.getElementById('fake-lock').style.display='block'">ğŸŒ™ FAKE LOCK (Black Screen)</button>
        <button onclick="logout()" style="background:none; color:#d32f2f; border:none; margin-top:20px; font-size:14px;">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</button>
    </div>

    <div id="order-layer" onclick="acceptOrder()">
        <h1 style="font-size:50px; font-weight:900;">ğŸš¨ ÎšÎ›Î—Î£Î—!</h1>
        <p style="font-size:20px;">Î Î‘Î¤Î‘ Î•Î”Î© Î‰ Î¤ÎŸ VOLUME BUTTON</p>
    </div>

    <div id="fake-lock" onclick="this.style.display='none'">
        <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#333;">Double Tap to Unlock</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let auth = null;
        let isRinging = false;

        // --- AUDIO ENGINE (ROBUST) ---
        const AudioEngine = {
            alert: document.getElementById('alertSound'),
            silence: document.getElementById('silenceSound'),
            
            init() {
                // ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î¿ silence loop Î³Î¹Î± Î½Î± Î¼ÎµÎ¯Î½ÎµÎ¹ Î¾ÏÏ€Î½Î¹Î¿ Ï„Î¿ Android
                this.playSilence();
                // Î‘Î½ ÏƒÏ„Î±Î¼Î±Ï„Î®ÏƒÎµÎ¹ ÎºÎ±Ï„Î¬ Î»Î¬Î¸Î¿Ï‚, Ï„Î¿ Î¾Î±Î½Î±Î²Î¬Î¶Î¿Ï…Î¼Îµ
                this.silence.onpause = () => { if(!isRinging) this.playSilence(); };
            },

            playSilence() {
                this.alert.pause();
                this.alert.currentTime = 0;
                this.silence.volume = 0.1;
                this.silence.play().catch(e => console.log("User interaction needed"));
            },
            
            playAlert() {
                this.silence.pause();
                this.alert.volume = 1.0;
                this.alert.play().catch(e => console.error(e));
                if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
            }
        };

        function initApp() {
            document.getElementById('unlock-screen').classList.add('hidden');
            AudioEngine.init();

            // Î£ÏÎ½Î´ÎµÏƒÎ· Socket
            socket = io();

            socket.on('connect', () => {
                console.log("Connected to Server");
                checkAuth();
            });

            // --- LISTENERS ---
            
            // 1. Alarm Listener (Compatible with Server)
            socket.on('kitchen-alarm', () => {
                if(auth?.isDriver) {
                    isRinging = true;
                    document.getElementById('order-layer').style.display = 'flex';
                    AudioEngine.playAlert();
                }
            });
            // Backup listener
            socket.on('ring-bell', () => { if(auth?.isDriver) { isRinging = true; document.getElementById('order-layer').style.display = 'flex'; AudioEngine.playAlert(); } });

            // 2. Chat Listener
            socket.on('chat-message', (data) => {
                const box = document.getElementById('chat-messages');
                if(box) {
                    const isMe = data.sender === auth.name;
                    const color = isMe ? '#ffc107' : '#00E676';
                    box.innerHTML += `<div style="margin-bottom:5px;"><b style="color:${color}">${data.sender}:</b> ${data.text}</div>`;
                    box.scrollTop = box.scrollHeight;
                }
            });

            // 3. Heartbeat (Keep alive)
            setInterval(() => { if(socket.connected) socket.emit('heartbeat'); }, 5000);
        }

        // --- VOLUME BUTTON HANDLER ---
        window.addEventListener('keydown', (e) => {
            // Key 24/25 are Volume Up/Down on Android WebView
            if(e.keyCode === 24 || e.keyCode === 25) { 
                if(isRinging) {
                    e.preventDefault(); // Stop volume change
                    acceptOrder();
                }
            }
        });

        // --- ACTIONS ---

        function acceptOrder() {
            isRinging = false;
            
            // UI & Audio Reset
            document.getElementById('order-layer').style.display = 'none';
            AudioEngine.playSilence();
            if(navigator.vibrate) navigator.vibrate(0);

            // NETWORK SPAMMING (To ensure Admin gets it)
            if(socket && auth) {
                // Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ alarm-ack (ÏƒÏ…Î¼Î²Î±Ï„ÏŒ Î¼Îµ Ï„Î¿Î½ Î½Î­Î¿ server)
                socket.emit('alarm-ack');
                setTimeout(() => socket.emit('alarm-ack'), 150);
                setTimeout(() => socket.emit('alarm-ack'), 400);
            }
        }

        function sendChat() {
            const m = document.getElementById('chat-in');
            if(m.value && socket) { 
                socket.emit('chat-message', { text: m.value }); 
                m.value=''; 
            }
        }

        // --- AUTH & NAVIGATION ---

        function attemptLogin(role) {
            const s = document.getElementById('shop').value.trim();
            const p = document.getElementById('pass').value.trim();
            const n = document.getElementById('name').value.trim();

            if(!s || !p || !n) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±");

            auth = { shop: s, password: p, name: n, isDriver: role === 'driver', role: role };
            localStorage.setItem('bellgo_driver_auth', JSON.stringify(auth));
            
            performSocketLogin();
        }

        function checkAuth() {
            const saved = localStorage.getItem('bellgo_driver_auth');
            if(saved) { 
                auth = JSON.parse(saved); 
                performSocketLogin();
            } else { 
                document.getElementById('login-screen').classList.remove('hidden'); 
            }
        }

        function performSocketLogin() {
            // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ 'join-store' ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î¿Î½ Server
            socket.emit('join-store', { 
                storeName: auth.shop, 
                username: auth.name, 
                role: auth.role,
                pass: auth.password
            });
            showUI();
        }

        function showUI() {
            document.getElementById('login-screen').classList.add('hidden');
            if(auth.isDriver) {
                document.getElementById('driver-ui').classList.remove('hidden');
                document.getElementById('d-name').innerText = auth.name.toUpperCase();
            } else {
                // Î‘Î½ Î¼Ï€ÎµÎ¹ Admin Î±Ï€ÏŒ ÎµÎ´Ï, Ï„Î¿Ï… Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ Î¼Î®Î½Ï…Î¼Î± (Î® Ï†Ï„Î¹Î¬Ï‡Î½ÎµÎ¹Ï‚ Admin UI Î±Î½ Î¸ÎµÏ‚)
                alert("Î‘Ï…Ï„Î® Î· ÏƒÎµÎ»Î¯Î´Î± ÎµÎ¯Î½Î±Î¹ Î²ÎµÎ»Ï„Î¹ÏƒÏ„Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· Î³Î¹Î± Drivers. Î Î±ÏÎ±ÎºÎ±Î»Ï Î¼Ï€ÎµÏ‚ Î±Ï€ÏŒ Ï„Î¿ PC/Tablet Î³Î¹Î± Admin.");
                document.getElementById('driver-ui').classList.remove('hidden'); // Î¤Î¿Î½ Î±Ï†Î®Î½Î¿Ï…Î¼Îµ Î½Î± Î¼Ï€ÎµÎ¹ Ï‰Ï‚ viewer
            }
        }

        function logout() { localStorage.removeItem('bellgo_driver_auth'); location.reload(); }
    </script>
</body>
</html>
