<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BellGo Unified</title>
    
    <style>
        body { background-color: #121212; color: #fff; font-family: sans-serif; text-align: center; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        
        input { background: #222; border: 1px solid #444; color: white; padding: 15px; font-size: 22px; width: 80%; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        button { width: 90%; padding: 20px; font-size: 20px; margin: 10px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; color: white; }
        
        .btn-pompos { background-color: #D32F2F; color: white; } /* Admin - ÎšÏŒÎºÎºÎ¹Î½Î¿ */
        .btn-dekths { background-color: #1976D2; } /* Waiter - ÎœÏ€Î»Îµ */
        .btn-driver { background-color: #F57C00; } /* Driver - Î Î¿ÏÏ„Î¿ÎºÎ±Î»Î¯ */
        .btn-next { background-color: #444; border: 1px solid white; margin-top: 20px;}

        /* Î›Î¯ÏƒÏ„Î± Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ¿Ï Î³Î¹Î± Ï„Î¿Î½ Admin */
        #staffListContainer { width: 100%; height: 60%; overflow-y: auto; padding: 10px; }
        .staff-card { background: #333; margin: 10px auto; padding: 15px; border-radius: 10px; width: 90%; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #555; }
        .staff-card:active { transform: scale(0.98); background: #555; }
        .staff-card span { font-size: 20px; }

        /* Alarm Overlay */
        #alarmScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: red; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; animation: flash 0.5s infinite; }
        @keyframes flash { 0% { background: red; } 50% { background: #500; } 100% { background: red; } }
        .stop-btn { width: 250px; height: 250px; border-radius: 50%; background: white; color: red; font-size: 40px; font-weight: 900; border: 10px solid yellow; }
    </style>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
</head>
<body>

    <div id="step1" class="screen active">
        <h1>ğŸ¢ Î’Î®Î¼Î± 1/4</h1>
        <input type="text" id="storeNameInput" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î³Î±Î¶Î¹Î¿Ï">
        <button class="btn-next" onclick="goToStep(2)">Î•Î ÎŸÎœÎ•ÎÎŸ</button>
    </div>

    <div id="step2" class="screen">
        <h1>ğŸ‘¤ Î’Î®Î¼Î± 2/4</h1>
        <input type="text" id="usernameInput" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
        <button class="btn-next" onclick="goToStep(3)">Î•Î ÎŸÎœÎ•ÎÎŸ</button>
    </div>

    <div id="step3" class="screen">
        <h1>ğŸ‘” Î’Î®Î¼Î± 3/4</h1>
        <button class="btn-pompos" onclick="selectRole('admin')">Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î¤Î—Î£ (Admin)</button>
        <button class="btn-dekths" onclick="selectRole('waiter')">Î£Î•Î¡Î’Î™Î¤ÎŸÎ¡ÎŸÎ£</button>
        <button class="btn-driver" onclick="selectRole('driver')">Î”Î™Î‘ÎÎŸÎœÎ•Î‘Î£</button>
    </div>

    <div id="step4" class="screen">
        <h1>ğŸ”‘ Î’Î®Î¼Î± 4/4</h1>
        <input type="password" id="passwordInput" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ (Ï€.Ï‡. 1234)">
        <button class="btn-pompos" onclick="finishSetup()">Î•Î™Î£ÎŸÎ”ÎŸÎ£ âœ…</button>
    </div>

    <div id="mainApp" class="screen">
        <h2 id="displayHeader">...</h2>
        
        <div id="adminPanel" style="display:none; width: 100%;">
            <h3>Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒ Online:</h3>
            <div id="staffListContainer">
                <p>Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚...</p>
            </div>
        </div>

        <div id="staffPanel" style="display:none;">
            <h1 style="font-size: 80px;">ğŸŸ¢</h1>
            <h3>Î•Î¯ÏƒÎ±Î¹ Online</h3>
            <p>Î ÎµÏÎ¯Î¼ÎµÎ½Îµ ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·...</p>
        </div>
    </div>

    <div id="alarmScreen">
        <h1>ğŸš¨ ÎšÎ›Î—Î£Î— Î‘Î ÎŸ ÎšÎŸÎ¥Î–Î™ÎÎ‘!</h1>
        <button class="stop-btn" onclick="stopAlarm()">STOP</button>
    </div>

    <script src="4player/player.js"></script>

    <script>
        const socket = io();
        let userConfig = { store: "", name: "", role: "" };

        // FIREBASE SETUP (Î¤Î± ÎºÎ»ÎµÎ¹Î´Î¹Î¬ ÏƒÎ¿Ï…)
        const firebaseConfig = {
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8",
            authDomain: "bellgo-5dbe5.firebaseapp.com",
            projectId: "bellgo-5dbe5",
            storageBucket: "bellgo-5dbe5.firebasestorage.app",
            messagingSenderId: "799314495253",
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c",
            measurementId: "G-379ETZJP8H"
        };
        try { firebase.initializeApp(firebaseConfig); const messaging = firebase.messaging(); } catch(e) {}

        function goToStep(n) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + n).classList.add('active');
        }

        function selectRole(role) {
            userConfig.role = role;
            goToStep(4);
        }

        function finishSetup() {
            userConfig.store = document.getElementById('storeNameInput').value.trim();
            userConfig.name = document.getElementById('usernameInput').value.trim();
            
            if(!userConfig.store || !userConfig.name) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±!");

            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· UI
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('displayHeader').innerText = `${userConfig.name} (${userConfig.role})`;

            if(userConfig.role === 'admin') {
                document.getElementById('adminPanel').style.display = 'block';
            } else {
                document.getElementById('staffPanel').style.display = 'block';
            }

            // Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Server
            socket.emit('join-store', {
                storeName: userConfig.store,
                username: userConfig.name,
                role: userConfig.role
            });

            // Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· Player (Î‘Ï€ÏŒ Ï„Î¿ external file)
            if(window.AudioEngine) window.AudioEngine.init();
        }

        // --- EVENTS Î‘Î ÎŸ SERVER ---

        // 1. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î›Î¯ÏƒÏ„Î±Ï‚ (ÎœÏŒÎ½Î¿ Î³Î¹Î± Admin)
        socket.on('staff-list-update', (staffList) => {
            if(userConfig.role !== 'admin') return; // ÎŸÎ¹ ÏƒÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Î¹ Î´ÎµÎ½ Î²Î»Î­Ï€Î¿Ï…Î½ Î»Î¯ÏƒÏ„Î±
            
            const container = document.getElementById('staffListContainer');
            container.innerHTML = ''; // ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚

            staffList.forEach(user => {
                if(user.role === 'admin') return; // ÎœÎ·Î½ Î´ÎµÎ¯Ï‡Î½ÎµÎ¹Ï‚ Ï„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ ÏƒÎ¿Ï…

                const div = document.createElement('div');
                div.className = 'staff-card';
                // Î§ÏÏÎ¼Î± Î±Î½Î¬Î»Î¿Î³Î± Ï„Î¿Î½ ÏÏŒÎ»Î¿
                div.style.borderLeft = user.role === 'waiter' ? '5px solid #1976D2' : '5px solid #F57C00';
                
                div.innerHTML = `<span>${user.username} (${user.role})</span> <span>ğŸ””</span>`;
                
                // ÎšÎ›Î™Îš Î“Î™Î‘ ÎšÎ›Î—Î£Î—
                div.onclick = () => {
                    socket.emit('trigger-alarm', user.username);
                    alert(`ÎšÎ±Î»ÎµÎ¯Ï‚ Ï„Î¿Î½/Ï„Î·Î½ ${user.username}...`);
                };
                container.appendChild(div);
            });

            if(container.innerHTML === '') container.innerHTML = '<p>ÎšÎ±Î½Î­Î½Î±Ï‚ online...</p>';
        });

        // 2. Î›Î®ÏˆÎ· ÎšÎ»Î®ÏƒÎ·Ï‚ (Î“Î¹Î± Ï„Î¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚)
        socket.on('ring-bell', () => {
            console.log("ALARM RECEIVED!");
            document.getElementById('alarmScreen').style.display = 'flex';
            
            // ÎšÎ±Î»Î¿ÏÎ¼Îµ Ï„Î¿Î½ Player Î±Ï€ÏŒ Ï„Î¿ 4player/player.js
            if(window.AudioEngine) window.AudioEngine.triggerAlarm();
        });

        function stopAlarm() {
            document.getElementById('alarmScreen').style.display = 'none';
            if(window.AudioEngine) window.AudioEngine.stopAlarm();
        }

        // Heartbeat
        setInterval(() => { if(socket.connected) socket.emit('heartbeat'); }, 5000);

    </script>
</body>
</html>
