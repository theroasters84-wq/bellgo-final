<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Spotify Mode</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            background-color: #121212; 
            color: #fff; 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
            user-select: none;
            padding: 2vh 5vw; 
        }

        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; }
        
        input { padding: 12px; margin: 8px; width: 90%; border-radius: 8px; border: 1px solid #444; background: #222; color: white; font-size: 16px; text-align: center; }
        
        .btn { padding: 15px; font-size: 18px; border-radius: 12px; width: 100%; margin: 5px 0; font-weight: bold; border: none; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.96); }
        .btn-green { background-color: #00C853; } 
        .btn-blue { background-color: #2962FF; }  
        .btn-red { background-color: #D50000; } 
        .btn-grey { background-color: #424242; font-size: 14px; padding: 10px; margin-top: 10px; width: 50%; }  
        .btn-user { background-color: #37474F; border: 1px solid #546E7A; margin: 4px; width: 46%; display: inline-block; font-size: 14px; padding: 12px; }

        /* STOP OVERLAY */
        .stop-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #b71c1c; z-index: 2147483647; flex-direction: column; justify-content: center; align-items: center; animation: pulse 0.3s infinite; }
        .btn-stop-big { width: 80%; height: 30%; font-size: 35px; background: white; color: red; border-radius: 20px; font-weight: 900; box-shadow: 0 10px 30px rgba(0,0,0,0.8); border: 5px solid yellow; }

        /* CHAT */
        #chatContainer { flex: 1; width: 100%; background: #1a1a1a; border-radius: 10px 10px 0 0; margin-top: 10px; display: flex; flex-direction: column; border: 1px solid #333; min-height: 25vh; max-height: 35vh; }
        #chatMessagesAdmin, #chatMessagesStaff { flex: 1; overflow-y: auto; text-align: left; padding: 10px; font-size: 13px; color: #ccc; }
        .chat-input-area { display: flex; width: 100%; }
        .chat-input { flex:1; margin:0; border-radius:0 0 0 10px; border:none; border-top:1px solid #444; }
        .chat-btn { width:50px; margin:0; border-radius:0 0 10px 0; }
        .msg-usr { color: #fff; margin-bottom: 4px; }
        #usersContainer { max-height: 30vh; overflow-y: auto; width: 100%; padding-bottom: 5px; }

        /* PLAYER STATUS INDICATOR */
        .spotify-indicator { font-size: 12px; color: #00C853; margin-top: 5px; display: none; align-items: center; justify-content: center; gap: 5px; background: #000; padding: 5px 15px; border-radius: 20px; border: 1px solid #333; }
        .dot { height: 8px; width: 8px; background-color: #00C853; border-radius: 50%; display: inline-block; animation: blink 2s infinite; }

        @keyframes pulse { 0% { background-color: #b71c1c; transform: scale(1); } 50% { background-color: #ff0000; transform: scale(1.02); } 100% { background-color: #b71c1c; transform: scale(1); } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen" style="display:flex;">
        <h2 style="color:#00C853; margin-bottom:10px;">BELLGO SPOTIFY MODE</h2>
        <input type="text" id="storeName" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î³Î±Î¶Î¹Î¿Ï">
        <input type="text" id="username" placeholder="ÎŒÎ½Î¿Î¼Î± Î§ÏÎ®ÏƒÏ„Î·">
        <input type="password" id="password" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ (1234)" inputmode="numeric">
        
        <div style="margin-top:10px; width:100%; display:flex; justify-content:center; gap:5px;">
            <button class="btn btn-green" style="width:48%" onclick="attemptLogin('admin')">ADMIN</button>
            <button class="btn btn-blue" style="width:48%" onclick="attemptLogin('staff')">STAFF</button>
        </div>
        <p id="loginError" style="color:red; display:none; font-size:12px;">Î›Î¬Î¸Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚!</p>
    </div>

    <div id="adminScreen" class="screen">
        <div style="width:100%; border-bottom:1px solid #444; padding-bottom:5px;">
            <h3 id="adminHeader" style="margin:0; font-size:16px;">Admin Panel</h3>
        </div>
        <button class="btn btn-red" onclick="triggerAlarm(null)">ğŸ“¢ ÎšÎ›Î—Î£Î— Î£Î• ÎŸÎ›ÎŸÎ¥Î£</button>
        <p style="color:#888; font-size:12px; margin:5px;">Î•Î½ÎµÏÎ³Î¿Î¯ Î§ÏÎ®ÏƒÏ„ÎµÏ‚:</p>
        <div id="usersContainer"></div>
        <div id="chatContainer">
            <div id="chatMessagesAdmin"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInputAdmin" class="chat-input" placeholder="Î“ÏÎ¬ÏˆÎµ...">
                <button class="btn btn-blue chat-btn" onclick="sendChat('admin')">></button>
            </div>
        </div>
        <button class="btn btn-grey" onclick="logout()">Î‘Î ÎŸÎ£Î¥ÎÎ”Î•Î£Î—</button>
    </div>

    <div id="receiverScreen" class="screen">
        <div style="font-size: 60px; margin-bottom:10px;">ğŸ§</div>
        <h2 id="receiverHeader">Î‘Î½Î±Î¼Î¿Î½Î®...</h2>
        
        <div class="spotify-indicator" id="spotifyStatus">
            <span class="dot"></span> Running in Background
        </div>

        <button onclick="toggleFakeLock(true)" style="margin-top:20px; background:#222; color:#888; border:1px solid #444; padding:15px; border-radius:10px; width:80%;">
            ğŸ”’ Fake Lock (ÎŸÎ¸ÏŒÎ½Î· Î¤ÏƒÎ­Ï€Î·Ï‚)
        </button>

        <div id="chatContainer" style="margin-top:auto;">
            <div id="chatMessagesStaff"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInputStaff" class="chat-input" placeholder="Î“ÏÎ¬ÏˆÎµ...">
                <button class="btn btn-blue chat-btn" onclick="sendChat('staff')">></button>
            </div>
        </div>
        <button class="btn btn-grey" onclick="logout()">Î‘Î ÎŸÎ£Î¥ÎÎ”Î•Î£Î—</button>
    </div>

    <div id="stopOverlay" class="stop-overlay">
        <h1 style="color:white; font-size:40px; margin:0;">ğŸ”” ÎšÎ›Î—Î£Î—!</h1>
        <h2 id="callerName" style="color:yellow; margin:10px 0 30px 0;">...</h2>
        <button class="btn btn-stop-big" onclick="stopAlarm()">STOP</button>
        <p style="color:white; font-size:14px; margin-top:20px; font-weight:bold;">Î Î‘Î¤Î‘ Î¤Î©Î¡Î‘ STOP<br>Î® Volume Up</p>
    </div>

    <div id="fakeLock" onclick="toggleFakeLock(false)" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:9000;">
        <div style="position:absolute; bottom:50px; width:100%; text-align:center; color:#333; font-size:12px;">Double Tap to Unlock</div>
    </div>

    <audio id="alertPlayer" preload="auto" loop playsinline><source src="alert.mp3" type="audio/mpeg"></audio>
    
    <audio id="silentPlayer" src="silence.mp3" loop playsinline></audio>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io(); // ÎÎ±Î¹, ÎµÎ´Ï ÎµÎ¯Î½Î±Î¹ Ï„Î¿ socket connection
        let myRole = '';
        let isRinging = false;
        let vibrationInterval = null;
        let foregroundInterval = null;

        // --- LOGIN & MEDIA START ---
        function attemptLogin(role) {
            const store = document.getElementById('storeName').value.trim();
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();

            if (!store || !user) { alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€ÎµÎ´Î¯Î±!"); return; }
            if (pass !== '1234') { document.getElementById('loginError').style.display = 'block'; return; }

            // 1. ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î¿ "Spotify" Player (Media Session)
            // Î‘Ï…Ï„ÏŒ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î³Î¯Î½ÎµÎ¹ Î•Î”Î©, Î¼Îµ Ï„Î¿ Ï€Î¬Ï„Î·Î¼Î± Ï„Î¿Ï… ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï (User Gesture)
            startFakeSpotify();

            // 2. Fully Kiosk Bot
            runFullyKioskBot();

            // 3. Fake GPS
            if(role === 'staff') startNavBot();

            // 4. Socket Join
            socket.emit('join-store', { storeName: store, username: user, role: role });

            // UI
            document.getElementById('loginScreen').style.display = 'none';
            myRole = role;
            
            if (role === 'admin') {
                document.getElementById('adminScreen').style.display = 'flex';
                document.getElementById('adminHeader').innerText = "Admin: " + user;
            } else {
                document.getElementById('receiverScreen').style.display = 'flex';
                document.getElementById('receiverHeader').innerText = "Î“ÎµÎ¹Î± ÏƒÎ¿Ï… " + user;
                document.getElementById('spotifyStatus').style.display = 'flex';
            }
        }

        // --- FAKE SPOTIFY / NOTIFICATION BAR LOGIC ---
        function startFakeSpotify() {
            const silent = document.getElementById('silentPlayer');
            silent.volume = 0.1; // Î§Î±Î¼Î·Î»Î® Î­Î½Ï„Î±ÏƒÎ· Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎµÎ½Î¿Ï‡Î»ÎµÎ¯, Î±Î»Î»Î¬ Î½Î± ÎµÎ¯Î½Î±Î¹ "ÎµÎ½ÎµÏÎ³ÏŒ"
            
            silent.play().then(() => {
                console.log("Silence.mp3 playing...");

                // Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Media Session API (Î— ÎœÏ€Î¬ÏÎ± Î•Î¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½)
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: 'System Online',
                        artist: 'BellGo Connected',
                        album: 'Do Not Close',
                        artwork: [
                            { src: 'https://cdn-icons-png.flaticon.com/512/84/84183.png', sizes: '96x96', type: 'image/png' },
                            { src: 'https://cdn-icons-png.flaticon.com/512/84/84183.png', sizes: '128x128', type: 'image/png' },
                        ]
                    });

                    navigator.mediaSession.playbackState = 'playing';

                    // ÎŸÏÎ¯Î¶Î¿Ï…Î¼Îµ Î¬Î´ÎµÎ¹ÎµÏ‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚ Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½Î¿Î½Ï„Î±Î¹ Ï„Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬
                    navigator.mediaSession.setActionHandler('play', function() { silent.play(); });
                    navigator.mediaSession.setActionHandler('pause', function() { silent.play(); }); // Î‘Î½ Ï€Î±Ï„Î®ÏƒÎµÎ¹ pause, Ï„Î¿ Î¾Î±Î½Î±Î¾ÎµÎºÎ¹Î½Î¬Î¼Îµ!
                    navigator.mediaSession.setActionHandler('stop', function() { /* Do nothing */ });
                }
            }).catch(e => {
                console.error("Silent Play Failed:", e);
                // Î‘Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹, Î´Î¿ÎºÎ¹Î¼Î¬Î¶Î¿Ï…Î¼Îµ Ï€Î¬Î»Î¹ ÏƒÎµ 1 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î¿
                setTimeout(startFakeSpotify, 1000);
            });
        }

        function logout() {
            stopAlarm();
            window.location.reload();
        }

        // --- SOCKET LOGIC ---
        socket.on('update-user-list', (users) => {
            if (myRole !== 'admin') return;
            const container = document.getElementById('usersContainer');
            container.innerHTML = ''; 
            if (users.length === 0) container.innerHTML = '<p style="color:#555; font-size:12px;">ÎšÎ±Î½ÎµÎ¯Ï‚ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚...</p>';
            users.forEach(u => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-user';
                btn.innerHTML = `ğŸ”” <b>${u.name}</b>`;
                btn.onclick = function() { triggerAlarm(u.id); }; 
                container.appendChild(btn);
            });
        });

        function triggerAlarm(targetId) {
            socket.emit('trigger-alarm', { targetId: targetId });
        }

        // Î•Î”Î© Î•Î™ÎÎ‘Î™ Î¤ÎŸ ÎšÎ¡Î™Î£Î™ÎœÎŸ SOCKET.ON Î ÎŸÎ¥ Î–Î—Î¤Î—Î£Î•Î£
        socket.on('ring-bell', (data) => {
            if (isRinging) return;
            isRinging = true;
            document.getElementById('callerName').innerText = data.sender || "Admin";

            if (window.fully) {
                fully.turnScreenOn();
                fully.bringToForeground();
                fully.setMusicVolume(100);
            }

            // Video Killer Loop
            if (window.fully) {
                if(foregroundInterval) clearInterval(foregroundInterval);
                foregroundInterval = setInterval(() => {
                    fully.bringToForeground();
                    fully.turnScreenOn();
                }, 500); 
            }

            toggleFakeLock(false);
            document.getElementById('stopOverlay').style.display = 'flex';

            const player = document.getElementById('alertPlayer');
            player.currentTime = 0;
            player.volume = 1.0;
            player.play().catch(e => console.log("Alert Error:", e));
            startVibration();
        });

        function stopAlarm() {
            if (!isRinging) return;
            isRinging = false;
            
            if (foregroundInterval) { clearInterval(foregroundInterval); foregroundInterval = null; }
            
            const player = document.getElementById('alertPlayer');
            player.pause();
            player.currentTime = 0;
            stopVibration();
            document.getElementById('stopOverlay').style.display = 'none';
        }

        function runFullyKioskBot() {
            if (window.fully) {
                try {
                    fully.requestOverlayPermission();
                    fully.setMusicVolume(100);
                    fully.setBooleanSetting("keepScreenOn", true);
                    fully.setBooleanSetting("unlockScreen", true);
                    fully.setBooleanSetting("listenVolumeButtons", true);
                } catch (e) {}
            }
        }

        function startNavBot() {
            if ("geolocation" in navigator) {
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition((p) => {}, (e) => {}, {enableHighAccuracy:true});
                }, 15000);
            }
        }

        function sendChat(role) {
            const inputId = role === 'admin' ? 'chatInputAdmin' : 'chatInputStaff';
            const input = document.getElementById(inputId);
            const msg = input.value.trim();
            if (msg) {
                socket.emit('send-chat', msg);
                input.value = '';
            }
        }

        socket.on('chat-message', (data) => {
            if (data.sender === 'System') return;
            const line = document.createElement('div');
            line.className = 'msg-usr';
            line.innerHTML = `<b style="color:#00C853">${data.sender}:</b> ${data.text}`;
            const containers = [document.getElementById('chatMessagesAdmin'), document.getElementById('chatMessagesStaff')];
            containers.forEach(c => { if (c) { c.appendChild(line.cloneNode(true)); c.scrollTop = c.scrollHeight; } });
        });

        window.addEventListener('keydown', (e) => {
            const stopKeys = [179, 24, 25, 85, 13];
            if (stopKeys.includes(e.keyCode) || e.key === "VolumeUp" || e.key === "VolumeDown") {
                if (isRinging) {
                    stopAlarm();
                    e.preventDefault();
                }
            }
        });

        function startVibration() {
            if (navigator.vibrate) navigator.vibrate([1000, 100, 1000, 100, 1000]); 
            if (vibrationInterval) clearInterval(vibrationInterval);
            vibrationInterval = setInterval(() => {
                if (navigator.vibrate) navigator.vibrate([1000, 100, 1000, 100, 1000]);
            }, 3500);
        }

        function stopVibration() {
            if (vibrationInterval) clearInterval(vibrationInterval);
            if (navigator.vibrate) navigator.vibrate(0);
        }

        function toggleFakeLock(enable) {
            document.getElementById('fakeLock').style.display = enable ? 'block' : 'none';
        }
    </script>
</body>
</html>
