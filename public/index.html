<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Pro</title>
    <style>
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        /* GENERAL UI */
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; }
        input, select { padding: 15px; margin: 10px; width: 80%; border-radius: 8px; border: 1px solid #444; background: #222; color: white; font-size: 18px; text-align: center; }
        
        .btn { padding: 20px; font-size: 20px; border-radius: 12px; width: 90%; margin: 10px; font-weight: bold; border: none; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .btn:active { transform: scale(0.98); }
        
        .btn-green { background-color: #00C853; } /* Login / Call */
        .btn-blue { background-color: #2962FF; }  /* Roles */
        .btn-red { background-color: #D50000; }   /* Stop */
        .btn-user { background-color: #444; border: 1px solid #666; margin: 5px; width: 45%; display: inline-block; }
        
        /* ALARM STOP BTN */
        .stop-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #b71c1c; z-index: 5000; flex-direction: column; justify-content: center; align-items: center; animation: pulse 0.5s infinite; }
        .btn-stop-big { width: 90%; height: 50%; font-size: 40px; background: white; color: red; border-radius: 20px; font-weight: 900; }

        /* CHAT & LISTS */
        #usersContainer { max-height: 40vh; overflow-y: auto; width: 100%; display: flex; flex-wrap: wrap; justify-content: center; padding-bottom: 10px; border-bottom: 1px solid #333; }
        #chatContainer { flex: 1; width: 95%; background: #1a1a1a; border-radius: 10px 10px 0 0; margin-top: auto; display: flex; flex-direction: column; border-top: 2px solid #333; }
        #chatMessages { flex: 1; overflow-y: auto; text-align: left; padding: 10px; font-size: 14px; color: #ccc; max-height: 20vh; }
        .chat-input-area { display: flex; width: 100%; }
        .msg-sys { color: #fdd835; font-style: italic; }
        .msg-usr { color: #fff; }

        #pocketMode { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9000; }
        @keyframes pulse { 0% { background-color: #b71c1c; } 50% { background-color: #ff0000; } 100% { background-color: #b71c1c; } }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen" style="display:flex;">
        <h2 style="color:#00C853;">BELLGO CONNECT</h2>
        
        <input type="text" id="storeName" placeholder="ÎŒÎ½Î¿Î¼Î± ÎœÎ±Î³Î±Î¶Î¹Î¿Ï (Î”Ï‰Î¼Î¬Ï„Î¹Î¿)">
        <input type="text" id="username" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï… (Ï€.Ï‡. Î“Î¹ÏÏÎ³Î¿Ï‚)">
        <input type="password" id="password" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ (1234)" inputmode="numeric">

        <h3 style="margin-top:20px; color:#888;">Î•Î¯Î¼Î±Î¹:</h3>
        <div style="display:flex; width:100%; justify-content:center;">
            <button class="btn btn-green" style="width:40%;" onclick="attemptLogin('admin')">ADMIN</button>
            <button class="btn btn-blue" style="width:40%;" onclick="attemptLogin('staff')">Î”Î™Î‘ÎÎŸÎœÎ— / Î£Î•Î¡Î’Î™Î£</button>
        </div>
        <p id="loginError" style="color:red; display:none;">Î›Î¬Î¸Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚!</p>
    </div>

    <div id="adminScreen" class="screen">
        <h3 id="adminHeader">Panel Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚</h3>
        
        <button class="btn btn-red" onclick="triggerAlarm(null)">ğŸ”” Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î— Î£Î• ÎŸÎ›ÎŸÎ¥Î£</button>
        <p style="color:#888; font-size:12px;">Î® Ï€Î¬Ï„Î± ÏŒÎ½Î¿Î¼Î± Î³Î¹Î± Î±Ï„Î¿Î¼Î¹ÎºÎ® ÎºÎ»Î®ÏƒÎ·:</p>
        
        <div id="usersContainer">
            <p style="color:#555;">Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± ÏƒÏ…Î½Î´Î­ÏƒÎµÎ¹Ï‚...</p>
        </div>

        <div id="chatContainer">
            <div id="chatMessages"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInputAdmin" placeholder="ÎœÎ®Î½Ï…Î¼Î±..." style="margin:0; border-radius:0;">
                <button class="btn btn-blue" style="width:60px; margin:0; border-radius:0;" onclick="sendChat('admin')">></button>
            </div>
        </div>
    </div>

    <div id="receiverScreen" class="screen">
        <div style="font-size: 60px;">ğŸ‘¨â€ğŸ³</div>
        <h2 id="receiverHeader">Î‘Î½Î±Î¼Î¿Î½Î®...</h2>
        <p style="color:#666; font-size:12px;">Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ ÏƒÏ„Î¿: <span id="storeLabel"></span></p>

        <button onclick="togglePocketMode(true)" style="margin-top:20px; background:#222; color:#888; border:1px solid #444; padding:15px; border-radius:10px; width:60%;">ğŸ”’ Fake Lock</button>

        <div id="chatContainer" style="height: 30vh; margin-top: auto;">
            <div id="chatMessagesReceiver" style="flex:1; overflow-y:auto; text-align:left; padding:10px; font-size:14px; color:#ccc;"></div>
            <div class="chat-input-area">
                <input type="text" id="chatInputReceiver" placeholder="ÎœÎ®Î½Ï…Î¼Î±..." style="margin:0; border-radius:0;">
                <button class="btn btn-blue" style="width:60px; margin:0; border-radius:0;" onclick="sendChat('receiver')">></button>
            </div>
        </div>
    </div>

    <div id="stopOverlay" class="stop-overlay">
        <h1 style="color:white; font-size:50px; margin-bottom:20px;">ğŸ“ ÎšÎ›Î—Î£Î—!</h1>
        <h2 id="callerName" style="color:yellow; margin-bottom:30px;">Î±Ï€ÏŒ Admin</h2>
        <button class="btn btn-stop-big" onclick="stopAlarm()">STOP</button>
    </div>

    <div id="pocketMode" onclick="togglePocketMode(false)">
        <div style="position:absolute; bottom:50px; width:100%; text-align:center; color:#333; font-size:12px;">Double Tap to Unlock</div>
    </div>

    <audio id="alertPlayer" preload="auto" loop playsinline><source src="alert.mp3" type="audio/mpeg"></audio>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        let myRole = '';
        let myName = '';
        let isRinging = false;
        let vibrationInterval = null;
        let audioContext = null;

        // --- 1. LOGIN LOGIC ---
        function attemptLogin(role) {
            const store = document.getElementById('storeName').value.trim();
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            
            if (!store || !user) { alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï€ÎµÎ´Î¯Î±!"); return; }
            if (pass !== '1234') { 
                document.getElementById('loginError').style.display = 'block';
                return;
            }

            // ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î± ÏƒÏ…ÏƒÏ„Î®Î¼Î±Ï„Î± (Audio/Bot) Î¤Î©Î¡Î‘ Ï€Î¿Ï… Ï€Î¬Ï„Î·ÏƒÎµ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚
            initSystem(role);

            // Î£Ï„Î­Î»Î½Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ server
            socket.emit('join-store', { storeName: store, username: user, role: role });
            
            // UI Switch
            document.getElementById('loginScreen').style.display = 'none';
            myRole = role;
            myName = user;
            document.getElementById('storeLabel').innerText = store;

            if (role === 'admin') {
                document.getElementById('adminScreen').style.display = 'flex';
                document.getElementById('adminHeader').innerText = "Admin: " + user;
            } else {
                document.getElementById('receiverScreen').style.display = 'flex';
                document.getElementById('receiverHeader').innerText = "Î“ÎµÎ¹Î± ÏƒÎ¿Ï… " + user;
            }
        }

        // --- 2. ADMIN LOGIC (User List) ---
        socket.on('update-user-list', (users) => {
            if (myRole !== 'admin') return;

            const container = document.getElementById('usersContainer');
            container.innerHTML = ''; // ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚

            // Î¦Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ Î³Î¹Î± ÎºÎ¬Î¸Îµ Staff (ÏŒÏ‡Î¹ Î³Î¹Î± Î¬Î»Î»Î¿Ï…Ï‚ admin)
            users.forEach(u => {
                if (u.role === 'staff') {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-user';
                    btn.innerHTML = `ğŸ”” <b>${u.name}</b>`;
                    btn.onclick = () => triggerAlarm(u.id); // ÎšÎ»Î®ÏƒÎ· ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï… ID
                    container.appendChild(btn);
                }
            });

            if (container.innerHTML === '') {
                container.innerHTML = '<p style="color:#555;">ÎšÎ±Î½ÎµÎ¯Ï‚ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚...</p>';
            }
        });

        function triggerAlarm(targetId) {
            // Î‘Î½ targetId == null, Ï‡Ï„Ï…Ï€Î¬ÎµÎ¹ ÏƒÎµ ÏŒÎ»Î¿Ï…Ï‚
            socket.emit('trigger-alarm', { targetId: targetId });
            
            // Feedback ÎºÎ¿Ï…Î¼Ï€Î¹Î¿Ï (Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ)
            // Î”ÎµÎ½ Î¼Ï€Î»Î¿ÎºÎ¬ÏÎ¿Ï…Î¼Îµ Ï„Î¿ UI Î³Î¹Î± Î½Î± Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€Î±Ï„Î¬Ï‚ Î³ÏÎ®Î³Î¿ÏÎ±
        }

        // --- 3. RECEIVER LOGIC (Alarm) ---
        socket.on('ring-bell', (data) => {
            if (isRinging) return;
            isRinging = true;

            const sender = data.sender || "Admin";
            document.getElementById('callerName').innerText = "Î‘Ï€ÏŒ: " + sender;

            // 1. Wake Up Fully Kiosk
            if (window.fully) {
                fully.turnScreenOn();
                fully.bringToForeground();
            }

            // 2. Remove Pocket Mode
            togglePocketMode(false);

            // 3. Show Overlay
            document.getElementById('stopOverlay').style.display = 'flex';

            // 4. Sound & Vibrate
            const player = document.getElementById('alertPlayer');
            player.currentTime = 0;
            player.volume = 1.0;
            player.play().catch(e => console.log(e));
            startVibration();
        });

        function stopAlarm() {
            if (!isRinging) return;
            isRinging = false;
            
            const player = document.getElementById('alertPlayer');
            player.pause();
            player.currentTime = 0;
            stopVibration();

            document.getElementById('stopOverlay').style.display = 'none';
        }

        // --- 4. CHAT LOGIC ---
        function sendChat(view) {
            const inputId = view === 'admin' ? 'chatInputAdmin' : 'chatInputReceiver';
            const input = document.getElementById(inputId);
            const msg = input.value.trim();
            if (msg) {
                socket.emit('send-chat', msg);
                input.value = '';
            }
        }

        socket.on('chat-message', (data) => {
            const line = document.createElement('div');
            line.style.marginBottom = "5px";
            
            if (data.sender === 'System') {
                line.className = 'msg-sys';
                line.innerText = `[INFO] ${data.text}`;
            } else {
                line.className = 'msg-usr';
                line.innerHTML = `<b>${data.sender}:</b> ${data.text}`;
            }

            // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ±Î¹ ÏƒÏ„Î± Î´ÏÎ¿ views (Î³Î¹Î± ÏƒÎ¹Î³Î¿Ï…ÏÎ¹Î¬)
            const box1 = document.getElementById('chatMessages');
            const box2 = document.getElementById('chatMessagesReceiver');
            
            if(box1) { box1.appendChild(line.cloneNode(true)); box1.scrollTop = box1.scrollHeight; }
            if(box2) { box2.appendChild(line); box2.scrollTop = box2.scrollHeight; }
        });

        // --- 5. SYSTEM UTILS (Volume Buttons, Bot, etc) ---
        
        function initSystem(role) {
            // Audio Context Hack
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                const o = audioContext.createOscillator();
                const g = audioContext.createGain();
                g.gain.value = 0.0001;
                o.connect(g);
                g.connect(audioContext.destination);
                o.start();
            } catch(e) {}

            // Nav Bot (ÎœÏŒÎ½Î¿ Î±Î½ ÎµÎ¯Î½Î±Î¹ Staff/Receiver Ï„Î¿ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ¬, Î±Î»Î»Î¬ Ï„Î¿ Î²Î¬Î¶Î¿Ï…Î¼Îµ Ï€Î±Î½Ï„Î¿Ï)
            if (role === 'staff') {
                startNavBot();
                if (window.fully) {
                    fully.bind('onScreensaverStart', 'fully.stopScreensaver()');
                    fully.turnScreenOn();
                }
            }
        }

        // Volume Buttons = Stop
        window.addEventListener('keydown', (e) => {
            // 179=PlayPause, 24=VolUp, 85=Media, 13=Enter
            const stopKeys = [179, 24, 85, 13]; 
            if (stopKeys.includes(e.keyCode) || e.key === 'VolumeUp') {
                if (isRinging) {
                    stopAlarm();
                    e.preventDefault();
                }
            }
        });

        function startNavBot() {
            if ("geolocation" in navigator) {
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        (p) => console.log("Bot Pulse"), 
                        (e) => console.log("Bot Err"),
                        {enableHighAccuracy:true}
                    );
                }, 20000);
            }
        }

        function startVibration() {
            if (navigator.vibrate) navigator.vibrate([1000, 200, 1000]);
            if (vibrationInterval) clearInterval(vibrationInterval);
            vibrationInterval = setInterval(() => {
                if (navigator.vibrate) navigator.vibrate([1000, 200, 1000]);
            }, 2500);
        }

        function stopVibration() {
            if (vibrationInterval) clearInterval(vibrationInterval);
            if (navigator.vibrate) navigator.vibrate(0);
        }

        function togglePocketMode(enable) {
            document.getElementById('pocketMode').style.display = enable ? 'block' : 'none';
        }
    </script>
</body>
</html>
