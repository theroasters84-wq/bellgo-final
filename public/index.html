<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Ultimate</title>
    <style>
        /* --- CSS STYLES --- */
        body { background-color: #121212; color: #ffffff; font-family: 'Segoe UI', sans-serif; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        /* Buttons */
        .btn { padding: 20px; font-size: 20px; border: none; border-radius: 12px; margin: 10px; cursor: pointer; width: 85%; max-width: 350px; font-weight: bold; touch-action: manipulation; box-shadow: 0 4px 6px rgba(0,0,0,0.3); color: white; transition: transform 0.1s; }
        .btn:active { transform: scale(0.96); }
        .btn-sender { background-color: #00C853; }
        .btn-receiver { background-color: #2962FF; }
        .btn-pip { background-color: #9C27B0; font-size: 16px; margin-top: 20px; }
        .btn-fake-lock { background-color: #424242; color: #aaa; font-size: 14px; margin-top: 10px; width: auto; padding: 10px 20px; }
        .btn-stop { background-color: #D50000; display: none; margin-top: 30px; animation: pulse 0.8s infinite; font-size: 24px; padding: 30px; }
        .btn-logout { position: absolute; top: 15px; right: 15px; background: transparent; color: #666; border: 1px solid #444; padding: 5px 10px; font-size: 12px; border-radius: 5px; }

        /* Screens */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        #setupScreen { display: flex; }

        /* Fake Lock Overlay */
        #fakeLockOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: black; z-index: 9999; }
        #fakeLockText { position: absolute; bottom: 30px; width: 100%; text-align: center; color: #333; font-size: 12px; }

        /* Animations & Visuals */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .alarm-active { background-color: #ff0000 !important; }
        .strobe { animation: strobe-anim 0.2s infinite; }
        @keyframes strobe-anim { 0% { background-color: red; } 50% { background-color: white; } 100% { background-color: red; } }

        /* Hidden Elements for PiP */
        #pipVideo { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="setupScreen" class="screen">
        <h2 style="margin-bottom: 40px;">BellGo Ultimate</h2>
        <button class="btn btn-sender" onclick="initMode('sender')">ðŸ”” Î ÎŸÎœÎ ÎŸÎ£ (Waiter)</button>
        <button class="btn btn-receiver" onclick="initMode('receiver')">ðŸ‘‚ Î”Î•ÎšÎ¤Î—Î£ (Kitchen)</button>
        <p style="color: #444; margin-top: 40px; font-size: 12px;">v3.0 All Hacks Included</p>
    </div>

    <div id="senderScreen" class="screen">
        <button class="btn-logout" onclick="location.reload()">Exit</button>
        <h1>Î ÎŸÎœÎ ÎŸÎ£</h1>
        <button class="btn btn-sender" id="triggerBtn" onclick="sendAlert()">ðŸ”” ÎšÎ›Î—Î£Î—</button>
        <p id="senderStatus" style="color: #888; margin-top: 20px;">ÎˆÏ„Î¿Î¹Î¼Î¿</p>
    </div>

    <div id="receiverScreen" class="screen">
        <button class="btn-logout" onclick="location.reload()">Exit</button>
        <h1>Î”Î•ÎšÎ¤Î—Î£</h1>
        
        <div style="font-size: 60px; margin: 10px;">ðŸ‘‚</div>
        <p id="statusText" style="color: #aaa;">Î‘Î½Î±Î¼Î¿Î½Î®...</p>

        <button class="btn btn-pip" onclick="togglePiP()">ðŸ“º BACKGROUND MODE (PiP)</button>
        <button class="btn btn-fake-lock" onclick="toggleFakeLock(true)">ðŸ”’ Black Screen</button>

        <button class="btn btn-stop" id="stopBtn" onclick="stopAlarm()">ðŸ”• STOP ALARM</button>
    </div>

    <div id="fakeLockOverlay" onclick="toggleFakeLock(false)">
        <div id="fakeLockText">Tap twice or swipe to unlock</div>
    </div>

    <audio id="silencePlayer" loop playsinline>
        <source src="silence.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="alertPlayer" preload="auto" loop playsinline>
        <source src="alert.mp3" type="audio/mpeg">
    </audio>

    <canvas id="canvas" width="100" height="100" style="display:none;"></canvas>
    <video id="pipVideo" muted playsinline></video>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        let wakeLock = null;
        let heartbeatInterval = null;
        let vibrationInterval = null;

        // --- 1. VIBRATION LOGIC ---
        function startVibration() {
            if (navigator.vibrate) {
                if (vibrationInterval) clearInterval(vibrationInterval);
                // Pattern: Buzz (500ms) - Wait (200ms) - Buzz (500ms) - Wait (1000ms)
                const pattern = [500, 200, 500, 1000];
                navigator.vibrate(pattern);
                
                // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î´Î¹Î¬ÏÎºÎµÎ¹Î±Ï‚ pattern Î³Î¹Î± Ï„Î¿ Loop
                const totalDuration = pattern.reduce((a, b) => a + b, 0);
                
                vibrationInterval = setInterval(() => {
                    navigator.vibrate(pattern);
                }, totalDuration);
            }
        }

        function stopVibration() {
            if (vibrationInterval) clearInterval(vibrationInterval);
            if (navigator.vibrate) navigator.vibrate(0);
        }

        // --- 2. PiP HACK (Background Persistence) ---
        const canvas = document.getElementById('canvas');
        const video = document.getElementById('pipVideo');
        const ctx = canvas.getContext('2d');
        let pipColorToggle = false;

        // Î¦Ï„Î¹Î¬Ï‡Î½Î¿Ï…Î¼Îµ Î¼Î¹Î± ÏÎ¿Î® Î²Î¯Î½Ï„ÎµÎ¿ Î±Ï€ÏŒ Ï„Î¿ Canvas
        ctx.fillStyle = 'green';
        ctx.fillRect(0, 0, 100, 100);
        const stream = canvas.captureStream(10); // 10 FPS ÎµÎ¯Î½Î±Î¹ Î±ÏÎºÎµÏ„Î¬
        video.srcObject = stream;

        // Loop Î¶Ï‰Î³ÏÎ±Ï†Î¹ÎºÎ®Ï‚ Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÎµÎ½ÎµÏÎ³ÏŒ Ï„Î¿ Î²Î¯Î½Ï„ÎµÎ¿
        setInterval(() => {
            pipColorToggle = !pipColorToggle;
            ctx.fillStyle = pipColorToggle ? '#00C853' : '#2962FF'; // Î ÏÎ¬ÏƒÎ¹Î½Î¿ / ÎœÏ€Î»Îµ
            ctx.fillRect(0, 0, 100, 100);
            
            // Î“ÏÎ¬Ï†Î¿Ï…Î¼Îµ ÎºÎ±Î¹ Ï„Î·Î½ ÏŽÏÎ± Î³Î¹Î± Î½Î± Î±Î»Î»Î¬Î¶ÎµÎ¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î· ÎµÎ¹ÎºÏŒÎ½Î±
            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            ctx.fillText("LIVE", 20, 55);
        }, 1000);

        async function togglePiP() {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await video.play();
                    await video.requestPictureInPicture();
                }
            } catch (error) {
                console.error(error);
                alert("Î¤Î¿ PiP Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î® Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Ï€Î±Ï„Î·Î¸ÎµÎ¯ Ï„Î¿ Play.");
            }
        }

        // --- 3. MEDIA SESSION & NOTIFICATIONS ---
        function setupAdvancedBackground() {
            // Media Session Metadata
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'BellGo Alert System',
                    artist: 'Active Connection',
                    album: 'Kitchen'
                });
                navigator.mediaSession.setActionHandler('play', () => {});
                navigator.mediaSession.setActionHandler('pause', () => {});
            }

            // Notifications
            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        // --- 4. ANTI-SLEEP & INIT ---
        async function enableAntiSleep() {
            // Audio Loop
            const silence = document.getElementById('silencePlayer');
            silence.volume = 0.01;
            try { await silence.play(); } catch(e) {}

            // Screen WakeLock
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (e) {}

            // Heartbeat
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if (socket.connected) socket.emit('keep-alive');
            }, 30000);
        }

        function initMode(mode) {
            enableAntiSleep();
            setupAdvancedBackground();

            document.getElementById('setupScreen').style.display = 'none';
            
            if (mode === 'sender') {
                document.getElementById('senderScreen').style.display = 'flex';
            } else {
                document.getElementById('receiverScreen').style.display = 'flex';
                setupReceiverLogic();
            }
        }

        // --- 5. SENDER ---
        function sendAlert() {
            const btn = document.getElementById('triggerBtn');
            btn.disabled = true;
            btn.innerText = "Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î—...";
            btn.style.opacity = "0.7";

            socket.emit('trigger-alarm');

            setTimeout(() => {
                btn.disabled = false;
                btn.innerText = "ðŸ”” ÎšÎ›Î—Î£Î—";
                btn.style.opacity = "1";
                document.getElementById('senderStatus').innerText = "Î£Ï„Î¬Î»Î¸Î·ÎºÎµ: " + new Date().toLocaleTimeString();
            }, 1000);
        }

        // --- 6. RECEIVER ---
        function setupReceiverLogic() {
            socket.on('ring-bell', () => {
                console.log("ALARM RECEIVED!");
                
                // A. ÎžÏ…Ï€Î½Î¬Î¼Îµ Î¿Î¸ÏŒÎ½Î· (Î±Î½ ÎµÎ¯Î½Î±Î¹ ÏƒÎµ Fake Lock)
                toggleFakeLock(false);

                // B. Î‰Ï‡Î¿Ï‚ (Loop Î¼Î­ÏƒÏ‰ HTML)
                const alertPlayer = document.getElementById('alertPlayer');
                alertPlayer.currentTime = 0;
                alertPlayer.volume = 1.0;
                alertPlayer.play().catch(e => console.log("Audio requires interaction"));

                // C. Visuals
                document.body.classList.add('alarm-active'); // ÎšÏŒÎºÎºÎ¹Î½Î¿ Ï†ÏŒÎ½Ï„Î¿
                document.body.classList.add('strobe'); // Flash effect
                document.getElementById('stopBtn').style.display = 'block';

                // D. Î”ÏŒÎ½Î·ÏƒÎ· (Loop)
                startVibration();

                // E. Notification (Î‘Î½ ÎµÎ¯Î½Î±Î¹ background)
                if (document.hidden && Notification.permission === "granted") {
                    const notif = new Notification("ðŸš¨ ÎšÎŸÎ¥Î”ÎŸÎ¥ÎÎ™!", {
                        body: "Î£Îµ Ï†Ï‰Î½Î¬Î¶Î¿Ï…Î½ Î±Ï€ÏŒ Ï„Î· ÏƒÎ¬Î»Î±!",
                        tag: 'alarm',
                        renotify: true
                    });
                    notif.onclick = () => { window.focus(); notif.close(); };
                }
            });
        }

        function stopAlarm() {
            const alertPlayer = document.getElementById('alertPlayer');
            alertPlayer.pause();
            alertPlayer.currentTime = 0;
            
            stopVibration();
            
            document.body.classList.remove('alarm-active');
            document.body.classList.remove('strobe');
            document.getElementById('stopBtn').style.display = 'none';
        }

        // --- 7. FAKE LOCK ---
        function toggleFakeLock(enable) {
            const overlay = document.getElementById('fakeLockOverlay');
            if (enable) {
                overlay.style.display = 'block';
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(e=>{});
                }
            } else {
                overlay.style.display = 'none';
                if (document.exitFullscreen && document.fullscreenElement) {
                    document.exitFullscreen().catch(e=>{});
                }
            }
        }
    </script>
</body>
</html>
