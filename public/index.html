<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BellGo Ultra</title>
<link rel="manifest" href="manifest.json">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
body{margin:0;background:#121212;color:#fff;font-family:Segoe UI, sans-serif;height:100dvh;overflow:hidden}
#loginScreen,#alarmOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
#alarmOverlay{display:none;z-index:9999;flex-direction:column;background:red;animation:flash 0.5s infinite}
@keyframes flash{0%{background:#b71c1c}50%{background:#000}100%{background:#b71c1c}}
.stop-btn{width:220px;height:220px;border-radius:50%;font-size:40px;font-weight:900}
.media-hidden{position:fixed;width:1px;height:1px;opacity:.01;pointer-events:none}
</style>
</head>

<body>

<div class="media-hidden">
<audio id="mainAudio" loop playsinline onvolumechange="AudioEngine.handleVolumeChange()"></audio>
<video id="videoDummy" loop muted playsinline>
<source src="data:video/mp4;base64,AAAA" type="video/mp4">
</video>
</div>

<div id="loginScreen">
<button onclick="App.userGesture()" style="font-size:28px;padding:30px">ğŸ“ Î‘Î ÎŸÎ”ÎŸÎ§Î—</button>
</div>

<div id="alarmOverlay" onclick="AudioEngine.stopAlarm(true)">
<div style="font-size:32px;margin-bottom:20px">ğŸš¨ ÎšÎ›Î—Î£Î— ÎšÎŸÎ¥Î–Î™ÎÎ‘Î£</div>
<button class="stop-btn">STOP</button>
</div>

<script>
/* ğŸ”¥ FIREBASE */
firebase.initializeApp({
 apiKey:"AIzaSyDyqu5tLS2hY3kS1XvHOrfw8CatB_mwI9A",
 authDomain:"bellgofinall.firebaseapp.com",
 projectId:"bellgofinall",
 messagingSenderId:"654570848224",
 appId:"1:654570848224:web:50704c332d885e3a0df585"
});
const messaging=firebase.messaging();

/* ğŸ”Š AUDIO ENGINE */
const AudioEngine={
 player:document.getElementById('mainAudio'),
 video:document.getElementById('videoDummy'),
 isRinging:false,
 ignore:false,
 init(){
  this.player.src='silence.mp3';
  this.player.volume=.1;
  this.player.loop=true;
  this.player.play().catch(()=>{});
  this.player.onpause=()=>{if(!this.isRinging)this.player.play().catch(()=>{})};
  this.video.play().catch(()=>{});

  if('mediaSession'in navigator){
   navigator.mediaSession.metadata=new MediaMetadata({title:"BellGo Active"});
   navigator.mediaSession.playbackState="playing";
   ['play','pause','stop','nexttrack','previoustrack']
    .forEach(a=>navigator.mediaSession.setActionHandler(a,()=>this.stopAlarm(true)));
  }

  // keep alive
  setInterval(()=>{
   if(!this.isRinging){
    this.player.currentTime=0;
    navigator.mediaSession.playbackState="playing";
   }
  },6000);
 },
 handleVolumeChange(){
  if(this.isRinging&&!this.ignore)this.stopAlarm(true);
 },
 triggerAlarm(){
  if(this.isRinging)return;
  this.isRinging=true;
  this.player.src='alert.mp3';
  this.player.volume=1;
  this.player.play().catch(()=>{});
  this.ignore=true;setTimeout(()=>this.ignore=false,120);
  navigator.vibrate?.([2000,100]);
  document.getElementById('alarmOverlay').style.display='flex';
 },
 stopAlarm(){
  this.isRinging=false;
  this.player.src='silence.mp3';
  this.player.volume=.1;
  this.player.play().catch(()=>{});
  navigator.vibrate?.(0);
  document.getElementById('alarmOverlay').style.display='none';
 }
};

/* ğŸ‘† USER GESTURE */
const App={
 userGesture(){
  document.getElementById('loginScreen').remove();
  AudioEngine.init();
  Notification.requestPermission();
  messaging.getToken({
   vapidKey:"BFTvD95gbSR0A2hzE1pqOvo9KXGvpR3oI4M3I64N1VeqWBMeYtKUN96zb9XEZ-UuNzhc-KgQMACFQFG8MJE-RN4"
  }).then(t=>console.log("FCM:",t));
 }
};

/* ğŸ“© FOREGROUND */
messaging.onMessage(()=>AudioEngine.triggerAlarm());

/* ğŸ”‹ WAKE */
setInterval(()=>{
 if('wakeLock'in navigator)
  navigator.wakeLock.request('screen').catch(()=>{});
},4000);

/* SW */
navigator.serviceWorker.register('/firebase-messaging-sw.js');
</script>

</body>
</html>
