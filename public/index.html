<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Ultra v40</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        .btn-apk-landing { position: absolute; top: 20px; right: 20px; text-decoration: none; color: #00E676; border: 1px solid #00E676; padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; background: rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(4px); }
        #loginScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: #121212; z-index: 100; position: absolute; top: 0; left: 0; }
        h1 { margin-bottom: 30px; color: #00E676; font-size: 32px; }
        .role-switch { display: flex; gap: 10px; margin-bottom: 20px; }
        .role-btn { padding: 10px 20px; border: 1px solid #444; background: #222; color: white; border-radius: 20px; cursor: pointer; }
        .role-btn.active { background: #00E676; color: black; font-weight: bold; border-color: #00E676; }
        .login-form { width: 85%; display: flex; flex-direction: column; gap: 12px; }
        input, select { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; text-align: center; }
        .btn-google { width: 100%; padding: 15px; background: #DB4437; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-login { width: 100%; padding: 15px; background: #00E676; color: black; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #mainApp { display: none; flex-direction: column; height: 100%; width: 100%; }
        .header { height: 60px; background: #1e1e1e; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; flex-shrink: 0; }
        .status-dot { width: 14px; height: 14px; background: red; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 5px red; border: 2px solid white; transition: background 0.3s; }
        .user-info { display: flex; flex-direction: column; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn-apk-header { text-decoration: none; color: #00E676; border: 1px solid #00E676; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .btn-logout { background: #D32F2F; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-info { background: transparent; border: 1px solid #aaa; color: #aaa; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; font-family: monospace; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-right: 5px; }
        .content { flex: 1; display: flex; overflow: hidden; position: relative; }
        .staff-panel { flex: 1; background: #121212; overflow-y: auto; border-right: 1px solid #333; padding: 10px; display: none; flex-direction: column; }
        .staff-panel.active { display: flex; }
        .staff-row { display: flex; width: 100%; gap: 5px; margin-bottom: 10px; }
        .btn-staff { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 18px; color: white; text-align: left; background: #333; display: flex; justify-content: space-between; align-items: center; transition: transform 0.1s; cursor: pointer; }
        .btn-staff:active { transform: scale(0.98); }
        .btn-staff.waiter { background: #1565C0; border-left: 5px solid #64B5F6; }
        .btn-staff.driver { background: #C62828; border-left: 5px solid #FF5252; }
        .btn-staff.ghost { opacity: 0.8; border: 1px solid #757575; background: #222 !important; color: #ccc; }
        .btn-delete { width: 50px; background: #D32F2F; color: white; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .status { font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .chat-panel { flex: 1.5; display: flex; flex-direction: column; background: #0a0a0a; height: 100%; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 12px; color: white; font-size: 15px; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: #00E676; color: black; }
        .msg.other { align-self: flex-start; background: #333; }
        .chat-input { display: flex; padding: 10px; background: #1e1e1e; border-top: 1px solid #333; flex-shrink: 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .chat-input input { flex: 1; height: 45px; background: #333; color: white; border: 1px solid #444; border-radius: 20px; padding: 0 15px; }
        .chat-input button { width: 50px; margin-left: 10px; border-radius: 50%; background: #00E676; border: none; font-size: 20px; color: black; height: 45px; cursor: pointer; }
        #alarmOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; background: red; animation: flashBg 0.5s infinite; }
        @keyframes flashBg { 0% { background: #D50000; } 50% { background: #000000; } 100% { background: #D50000; } }
        .stop-btn { width: 220px; height: 220px; border-radius: 50%; background: white; color: red; font-size: 40px; font-weight: 900; border: 8px solid yellow; box-shadow: 0 0 60px rgba(255,255,255,0.8); cursor: pointer; animation: pulseBtn 0.8s infinite; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .time-badge { background: black; color: yellow; padding: 5px 15px; border-radius: 10px; font-size: 24px; font-weight: bold; margin-bottom: 20px; border: 2px solid yellow; }
        #infoModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; flex-direction:column; align-items:center; justify-content:center; padding:20px; text-align:center; }
        .info-box { background:#222; border:1px solid #444; padding:25px; border-radius:15px; max-width:90%; }
        .info-close { margin-top:20px; padding:10px 30px; background:#00E676; color:black; font-weight:bold; border:none; border-radius:20px; cursor:pointer; }
    </style>
</head>
<body>
    <a href="https://github.com/theroasters84-wq/bellgo-final/releases/latest/download/app-release.apk" id="apkLanding" class="btn-apk-landing" target="_blank">ğŸ“² APP</a>

    <div id="loginScreen">
        <h1>ğŸ”” BellGo</h1>
        <div class="role-switch">
            <button class="role-btn active" id="btnRoleStaff" onclick="UI.showStaffLogin()">Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒ</button>
            <button class="role-btn" id="btnRoleAdmin" onclick="UI.showAdminLogin()">Admin</button>
        </div>
        
        <div id="staffForm" class="login-form">
            <input type="email" id="inpStoreEmail" placeholder="Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ (Admin)">
            <input type="text" id="inpMyName" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
            <select id="inpMyRole">
                <option value="waiter">ğŸŸ¦ Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚</option>
                <option value="driver">ğŸŸ¥ Î”Î¹Î±Î½Î¿Î¼Î­Î±Ï‚</option>
            </select>
            <button class="btn-login" onclick="App.loginStaff()">Î£Î¥ÎÎ”Î•Î£Î—</button>
        </div>

        <div id="adminForm" class="login-form" style="display:none;">
            <p style="text-align:center; color:#ccc; font-size:14px; margin-bottom:10px;">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®</p>
            
            <input type="email" id="inpAdminManualEmail" placeholder="Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ (Ï€.Ï‡. info@cafe.gr)">
            <button class="btn-login" onclick="App.loginAdminManual()">Î•Î™Î£ÎŸÎ”ÎŸÎ£ (MANUAL)</button>
            
            <div style="margin: 15px 0; text-align: center; color: #444;">Î®</div>
            
            <button class="btn-google" onclick="App.loginAdminGoogle()"><span>G</span> Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google</button>
        </div>
    </div>

    <div id="mainApp">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <span id="connDot" class="status-dot" onclick="App.forceReconnect()" title="Reconnect"></span>
                <div class="user-info">
                    <span id="headerName" style="font-weight:bold; font-size:14px;">...</span>
                    <small id="headerStore" style="opacity:0.6; font-size:10px;">...</small>
                </div>
            </div>
            <div class="header-actions">
                <button id="infoBtn" class="btn-info" onclick="document.getElementById('infoModal').style.display='flex'" style="display:none;">i</button>
                <a href="https://github.com/theroasters84-wq/bellgo-final/releases/latest/download/app-release.apk" class="btn-apk-header" target="_blank">ğŸ“² APP</a>
                <button class="btn-logout" onclick="App.logout()">EXIT</button>
            </div>
        </div>
        <div class="content">
            <div id="staffPanel" class="staff-panel"><div id="staffList"></div></div>
            <div class="chat-panel">
                <div id="chatBox" class="chat-messages"><div style="text-align:center; opacity:0.5; margin-top:20px;">Chat Started</div></div>
                <div class="chat-input"><input type="text" id="msgInput" placeholder="Î“ÏÎ¬ÏˆÎµ ÎµÎ´Ï..." autocomplete="off"><button onclick="App.sendChat()">â¤</button></div>
            </div>
        </div>
    </div>

    <div id="alarmOverlay">
        <div id="alarmText" style="color:white; font-size:30px; margin-bottom:10px; font-weight:bold; text-align:center;">ğŸš¨ ÎšÎ›Î—Î£Î—!</div>
        <div id="alarmTimeBadge" class="time-badge">--:--</div>
        <button id="alarmBtn" class="stop-btn" onclick="App.acceptAlarm()"><span>STOP</span></button>
        <div id="alarmSubText" style="margin-top:20px; color:white; font-size:14px; text-align:center;">(Î Î¬Ï„Î± STOP Î³Î¹Î± Î‘Ï€Î¿Î´Î¿Ï‡Î®)</div>
    </div>

    <div id="infoModal">
        <div class="info-box">
            <h2 style="color:#00E676; margin-top:0;">â„¹ï¸ ÎŸÎ”Î—Î“Î™Î•Î£</h2>
            <p>Î‘Ï€Î¿Ï†ÏÎ³ÎµÏ„Îµ Î¬Î»Î»ÎµÏ‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î­Ï‚ Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®Ï‚.</p>
            <button class="info-close" onclick="document.getElementById('infoModal').style.display='none'">Î•ÎÎ¤Î‘ÎÎ•Î™</button>
        </div>
    </div>

    <script src="player.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
            authDomain: "bellgo-5dbe5.firebaseapp.com", 
            projectId: "bellgo-5dbe5", 
            storageBucket: "bellgo-5dbe5.firebasestorage.app", 
            messagingSenderId: "799314495253", 
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c",
            measurementId: "G-379ETZJP8H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const messaging = getMessaging(app);
        const provider = new GoogleAuthProvider();

        let isAlarmActive = false; 

        // --- STRIPE INIT (TEST KEY Î‘Î ÎŸ Î¦Î©Î¤ÎŸÎ“Î¡Î‘Î¦Î™Î‘) ---
        const stripe = Stripe('pk_test_51SwnsPJcEtNSGviLK0x04p4VbPFFETxpAN84nX0fmYAPrSVGRaeLdLnMc5WmYtYVeErvgIxKyzYJED4Q6aIv7WV9002gRiP0ay');

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log("ğŸ‘ï¸ App Woke Up (Foreground)");
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('type') === 'alarm') {
                    App.triggerAlarmScreen();
                    window.history.replaceState({}, document.title, "/");
                }
                if (socket && socket.connected) {
                    socket.emit('join-store', { 
                        storeName: userData.store, 
                        username: userData.name, 
                        role: userData.role, 
                        token: localStorage.getItem('fcm_token') 
                    });
                } else {
                    App.forceReconnect();
                }
            }
        });

        if ('mediaSession' in navigator) {
            const handleMediaAction = () => {
                if(isAlarmActive) {
                    if(navigator.vibrate) navigator.vibrate(50);
                    App.acceptAlarm();
                }
            };
            ['play', 'pause', 'stop', 'nexttrack'].forEach(a => navigator.mediaSession.setActionHandler(a, handleMediaAction));
        }

        async function setupNotifications() {
            if ('serviceWorker' in navigator) {
                try {
                    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.PushNotifications) {
                        const PushNotifications = window.Capacitor.Plugins.PushNotifications;
                        await PushNotifications.createChannel({
                            id: 'fcm_default_channel',
                            name: 'BellGo Urgent',
                            importance: 5, 
                            visibility: 1, 
                            sound: 'alert_sound',
                            vibration: true
                        });
                        PushNotifications.addListener('pushNotificationActionPerformed', () => {
                            App.triggerAlarmScreen(); 
                        });
                    }
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        const token = await getToken(messaging, { vapidKey: "BDUWH0UaYagUPXGB8BM59VFRBW8FMbgOy7YcbBHxT4aJ6rN0Jms-0dGWXIODGYWoSSHomos4gg1GOTZn6k70JcM", serviceWorkerRegistration: reg });
                        if (token) {
                            localStorage.setItem('fcm_token', token);
                            if (window.socket && window.socket.connected) {
                                window.socket.emit('update-token', { username: userData.name, token: token });
                            }
                        }
                    }
                } catch(e) { console.log("FCM Error:", e); }
            }
        }

        onMessage(messaging, (payload) => {
            console.log("ğŸ“© FCM received in foreground");
            if (!isAlarmActive) {
                App.triggerAlarmScreen();
            }
        });

        window.socket = null;
        window.userData = { store: '', name: '', role: '' };
        let isFirstLogin = true;

        window.UI = {
            showStaffLogin: () => {
                document.getElementById('btnRoleStaff').classList.add('active');
                document.getElementById('btnRoleAdmin').classList.remove('active');
                document.getElementById('staffForm').style.display = 'flex';
                document.getElementById('adminForm').style.display = 'none';
            },
            showAdminLogin: () => {
                document.getElementById('btnRoleStaff').classList.remove('active');
                document.getElementById('btnRoleAdmin').classList.add('active');
                document.getElementById('staffForm').style.display = 'none';
                document.getElementById('adminForm').style.display = 'flex';
            }
        };

        window.App = {
            loginStaff: () => {
                const store = document.getElementById('inpStoreEmail').value.trim().toLowerCase();
                const name = document.getElementById('inpMyName').value.trim();
                const role = document.getElementById('inpMyRole').value;
                if (!store || !name) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€ÎµÎ´Î¯Î±!");
                App.completeLogin({ store, name, role });
            },

            loginAdminGoogle: () => {
                signInWithPopup(auth, provider).then((result) => {
                    const user = result.user;
                    App.completeLogin({ store: user.email.toLowerCase(), name: "Admin", role: 'admin' });
                }).catch((error) => alert("Error: " + error.message));
            },

            // ÎÎ•ÎŸ: Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î¿ Login
            loginAdminManual: () => {
                const email = document.getElementById('inpAdminManualEmail').value.trim().toLowerCase();
                if (!email || !email.includes('@')) return alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚");

                App.completeLogin({ store: email, name: "Admin", role: 'admin' });
            },

            completeLogin: (user) => {
                userData = user;
                localStorage.setItem('bellgo_session', JSON.stringify(userData));
                App.finishLoginSequence();
            },

            finishLoginSequence: () => {
                document.getElementById('loginScreen').style.display = 'none';
                if(document.getElementById('apkLanding')) document.getElementById('apkLanding').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('headerName').innerText = userData.name;
                document.getElementById('headerStore').innerText = userData.store;
                
                if (userData.role === 'admin') document.getElementById('staffPanel').classList.add('active');
                else document.getElementById('infoBtn').style.display = 'flex';
                
                App.connectSocket();
                App.startHeartbeat();
                App.startLocationTracking();

                if(userData.role !== 'admin' && isFirstLogin) {
                    isFirstLogin = false;
                    setTimeout(() => App.triggerFakeAlarm(), 800);
                }

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('type') === 'alarm') {
                      setTimeout(() => App.triggerAlarmScreen(), 1000);
                      window.history.replaceState({}, document.title, "/");
                }
            },

            startLocationTracking: () => {
                if ('geolocation' in navigator && (userData.role === 'waiter' || userData.role === 'driver')) {
                    navigator.geolocation.watchPosition(
                        (pos) => { console.log("GPS KeepAlive"); }, 
                        (err) => {},
                        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
                    );
                }
            },

            triggerFakeAlarm: () => {
                const now = new Date();
                const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                document.getElementById('alarmTimeBadge').innerText = timeStr;
                document.getElementById('alarmText').innerText = "ğŸ”” Î£Î¥ÎÎ”Î•Î˜Î—ÎšÎ•!";
                document.getElementById('alarmSubText').innerText = "Î Î±Ï„Î®ÏƒÏ„Îµ STOP Î³Î¹Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î®Ï‡Î¿Ï…";
                document.getElementById('alarmOverlay').style.display = 'flex';
            },

            triggerAlarmScreen: () => {
                isAlarmActive = true; 
                if (window.AudioEngine) window.AudioEngine.triggerAlarm();
                
                const now = new Date();
                const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                document.getElementById('alarmTimeBadge').innerText = "ÎÏÎ±: " + timeStr;
                document.getElementById('alarmOverlay').style.display = 'flex';
                
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: 'ğŸš¨ ÎšÎ›Î—Î£Î— Î‘Î ÎŸ ÎšÎŸÎ¥Î–Î™ÎÎ‘',
                        artist: 'BellGo Alert',
                        artwork: [{ src: 'icon.png', sizes: '512x512', type: 'image/png' }]
                    });
                }
            },

            checkSession: () => {
                const saved = localStorage.getItem('bellgo_session');
                if (saved) {
                    userData = JSON.parse(saved);
                    setupNotifications();
                    App.finishLoginSequence(); 
                    document.body.addEventListener('click', () => {
                          if (userData.role !== 'admin' && window.AudioEngine) window.AudioEngine.init();
                    }, { once: true });
                }
            },

            connectSocket: () => {
                if (socket && socket.connected) return;
                socket = io({ transports: ['polling', 'websocket'], reconnection: true });
                window.socket = socket; 

                socket.on('connect', () => {
                    document.getElementById('connDot').style.background = '#00E676';
                    
                    const isNativeApp = !!window.Capacitor; 

                    socket.emit('join-store', { 
                        storeName: userData.store, 
                        username: userData.name, 
                        role: userData.role, 
                        token: localStorage.getItem('fcm_token'),
                        isNative: isNativeApp
                    });
                });

                // --- Î•Î›Î•Î“Î§ÎŸÎ£ Î£Î¥ÎÎ”Î¡ÎŸÎœÎ—Î£ (LISTENER) ---
                socket.on('subscription-required', (data) => {
                    App.handleSubscriptionError(data);
                });

                socket.on('disconnect', () => { document.getElementById('connDot').style.background = 'red'; });
                socket.on('ring-bell', () => App.triggerAlarmScreen());
                socket.on('staff-list-update', (list) => App.renderStaffList(list));
                socket.on('chat-message', (data) => App.renderChat(data));
                socket.on('staff-accepted-alarm', (data) => {
                    const span = document.getElementById(`status-${data.username}`);
                    if (span) { span.innerText = "âœ… Î•Î¡Î§Î•Î¤Î‘Î™"; span.style.color = "#00E676"; setTimeout(() => { span.innerText = "IDLE"; span.style.color = "white"; }, 8000); }
                });
            },

            handleSubscriptionError: (data) => {
                const proceed = confirm(`âš ï¸ Î¤Î¿ email ${data.email} Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®.\n\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± Ï€Î»Î·ÏÏÏƒÎµÏ„Îµ Ï„ÏÏÎ± (Test Mode - 10â‚¬);`);
                if (proceed) {
                    App.redirectToStripe(data.email);
                } else {
                    App.logout();
                }
            },

            redirectToStripe: async (email) => {
                try {
                    const response = await fetch('/create-checkout-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    const session = await response.json();
                    if (session.id) {
                        const result = await stripe.redirectToCheckout({ sessionId: session.id });
                        if (result.error) alert(result.error.message);
                    } else {
                        alert("Î£Ï†Î¬Î»Î¼Î± Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚.");
                    }
                } catch (e) { alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Stripe."); }
            },

            acceptAlarm: () => {
                isAlarmActive = false;
                if(window.AudioEngine) { AudioEngine.init(); AudioEngine.stopAlarm(true); }
                document.getElementById('alarmOverlay').style.display = 'none';
                
                const payload = { store: userData.store, username: userData.name };
                if (socket && socket.connected) {
                    socket.emit('alarm-accepted', payload);
                } else {
                    socket.connect(); 
                    socket.once('connect', () => socket.emit('alarm-accepted', payload));
                }
            },

            forceReconnect: () => { if(socket) { socket.disconnect(); setTimeout(() => socket.connect(), 300); } },
            startHeartbeat: () => { setInterval(() => { if (socket && socket.connected) socket.emit('heartbeat'); }, 3000); },
            
            logout: () => {
                if (socket) socket.emit('manual-logout');
                setTimeout(() => { localStorage.removeItem('bellgo_session'); window.location.reload(); }, 150);
            },

            renderStaffList: (serverList) => {
                const container = document.getElementById('staffList');
                container.innerHTML = '';
                if (userData.role !== 'admin') return;
                
                serverList.forEach(u => {
                    if (u.role === 'admin') return;
                    const row = document.createElement('div');
                    row.className = 'staff-row';
                    const btn = document.createElement('button');
                    const isAway = u.status === 'away';
                    
                    let btnClass = `btn-staff ${u.role}`;
                    let stTxt = "IDLE";
                    let stCol = "white";

                    if (u.isRinging) {
                        stTxt = "ğŸ“ ÎšÎ›Î—Î£Î—...";
                        stCol = "yellow";
                    } else if (isAway) {
                        stTxt = "âš ï¸ BACKGROUND";
                        stCol = "#FF9800";
                        btnClass += " ghost";
                    }

                    btn.className = btnClass;
                    btn.innerHTML = `<span>${u.username}</span><span class="status" id="status-${u.username}" style="color:${stCol}">${stTxt}</span>`;
                    
                    btn.onclick = () => {
                        socket.emit('trigger-alarm', u.username);
                        const span = document.getElementById(`status-${u.username}`);
                        if(span) { span.innerText = "ğŸ“ ÎšÎ›Î—Î£Î—..."; span.style.color = "yellow"; }
                    };
                    row.appendChild(btn);

                    if (isAway && !u.isRinging) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'btn-delete';
                        delBtn.innerText = 'X';
                        delBtn.onclick = () => {
                            if (confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï„Î¿Ï… ${u.username} Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î±;`)) {
                                socket.emit('manual-logout', { targetUser: u.username });
                            }
                        };
                        row.appendChild(delBtn);
                    }
                    container.appendChild(row);
                });
            },

            sendChat: () => {
                const inp = document.getElementById('msgInput');
                if (!inp.value.trim()) return;
                socket.emit('chat-message', { text: inp.value });
                inp.value = '';
            },

            renderChat: (data) => {
                const box = document.getElementById('chatBox');
                const div = document.createElement('div');
                div.className = `msg ${data.sender === userData.name ? 'me' : 'other'} ${data.role}`;
                div.innerHTML = `<strong>${data.sender}:</strong> ${data.text}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        };

        window.onload = () => App.checkSession();
    </script>
</body>
</html>
