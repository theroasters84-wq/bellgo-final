<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Final</title>
    <link rel="manifest" href="manifest.json"> 
    
    <link rel="stylesheet" href="style.css">

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
    
    <script src="elegxos-markas.js"></script>
    <script src="setup-bot.js"></script>
    <script src="logic.js"></script>

    <script>
        if ('serviceWorker' in navigator && typeof fully === 'undefined') {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/firebase-messaging-sw.js').catch(console.error);
            });
        }
    </script>
</head>
<body>
    
    <div id="setupBotBtn" onclick="SetupBot.run()">🤖</div>

    <div id="androidSetup">
        <div class="setup-box">
            <h1>🤖 Ρύθμιση Tablet</h1>
            <p style="color:yellow; font-weight:bold;">Ακολούθησε τα βήματα ΜΙΑ φορά:</p>
            <div class="setup-step">
                <h3>ΒΗΜΑ 1: Κατέβασμα</h3>
                <p>Κατέβασε την εφαρμογή Fully Kiosk</p>
                <button class="btn-blue" onclick="window.open('https://play.google.com/store/apps/details?id=de.ozerov.fully', '_blank')">📥 Download App</button>
            </div>
            <div class="setup-step">
                <h3>ΒΗΜΑ 2: Αυτόματο Άνοιγμα</h3>
                <p>Αφού την κατεβάσεις, πάτα εδώ για να ανοίξει αυτόματα η εφαρμογή με το URL έτοιμο!</p>
                <button class="btn-green" id="btnAutoOpen">🚀 ΑΝΟΙΓΜΑ ΣΤΟ FULLY</button>
            </div>
            <div class="setup-step">
                <h3>ΒΗΜΑ 3: Ρυθμίσεις</h3>
                <p style="text-align:left; font-size:12px; line-height: 1.6;">
                    1. Δώσε <b>ΟΛΑ</b> τα Permissions που ζητάει.<br>
                    2. Πάτα ξανά το κουμπί 🤖 μέσα από το Fully για να περαστούν οι ρυθμίσεις αυτόματα!
                </p>
            </div>
            <button class="btn-red" onclick="document.getElementById('androidSetup').style.display='none'">ΚΛΕΙΣΙΜΟ</button>
        </div>
    </div>

    <div id="step1" class="screen active">
        <h2>🏬 Όνομα Μαγαζιού</h2>
        <input type="text" id="inpStore" placeholder="">
        <button class="btn-green" onclick="nextStep(2)">Επόμενο</button>
    </div>
    
    <div id="step2" class="screen">
        <h2>👤 Το Όνομά σου</h2>
        <input type="text" id="inpName" placeholder="">
        <button class="btn-green" onclick="nextStep(3)">Επόμενο</button>
    </div>
    
    <div id="step3" class="screen">
        <h2>👔 Ο Ρόλος σου</h2>
        <button class="btn-green" onclick="nextStep(4, 'admin')">ADMIN (Κουζίνα)</button>
        <button class="btn-blue" onclick="nextStep(4, 'waiter')">ΣΕΡΒΙΤΟΡΟΣ</button>
        <button class="btn-orange" onclick="nextStep(4, 'driver')">ΔΙΑΝΟΜΕΑΣ</button>
    </div>
    
    <div id="step4" class="screen">
        <h2>🔑 Κωδικός</h2>
        <input type="password" id="inpPass" placeholder="" inputmode="numeric" pattern="[0-9]*">
        <button class="btn-green" onclick="forcePlayAndLogin()">ΕΙΣΟΔΟΣ</button>
        <p style="font-size: 12px; color: gray; margin-top: 20px;">*Πάτα "Allow" αν ζητηθεί</p>
    </div>

    <div id="mainApp">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <div id="connStatus"></div>
                <div id="userInfo" style="font-size: 14px;">User | Store</div>
            </div>
            <button class="btn-red" onclick="fullExit()">Exit</button>
        </div>
        <div class="content-area">
            <div id="listsPanel" class="lists-panel"><div id="staffListContainer"></div></div>
            <div class="chat-panel">
                <div id="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Μήνυμα...">
                    <button id="sendBtn" onclick="Logic.sendChat()">📩</button>
                </div>
            </div>
        </div>
    </div>

    <div id="alarmScreen" onclick="Watchdog.buttonAck()">
        <h1 style="color:white; font-size: 60px; font-weight:900;">🚨 ΚΛΗΣΗ!</h1>
        <button class="stop-btn">STOP</button>
    </div>

    <audio id="siren" src="alert.mp3" preload="auto"></audio>
    <audio id="silence" loop>
        <source src="silence.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Απλά βοηθητικά για την πλοήγηση στα μενού (UI)
        function nextStep(n, role) {
            if(role) localStorage.setItem('temp_role', role);
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('step'+n).classList.add('active');
        }

        function forcePlayAndLogin() {
            // Παίζει σιωπή για να ενεργοποιήσει τον ήχο
            const s = document.getElementById('silence');
            if(s) s.play().catch(e=>{});
            if(typeof fully !== 'undefined') fully.playSound("silence.mp3", true);
            
            // Τραβάει τα στοιχεία
            const store = document.getElementById('inpStore').value.trim();
            const name = document.getElementById('inpName').value.trim();
            const pass = document.getElementById('inpPass').value.trim();
            const role = localStorage.getItem('temp_role') || 'waiter';
            
            if(!store || !name || !pass) return alert("Συμπλήρωσε τα πάντα!");

            // Αποθήκευση
            localStorage.setItem('bellgo_user', JSON.stringify({store, name, role, pass}));
            
            // Εμφάνιση Main App
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('mainApp').classList.add('active');
            
            if (role !== 'admin') document.getElementById('listsPanel').style.display = 'none';
            else document.getElementById('listsPanel').style.display = 'block';
            
            // Καλεί το Logic.login() που είναι στο logic.js
            if(typeof Logic !== 'undefined') Logic.login(store, name, role, pass);
        }

        function fullExit() {
            if(typeof Logic !== 'undefined') Logic.logout();
            else location.reload();
        }

        // Αυτόματη είσοδος αν υπάρχει αποθηκευμένος χρήστης
        window.onload = function() {
            // Bot Check
            if(typeof SetupBot !== 'undefined') SetupBot.checkConfig();

            // Auto Login Check
            const saved = localStorage.getItem('bellgo_user');
            if(saved && document.getElementById('step1').classList.contains('active')) {
                const u = JSON.parse(saved);
                document.getElementById('inpStore').value = u.store;
                document.getElementById('inpName').value = u.name;
                document.getElementById('inpPass').value = u.pass;
                localStorage.setItem('temp_role', u.role);
                
                setTimeout(() => forcePlayAndLogin(), 500);
            }
        };
    </script>
</body>
</html>
