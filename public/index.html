<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
            authDomain: "bellgo-5dbe5.firebaseapp.com", 
            projectId: "bellgo-5dbe5", 
            storageBucket: "bellgo-5dbe5.firebasestorage.app", 
            messagingSenderId: "799314495253", 
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const messaging = getMessaging(app);
        const provider = new GoogleAuthProvider();

        async function setupNotifications() {
            if ('serviceWorker' in navigator) {
                try {
                    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        const token = await getToken(messaging, { vapidKey: "BDUWH0UaYagUPXGB8BM59VFRBW8FMbgOy7YcbBHxT4aJ6rN0Jms-0dGWXIODGYWoSSHomos4gg1GOTZn6k70JcM", serviceWorkerRegistration: reg });
                        if (token) localStorage.setItem('fcm_token', token);
                    }
                } catch(e) { console.log(e); }
            }
        }

        onMessage(messaging, () => App.triggerAlarmScreen());

        window.socket = null;
        window.userData = { store: '', name: '', role: '' };
        let isFirstLogin = true;

        window.UI = {
            showStaffLogin: () => {
                document.getElementById('btnRoleStaff').classList.add('active');
                document.getElementById('btnRoleAdmin').classList.remove('active');
                document.getElementById('staffForm').style.display = 'flex';
                document.getElementById('adminForm').style.display = 'none';
            },
            showAdminLogin: () => {
                document.getElementById('btnRoleStaff').classList.remove('active');
                document.getElementById('btnRoleAdmin').classList.add('active');
                document.getElementById('staffForm').style.display = 'none';
                document.getElementById('adminForm').style.display = 'flex';
            }
        };

        window.App = {
            loginStaff: () => {
                const store = document.getElementById('inpStoreEmail').value.trim().toLowerCase();
                const name = document.getElementById('inpMyName').value.trim();
                const role = document.getElementById('inpMyRole').value;
                if (!store || !name) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€ÎµÎ´Î¯Î±!");
                App.completeLogin({ store, name, role });
            },

            loginAdminGoogle: () => {
                // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Redirect Î³Î¹Î± Î½Î± Î´Î¿Ï…Î»ÎµÏÎµÎ¹ Ï€Î±Î½Ï„Î¿Ï (Mobile/Web)
                signInWithRedirect(auth, provider).catch(error => {
                    alert("Î£Ï†Î¬Î»Î¼Î± Î­Î½Î±ÏÎ¾Î·Ï‚ Google: " + error.message);
                });
            },

            completeLogin: (user) => {
                userData = user;
                localStorage.setItem('bellgo_session', JSON.stringify(userData));
                setupNotifications(); 
                App.finishLoginSequence();
            },

            finishLoginSequence: () => {
                document.getElementById('loginScreen').style.display = 'none';
                if(document.getElementById('apkLanding')) document.getElementById('apkLanding').style.display = 'none';
                
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('headerName').innerText = userData.name;
                document.getElementById('headerStore').innerText = userData.store;
                
                if (userData.role === 'admin') document.getElementById('staffPanel').classList.add('active');
                
                App.connectSocket();
                App.startHeartbeat();

                // Fake alarm Î¼ÏŒÎ½Î¿ Î³Î¹Î± Staff
                if(userData.role !== 'admin' && isFirstLogin) {
                    isFirstLogin = false;
                    setTimeout(() => App.triggerFakeAlarm(), 800);
                }
            },

            triggerFakeAlarm: () => {
                document.getElementById('alarmText').innerText = "ğŸ”” Î£Î¥ÎÎ”Î•Î˜Î—ÎšÎ•!";
                document.getElementById('alarmSubText').innerText = "Î Î±Ï„Î®ÏƒÏ„Îµ STOP Î³Î¹Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î®Ï‡Î¿Ï…";
                document.getElementById('alarmOverlay').style.display = 'flex';
            },

            triggerAlarmScreen: () => {
                if (window.AudioEngine) window.AudioEngine.triggerAlarm();
                document.getElementById('alarmText').innerText = "ğŸš¨ ÎšÎ›Î—Î£Î—!";
                document.getElementById('alarmSubText').innerText = "(Î Î¬Ï„Î± STOP Î³Î¹Î± Î‘Ï€Î¿Î´Î¿Ï‡Î®)";
                document.getElementById('alarmOverlay').style.display = 'flex';
            },

            checkSession: () => {
                // 1. Î Î¡Î©Î¤Î‘ Î•Î›Î•Î“Î§ÎŸÎ¥ÎœÎ• Î‘Î Î“Î¥Î¡Î™Î£Î‘ÎœÎ• Î‘Î ÎŸ GOOGLE REDIRECT
                getRedirectResult(auth)
                    .then((result) => {
                        if (result && result.user) {
                            // Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î± Î±Ï€ÏŒ Google!
                            App.completeLogin({ 
                                store: result.user.email.toLowerCase(), 
                                name: result.user.displayName || "Admin", 
                                role: 'admin' 
                            });
                        } else {
                            // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Google Redirect, ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ Ï„Î¿ LocalStorage
                            const saved = localStorage.getItem('bellgo_session');
                            if (saved) {
                                userData = JSON.parse(saved);
                                setupNotifications();
                                App.finishLoginSequence();
                                // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ notification click
                                if (window.location.search.includes('type=alarm')) {
                                    setTimeout(() => App.triggerAlarmScreen(), 1500);
                                }
                            }
                        }
                    })
                    .catch((error) => {
                        console.error("Google Auth Error:", error);
                        alert("Î£Ï†Î¬Î»Î¼Î± Google: " + error.message);
                    });
            },

            connectSocket: () => {
                if (socket && socket.connected) return;
                socket = io({ transports: ['polling', 'websocket'], reconnection: true });
                window.socket = socket; 

                socket.on('connect', () => {
                    document.getElementById('connDot').style.background = '#00E676';
                    socket.emit('join-store', { 
                        storeName: userData.store, 
                        username: userData.name, 
                        role: userData.role, 
                        token: localStorage.getItem('fcm_token') 
                    });
                });

                socket.on('disconnect', () => { document.getElementById('connDot').style.background = 'red'; });
                socket.on('ring-bell', () => App.triggerAlarmScreen());
                socket.on('staff-list-update', (list) => App.renderStaffList(list));
                socket.on('chat-message', (data) => App.renderChat(data));
                
                socket.on('staff-accepted-alarm', (data) => {
                    const span = document.getElementById(`status-${data.username}`);
                    if (span) {
                        span.innerText = "âœ… Î•Î¡Î§Î•Î¤Î‘Î™";
                        span.style.color = "#00E676";
                        setTimeout(() => { span.innerText = "IDLE"; span.style.color = "white"; }, 8000);
                    }
                });
            },

            acceptAlarm: () => {
                if(window.AudioEngine) { AudioEngine.init(); AudioEngine.stopAlarm(true); }
                document.getElementById('alarmOverlay').style.display = 'none';
                if (socket && socket.connected) socket.emit('alarm-accepted');
            },

            startHeartbeat: () => {
                setInterval(() => { if (socket && socket.connected) socket.emit('heartbeat'); }, 3000);
            },

            logout: () => {
                if (socket) socket.emit('manual-logout');
                // ÎœÎ¹ÎºÏÎ® ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ· Î³Î¹Î± Î½Î± Ï€ÏÎ¿Î»Î¬Î²ÎµÎ¹ Î½Î± Ï†ÏÎ³ÎµÎ¹ Ï„Î¿ ÏƒÎ®Î¼Î± ÏƒÏ„Î¿Î½ server
                setTimeout(() => {
                    localStorage.removeItem('bellgo_session');
                    window.location.reload();
                }, 150);
            },

            renderStaffList: (serverList) => {
                const container = document.getElementById('staffList');
                container.innerHTML = '';
                if (userData.role !== 'admin') return;

                serverList.forEach(u => {
                    if (u.role === 'admin') return;
                    const isAway = u.status === 'away';
                    
                    const btn = document.createElement('button');
                    // Î§ÏÏ‰Î¼Î±Ï„Î¹ÏƒÎ¼ÏŒÏ‚ ÏÏŒÎ»Ï‰Î½ ÎºÎ±Î¹ ghost
                    btn.className = `btn-staff ${u.role} ${isAway ? 'ghost' : ''}`;
                    
                    let stTxt = isAway ? "â“ BACKGROUND" : "IDLE";
                    let stCol = isAway ? "#ff9800" : "white";

                    btn.innerHTML = `<span>${u.username}</span><span class="status" id="status-${u.username}" style="color:${stCol}">${stTxt}</span>`;
                    
                    btn.onclick = () => {
                        socket.emit('trigger-alarm', u.username);
                        const span = document.getElementById(`status-${u.username}`);
                        if(span) { span.innerText = "ğŸ“ ÎšÎ›Î—Î£Î—..."; span.style.color = "yellow"; }
                    };
                    container.appendChild(btn);
                });
            },

            sendChat: () => {
                const inp = document.getElementById('msgInput');
                if (!inp.value.trim()) return;
                socket.emit('chat-message', { text: inp.value });
                inp.value = '';
            },

            renderChat: (data) => {
                const box = document.getElementById('chatBox');
                const div = document.createElement('div');
                // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎºÎ»Î¬ÏƒÎ·Ï‚ ÏÏŒÎ»Î¿Ï… Î³Î¹Î± Ï„Î¿ Ï‡ÏÏÎ¼Î± Ï„Î·Ï‚ ÎºÎ¬Î¸ÎµÏ„Î·Ï‚ Î³ÏÎ±Î¼Î¼Î®Ï‚
                div.className = `msg ${data.sender === userData.name ? 'me' : 'other'} ${data.role}`;
                div.innerHTML = `<strong>${data.sender}:</strong> ${data.text}`;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            }
        };

        window.onload = () => App.checkSession();
    </script>
