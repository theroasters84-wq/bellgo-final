<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Login</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100dvh; width: 100vw; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-apk-landing { position: absolute; top: 20px; right: 20px; text-decoration: none; color: #00E676; border: 1px solid #00E676; padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; background: rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(4px); }
        h1 { margin-bottom: 30px; color: #00E676; font-size: 32px; }
        .role-switch { display: flex; gap: 10px; margin-bottom: 20px; }
        .role-btn { padding: 10px 20px; border: 1px solid #444; background: #222; color: white; border-radius: 20px; cursor: pointer; }
        .role-btn.active { background: #00E676; color: black; font-weight: bold; border-color: #00E676; }
        .login-form { width: 85%; display: flex; flex-direction: column; gap: 12px; }
        input, select { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; text-align: center; }
        .btn-login { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: opacity 0.2s; }
        .btn-login:active { opacity: 0.8; }
        .btn-google { width: 100%; padding: 15px; background: #DB4437; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 5px; }
        .divider { text-align:center; margin: 5px 0; color:#444; font-size: 14px; }
    </style>
</head>
<body>
    <a href="https://github.com/theroasters84-wq/bellgo-final/releases/latest/download/app-release.apk" class="btn-apk-landing" target="_blank">ğŸ“² APP</a>

    <h1>ğŸ”” BellGo</h1>

    <div class="role-switch">
        <button class="role-btn active" id="btnRoleStaff" onclick="UI.showStaffLogin()">Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒ</button>
        <button class="role-btn" id="btnRoleAdmin" onclick="UI.showAdminLogin()">Admin</button>
    </div>

    <div id="staffForm" class="login-form">
        <input type="email" id="inpStoreEmail" placeholder="Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ (Admin)">
        <input type="text" id="inpMyName" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
        <select id="inpMyRole">
            <option value="waiter">ğŸŸ¦ Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚</option>
            <option value="driver">ğŸŸ¥ Î”Î¹Î±Î½Î¿Î¼Î­Î±Ï‚</option>
        </select>
        <button class="btn-login" style="background: #00E676; color: black;" onclick="App.loginStaff()">Î£Î¥ÎÎ”Î•Î£Î—</button>
    </div>

    <div id="adminForm" class="login-form" style="display:none;">
        <p style="text-align:center; color:#ccc; font-size:14px; margin-bottom:5px;">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚</p>
        
        <input type="email" id="inpAdminManualEmail" placeholder="Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚">
        
        <button class="btn-login" style="background: #00E676; color: black;" onclick="App.loginAdminManual()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>

        <button class="btn-login" style="background: #9C27B0; color: white;" onclick="App.redirectToStripe()">ğŸ’³ Î Î›Î—Î¡Î©ÎœÎ—</button>

        <div class="divider">Î®</div>

        <button class="btn-google" onclick="App.loginAdminGoogle()"><span>G</span> Î£ÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Google</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Stripe API Key
        const stripe = Stripe('pk_test_51SwnsPJcEtNSGviLKOxO4p4VbPFFETxpAN84nX0fmYAPrSVGRaeLdLnMc5WmYtYVeErvgIxKyzYJED4Q6aIv7WV9002gRiPOay');

        const firebaseConfig = { 
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
            authDomain: "bellgo-5dbe5.firebaseapp.com", 
            projectId: "bellgo-5dbe5", 
            storageBucket: "bellgo-5dbe5.firebasestorage.app", 
            messagingSenderId: "799314495253", 
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.UI = {
            showStaffLogin: () => {
                document.getElementById('btnRoleStaff').classList.add('active');
                document.getElementById('btnRoleAdmin').classList.remove('active');
                document.getElementById('staffForm').style.display = 'flex';
                document.getElementById('adminForm').style.display = 'none';
            },
            showAdminLogin: () => {
                document.getElementById('btnRoleStaff').classList.remove('active');
                document.getElementById('btnRoleAdmin').classList.add('active');
                document.getElementById('staffForm').style.display = 'none';
                document.getElementById('adminForm').style.display = 'flex';
            }
        };

        window.App = {
            saveAndRedirect: (user) => {
                user.store = user.store.toLowerCase().trim();
                localStorage.setItem('bellgo_session', JSON.stringify(user));
                window.location.href = "index.html";
            },

            // --- Î›ÎŸÎ“Î™ÎšÎ— Î•Î›Î•Î“Î§ÎŸÎ¥ Î Î›Î—Î¡Î©ÎœÎ—Î£ ---
            checkSubscriptionAndProceed: async (email, name, role) => {
                try {
                    const res = await fetch('/check-subscription', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email })
                    });
                    const data = await res.json();

                    if (data.active) {
                        // Î‘Î½ Î­Ï‡ÎµÎ¹ Ï€Î»Î·ÏÏÏƒÎµÎ¹ -> ÎœÏ€Î±Î¯Î½ÎµÎ¹
                        App.saveAndRedirect({ store: email, name, role });
                    } else {
                        // Î‘Î½ Î”Î•Î Î­Ï‡ÎµÎ¹ Ï€Î»Î·ÏÏÏƒÎµÎ¹ -> Î•ÏÏÏ„Î·ÏƒÎ·
                        const proceed = confirm("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®.\nÎ˜Î­Î»ÎµÏ„Îµ Î½Î± Ï€Î»Î·ÏÏÏƒÎµÏ„Îµ Ï„ÏÏÎ±;");
                        if (proceed) {
                            App.redirectToStripeManual(email);
                        }
                    }
                } catch (e) {
                    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.");
                }
            },

            // --- Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î— Î“Î™Î‘ Î¤ÎŸ ÎœÎ©Î’ ÎšÎŸÎ¥ÎœÎ Î™ (Î‘ÎœÎ•Î£Î— Î Î›Î—Î¡Î©ÎœÎ—) ---
            redirectToStripe: () => {
                const email = document.getElementById('inpAdminManualEmail').value.trim();
                if (!email || !email.includes('@')) {
                    return alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î¿ Email ÎµÏ€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ Î³Î¹Î± Î½Î± Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ ÏƒÎµ Ï€Î»Î·ÏÏ‰Î¼Î®.");
                }
                App.redirectToStripeManual(email);
            },

            // Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… ÎºÎ±Î»ÎµÎ¯ Ï„Î¿ Backend Î³Î¹Î± Ï€Î»Î·ÏÏ‰Î¼Î®
            redirectToStripeManual: async (email) => {
                try {
                    const stripeRes = await fetch('/create-checkout-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email })
                    });
                    
                    const session = await stripeRes.json();
                    
                    if (session.id) {
                        stripe.redirectToCheckout({ sessionId: session.id });
                    } else {
                        alert("Î£Ï†Î¬Î»Î¼Î± Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚: " + (session.error || "Î†Î³Î½Ï‰ÏƒÏ„Î¿"));
                    }
                } catch (e) {
                    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.");
                }
            },

            // Login Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ¿Ï
            loginStaff: () => {
                const store = document.getElementById('inpStoreEmail').value;
                const name = document.getElementById('inpMyName').value;
                const role = document.getElementById('inpMyRole').value;
                if (!store || !name) return alert("Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î± Ï€ÎµÎ´Î¯Î±!");
                App.saveAndRedirect({ store, name, role });
            },

            // Login Admin (Î ÏÎ¬ÏƒÎ¹Î½Î¿ ÎšÎ¿Ï…Î¼Ï€Î¯ - Î•Î™Î£ÎŸÎ”ÎŸÎ£)
            loginAdminManual: () => {
                const email = document.getElementById('inpAdminManualEmail').value.trim();
                if (!email || !email.includes('@')) return alert("ÎˆÎ³ÎºÏ…ÏÎ¿ Email Ï€Î±ÏÎ±ÎºÎ±Î»Ï");
                App.checkSubscriptionAndProceed(email, "Admin", "admin");
            },

            // Login Google (ÎšÏŒÎºÎºÎ¹Î½Î¿ ÎšÎ¿Ï…Î¼Ï€Î¯)
            loginAdminGoogle: () => {
                signInWithPopup(auth, provider).then((result) => {
                    const email = result.user.email;
                    // Î•Î½Î·Î¼ÎµÏÏÎ½Î¿Ï…Î¼Îµ ÎºÎ±Î¹ Ï„Î¿ Ï€ÎµÎ´Î¯Î¿ email Î³Î¹Î± Î½Î± Ï†Î±Î¯Î½ÎµÏ„Î±Î¹
                    document.getElementById('inpAdminManualEmail').value = email;
                    App.checkSubscriptionAndProceed(email, "Admin", "admin");
                }).catch((error) => alert("Error: " + error.message));
            }
        };

        if (localStorage.getItem('bellgo_session')) {
            window.location.href = "index.html";
        }
    </script>
</body>
</html>
