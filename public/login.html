<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Login</title>
    
    <link rel="manifest" id="dynamicManifest" href="/manifest.json?icon=admin">
    
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="admin.png">
    
    <script>
        (function() {
            const params = new URLSearchParams(window.location.search);
            const pStore = params.get('store');
            const manifestLink = document.getElementById('dynamicManifest');
            let url = `/manifest.json?icon=admin`; 
            if (pStore) url += `&store=${pStore}`;
            manifestLink.href = url;
        })();
    </script>
    
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100dvh; margin: 0; overflow: hidden; }
        
        .login-container { width: 90%; max-width: 400px; background: #1e1e1e; padding: 30px; border-radius: 12px; border: 1px solid #333; text-align: center; position: relative; }
        h1 { color: #FFD700; margin-bottom: 20px; font-size: 28px; }
        
        #btnInstall { display: none; margin-bottom: 15px; background: #00E676; color: black; padding: 12px; border-radius: 8px; border: none; font-weight: bold; width: 100%; cursor: pointer; animation: pulse 2s infinite; font-size: 14px; }
        
        .form-section { display: none; flex-direction: column; gap: 15px; }
        .form-section.active { display: flex; }

        .inp { padding: 12px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: white; font-size: 16px; width: 100%; box-sizing: border-box; text-align: center; }
        
        .btn-main { padding: 14px; border-radius: 6px; border: none; background: #FFD700; color: black; font-weight: bold; font-size: 18px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-google { background: #DB4437; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .btn-price { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #444; background: #333; color: white; cursor: pointer; font-size: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-price:hover { background: #444; }
        .price-tag { font-size: 18px; font-weight: bold; color: #FFD700; }
        
        .divider { display: flex; align-items: center; text-align: center; color: #555; margin: 10px 0; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #333; }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }

        #pinModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
        .pin-box { background: #222; padding: 25px; border-radius: 10px; border: 2px solid #FFD700; text-align: center; width: 80%; max-width: 300px; }
        .pin-display { font-size: 30px; letter-spacing: 10px; margin: 20px 0; font-weight: bold; color: #00E676; min-height: 40px; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .num-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; font-size: 20px; border-radius: 8px; cursor: pointer; }
        .num-btn:active { background: #555; }
        .forgot-link { margin-top: 15px; color: #aaa; text-decoration: underline; font-size: 12px; cursor: pointer; background: none; border: none; display: none; }

        /* NEW ROLE GRID */
        .role-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .btn-role { padding: 20px 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 14px; transition: 0.2s; }
        .btn-role:active { transform: scale(0.95); background: #333; border-color: #FFD700; }
        .role-icon { font-size: 24px; margin-bottom: 5px; }
        
        .btn-sub-link { background: none; border: none; color: #555; text-decoration: underline; font-size: 12px; cursor: pointer; margin-top: 10px; }
        .btn-back { background: transparent; border: 1px solid #555; color: #aaa; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; margin-top: 15px; width: 100%; }

        .password-wrapper { position: relative; width: 100%; }
        .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #aaa; font-size: 18px; background:none; border:none; padding: 0; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="login-container">
        <h1 onclick="window.dc=(window.dc||0)+1; if(window.dc===5) { const p = prompt('Developer Password:'); if(p === '19921992') window.location.href='developer.html'; window.dc=0; }" style="cursor:pointer; user-select:none;">BellGo ğŸ””</h1>
        
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
            <button onclick="setLanguage('el')" style="background:none; border:1px solid #555; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">ğŸ‡¬ğŸ‡· Î•Î›</button>
            <button onclick="setLanguage('en')" style="background:none; border:1px solid #555; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">ğŸ‡ºğŸ‡¸ EN</button>
        </div>

        <button id="btnInstall" onclick="handleInstall()" data-i18n="install_app">ğŸ“² Î•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—Î£</button>
        
        <!-- 1. ROLE SELECTION SCREEN -->
        <div id="roleSelection" class="form-section active">
            <p style="color:#aaa; margin-bottom:15px;" data-i18n="select_role">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Î½ ÏÏŒÎ»Î¿ ÏƒÎ±Ï‚:</p>
            <div class="role-grid">
                <button class="btn-role" onclick="UI.showAdminLogin('cashier')">
                    <span class="role-icon">ğŸª</span> <span data-i18n="cashier">Î¤Î‘ÎœÎ•Î™ÎŸ</span>
                </button>
                <button class="btn-role" onclick="UI.showAdminLogin('kitchen')">
                    <span class="role-icon">ğŸ‘¨â€ğŸ³</span> <span data-i18n="kitchen">ÎšÎŸÎ¥Î–Î™ÎÎ‘</span>
                </button>
                <button class="btn-role" onclick="UI.showStaffLogin('waiter')">
                    <span class="role-icon">ğŸ¤µ</span> <span data-i18n="waiter">Î£Î•Î¡Î’Î™Î¤ÎŸÎ¡ÎŸÎ£</span>
                </button>
                <button class="btn-role" onclick="UI.showStaffLogin('driver')">
                    <span class="role-icon">ğŸ›µ</span> <span data-i18n="driver">Î”Î™Î‘ÎÎŸÎœÎ•Î‘Î£</span>
                </button>
            </div>
            <button class="btn-sub-link" onclick="UI.showSubscription()" data-i18n="buy_subscription">Î‘Î³Î¿ÏÎ¬ Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚</button>
        </div>

        <!-- 2. STAFF LOGIN FORM -->
        <div id="staffForm" class="form-section">
            <h3 style="color:#FFD700; margin:0;" data-i18n="staff_login">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ¿Ï</h3>
            <input type="text" id="stStore" class="inp" placeholder="Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ (Admin Email)" data-i18n-placeholder="placeholder_admin_email">
            <input type="text" id="stName" class="inp" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…" data-i18n-placeholder="placeholder_your_name">
            <div class="password-wrapper">
                <input type="password" id="stPin" class="inp" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ ÎšÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ (PIN)" inputmode="numeric" data-i18n-placeholder="placeholder_pin">
                <button class="password-toggle" onclick="UI.togglePinVisibility()" type="button">ğŸ‘ï¸</button>
            </div>
            <!-- Hidden Select, controlled by JS -->
            <select id="stRole" class="inp" style="display:none;">
                <option value="waiter">Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚ ğŸ¤µ</option>
                <option value="driver">Î”Î¹Î±Î½Î¿Î¼Î­Î±Ï‚ ğŸ›µ</option>
            </select>
            <button class="btn-main" id="btnStaffLogin" onclick="Staff.login()" data-i18n="login_btn">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
            <button class="btn-back" onclick="UI.showRoles()" data-i18n="back_btn">ğŸ”™ Î Î™Î£Î©</button>
        </div>

        <!-- 3. ADMIN LOGIN FORM -->
        <div id="adminForm" class="form-section">
            <h3 style="color:#FFD700; margin:0;" data-i18n="admin_management">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· (Admin)</h3>
            <input type="email" id="adminEmailInp" class="inp" placeholder="Email (Î³Î¹Î± ÎµÎ¯ÏƒÎ¿Î´Î¿ Î® Î±Î³Î¿ÏÎ¬)" data-i18n-placeholder="placeholder_email_login_buy">
            <input type="text" id="adminNameInp" class="inp" placeholder="ÎŒÎ½Î¿Î¼Î± Î¤Î±Î¼ÎµÎ¯Î¿Ï… (Ï€.Ï‡. ÎœÎ±ÏÎ¯Î±)" data-i18n-placeholder="placeholder_cashier_name">
            <button class="btn-main" id="btnAdminLogin" style="background:#2196F3; color:white;" onclick="Admin.manualLogin()" data-i18n="login_btn">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
            <div class="divider" data-i18n="or">Î‰</div>
            <button class="btn-main btn-google" onclick="Admin.googleLogin()"><span>G</span> <span data-i18n="google_login">Î£ÏÎ½Î´ÎµÏƒÎ· Google</span></button>
            <button class="btn-back" onclick="UI.showRoles()" data-i18n="back_btn">ğŸ”™ Î Î™Î£Î©</button>
        </div>

        <!-- 4. SUBSCRIPTION SCREEN -->
        <div id="subscriptionScreen" class="form-section">
            <h3 style="color:#FFD700; margin:0;" data-i18n="select_package">Î•Ï€Î¹Î»Î¿Î³Î® Î Î±ÎºÎ­Ï„Î¿Ï…</h3>
            <p style="color:#aaa; font-size:12px; margin-bottom:15px;" data-i18n="enter_email_warning">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ Email ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Admin Login Ï€ÏÎ¹Î½ Ï„Î·Î½ Î±Î³Î¿ÏÎ¬.</p>
            
            <button class="btn-price" onclick="UI.goToBuy('basic')">
                <span data-i18n="plan_simple">BellGo Simple</span>
                <span class="price-tag">4â‚¬</span>
            </button>
            <button class="btn-price" onclick="UI.goToBuy('premium')">
                <span data-i18n="plan_management">BellGo Management Shop</span>
                <span class="price-tag">10â‚¬</span>
            </button>
            
            <button class="btn-back" onclick="UI.showRoles()" data-i18n="back_btn">ğŸ”™ Î Î™Î£Î©</button>
        </div>
    </div>

    <div id="pinModal">
        <div class="pin-box">
            <h3 id="pinTitle" style="margin:0; color:#FFD700;" data-i18n="enter_pin">Î•Î™Î£Î‘Î“Î©Î“Î— PIN</h3>
            <p id="pinSub" style="font-size:12px; color:#aaa;" data-i18n="enter_your_pin">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚</p>
            <div id="pinDisplay" class="pin-display"></div>
            <div class="numpad">
                <button class="num-btn" onclick="PIN.add(1)">1</button>
                <button class="num-btn" onclick="PIN.add(2)">2</button>
                <button class="num-btn" onclick="PIN.add(3)">3</button>
                <button class="num-btn" onclick="PIN.add(4)">4</button>
                <button class="num-btn" onclick="PIN.add(5)">5</button>
                <button class="num-btn" onclick="PIN.add(6)">6</button>
                <button class="num-btn" onclick="PIN.add(7)">7</button>
                <button class="num-btn" onclick="PIN.add(8)">8</button>
                <button class="num-btn" onclick="PIN.add(9)">9</button>
                <button class="num-btn" style="background:#D32F2F;" onclick="PIN.clear()">C</button>
                <button class="num-btn" onclick="PIN.add(0)">0</button>
                <button class="num-btn" style="background:#00E676; color:black;" onclick="PIN.submit()">OK</button>
            </div>
            <button id="btnForgot" class="forgot-link" onclick="PIN.resetFlow()" data-i18n="forgot_pin">ÎÎ­Ï‡Î±ÏƒÎ± Ï„Î¿ PIN</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { firebaseConfig } from './config.js';

        if ('serviceWorker' in navigator) {
            // âœ… FIX: ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î±Î»Î¹Î¿Ï Root Service Worker Ï€Î¿Ï… Ï€ÏÎ¿ÎºÎ±Î»ÎµÎ¯ Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î±
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(reg => {
                    if (reg.scope === window.location.origin + '/') {
                        reg.unregister().then(() => console.log('ğŸ§¹ Old Root SW Removed'));
                    }
                });
            });
            // âœ… FIX: Î•Î³Î³ÏÎ±Ï†Î® Î¼Îµ Scope /manage/ Î³Î¹Î± Î±Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·
            navigator.serviceWorker.register('/sw.js', { scope: '/manage/' }).then(() => console.log("âœ… Login SW Registered"));
        }

        let deferredPrompt;
        const btnInstall = document.getElementById('btnInstall');
        const isAndroid = /Android/i.test(navigator.userAgent);

        if (isAndroid) {
            btnInstall.innerText = "ğŸ¤– ÎšÎ‘Î¤Î•Î’Î‘Î£Î¤Î• Î¤ÎŸ APP (APK)";
            btnInstall.style.display = "block";
            btnInstall.style.background = "#FF9800";
        } else {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                btnInstall.innerText = "ğŸ“² Î•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—Î£";
                btnInstall.style.display = 'block';
            });
        }

        window.handleInstall = async () => {
            if (isAndroid) {
                window.location.href = "https://github.com/theroasters84-wq/bellgo-final/releases/download/v.1.5.0/app-release.apk";
            } else if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') btnInstall.style.display = 'none';
                deferredPrompt = null;
            }
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const socket = io({ transports: ['polling', 'websocket'] });

        let currentPinMode = 'enter'; 
        let tempPin = '';
        let pinValue = '';
        let adminUser = null; 
        let adminPlan = 'basic';

        // --- I18N LOGIC ---
        let translations = {};
        const t = (key) => translations[key] || key;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            if (emailParam) {
                document.getElementById('adminEmailInp').value = emailParam;
                Admin.manualLogin();
            } else {
                const savedEmail = localStorage.getItem('bellgo_last_email');
                if(savedEmail) document.getElementById('adminEmailInp').value = savedEmail;
            }

            // Load Language
            const savedLang = localStorage.getItem('bellgo_lang') || 'el';
            setLanguage(savedLang);
        };

        // --- UI NAVIGATION ---
        window.UI = {
            showRoles: () => {
                document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
                document.getElementById('roleSelection').classList.add('active');
            },
            showAdminLogin: (mode) => {
                if(mode) { localStorage.setItem('bellgo_admin_mode', mode); } // âœ… Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Mode (cashier/kitchen)
                document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
                document.getElementById('adminForm').classList.add('active');
            },
            showStaffLogin: (role) => {
                document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
                document.getElementById('staffForm').classList.add('active');
                const sel = document.getElementById('stRole');
                if(sel) sel.value = role;
            },
            showSubscription: () => {
                document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
                document.getElementById('subscriptionScreen').classList.add('active');
            },
            togglePinVisibility: () => {
                const inp = document.getElementById('stPin');
                inp.type = inp.type === 'password' ? 'text' : 'password';
            },
            goToBuy: (plan) => {
                // Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€Î¬ÎµÎ¹ ÏƒÏ„Î¿ Admin Form Î³Î¹Î± Î½Î± Î²Î¬Î»ÎµÎ¹ email
                UI.showAdminLogin();
                alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ Email ÏƒÎ±Ï‚ ÎºÎ±Î¹ Ï€Î±Ï„Î®ÏƒÏ„Îµ Î•Î¯ÏƒÎ¿Î´Î¿Ï‚. Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÏ„Îµ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®, Î¸Î± ÏƒÎ±Ï‚ Î¶Î·Ï„Î·Î¸ÎµÎ¯ Î½Î± Î±Î³Î¿ÏÎ¬ÏƒÎµÏ„Îµ.");
                // Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î— Î»Î¿Î³Î¹ÎºÎ® Î±Î³Î¿ÏÎ¬Ï‚ ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î· ÏƒÏ„Î¿ Admin.manualLogin Î® Admin.buyPackage
                // Î•Î´Ï Î±Ï€Î»Î¬ Ï„Î¿Î½ ÏƒÏ„Î­Î»Î½Î¿Ï…Î¼Îµ ÎµÎºÎµÎ¯, Î® Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÎºÎ±Î»Î­ÏƒÎ¿Ï…Î¼Îµ Î±Ï€ÎµÏ…Î¸ÎµÎ¯Î±Ï‚ Î±Î½ Î­Ï‡ÎµÎ¹ ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÎµÎ¹ email.
                const email = document.getElementById('adminEmailInp').value.trim();
                if(email) Admin.buyPackage(plan);
            }
        };

        window.PIN = {
            add: (n) => { if (pinValue.length < 4) { pinValue += n; PIN.updateDisplay(); } },
            clear: () => { pinValue = ''; PIN.updateDisplay(); },
            updateDisplay: () => { document.getElementById('pinDisplay').innerText = '*'.repeat(pinValue.length); },
            resetFlow: () => {
                if(!confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î¿ÏÎ¯ÏƒÎµÏ„Îµ Î½Î­Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ;")) return;
                currentPinMode = 'create'; pinValue = ''; PIN.updateDisplay();
                document.getElementById('pinTitle').innerText = t('create_pin') || "ÎÎ•ÎŸ PIN";
                document.getElementById('pinSub').innerText = t('set_new_pin') || "ÎŸÏÎ¯ÏƒÏ„Îµ Î½Î­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ";
                document.getElementById('btnForgot').style.display = 'none';
            },
            submit: () => {
                if (pinValue.length < 4) return alert("Î¤Î¿ PIN Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ 4 ÏˆÎ·Ï†Î¯Î±");
                if (currentPinMode === 'enter') {
                    socket.emit('verify-pin', { pin: pinValue, email: adminUser.email });
                } else if (currentPinMode === 'create') {
                    tempPin = pinValue; pinValue = ''; PIN.updateDisplay();
                    currentPinMode = 'confirm';
                    document.getElementById('pinTitle').innerText = t('confirm') || "Î•Î Î™Î’Î•Î’Î‘Î™Î©Î£Î—";
                    document.getElementById('pinSub').innerText = t('type_again') || "Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï„Î¿ Î¾Î±Î½Î¬";
                } else if (currentPinMode === 'confirm') {
                    if (pinValue === tempPin) {
                        socket.emit('set-new-pin', { pin: pinValue, email: adminUser.email });
                    } else { alert("ÎŸÎ¹ ÎºÏ‰Î´Î¹ÎºÎ¿Î¯ Î´ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); currentPinMode = 'create'; pinValue = ''; PIN.updateDisplay(); }
                }
            }
        };

        window.Staff = {
            login: () => {
                const name = document.getElementById('stName').value.trim();
                const pin = document.getElementById('stPin').value.trim();
                const role = document.getElementById('stRole').value;
                const adminEmail = document.getElementById('stStore').value.trim(); 

                if (!name || !pin || !adminEmail) return alert("Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Ï€ÎµÎ´Î¯Î±!");
                
                const btn = document.getElementById('btnStaffLogin');
                btn.innerText = "Î•Î›Î•Î“Î§ÎŸÎ£..."; btn.disabled = true;

                socket.emit('verify-pin', { pin: pin, email: adminEmail });
                
                socket.once('pin-verified', async (res) => {
                    if (res.success) {
                        try {
                            const subRes = await fetch('/check-subscription', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email: adminEmail })
                            });
                            const subData = await subRes.json();
                            
                            if (subData.active) {
                                const sessionData = { name: name, store: res.storeId, role: role, plan: subData.plan };
                                localStorage.setItem('bellgo_session', JSON.stringify(sessionData));

                                if (subData.plan === 'premium') {
                                    window.location.replace("/staff/app");
                                } else {
                                    window.location.replace("/manage/index.html"); 
                                }
                            } else {
                                alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±.");
                                btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                            }
                        } catch (e) { 
                            alert("Î£Ï†Î¬Î»Î¼Î± Î´Î¹ÎºÏ„ÏÎ¿Ï…."); 
                            btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                        }
                    } else {
                        alert("Î›Î¬Î¸Î¿Ï‚ PIN!");
                        PIN.clear();
                        btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                    }
                });
            }
        };

        window.Admin = {
            manualLogin: async () => {
                const email = document.getElementById('adminEmailInp').value.trim();
                const name = document.getElementById('adminNameInp').value.trim(); // âœ… Î›Î®ÏˆÎ· ÎŸÎ½ÏŒÎ¼Î±Ï„Î¿Ï‚
                if(!email) return alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ email.");
                localStorage.setItem('bellgo_last_email', email); // âœ… Save email for next time
                
                const btn = document.getElementById('btnAdminLogin');
                btn.innerText = "Î•Î›Î•Î“Î§ÎŸÎ£..."; btn.disabled = true;

                try {
                    const response = await fetch('/check-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    const data = await response.json();

                    if (data.active) {
                        adminUser = { email: email, displayName: name || "Admin" }; // âœ… Î§ÏÎ®ÏƒÎ· ÎŸÎ½ÏŒÎ¼Î±Ï„Î¿Ï‚
                        adminPlan = data.plan; 
                        socket.emit('check-pin-status', { email: email });
                        btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                    } else {
                        if(confirm("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®. Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î±Î³Î¿ÏÎ¬ÏƒÎµÏ„Îµ;")) {
                            UI.showSubscription();
                        }
                        btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                    }
                } catch (e) { 
                    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚."); 
                    btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                }
            },

            googleLogin: () => {
                signInWithPopup(auth, provider).then(async (result) => {
                    const email = result.user.email;
                    const response = await fetch('/check-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    const data = await response.json();
                    
                    if(data.active) {
                        adminUser = result.user;
                        adminPlan = data.plan;
                        socket.emit('check-pin-status', { email: email });
                    } else {
                        alert("Î¤Î¿ Google Email Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®.");
                    }
                }).catch((error) => alert(error.message));
            },

            buyPackage: async (plan) => {
                const email = document.getElementById('adminEmailInp').value.trim();
                if(!email) return alert("Î’Î¬Î»Ï„Îµ Ï„Î¿ email ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Ï€ÎµÎ´Î¯Î¿ Î±Ï€ÏŒ Ï€Î¬Î½Ï‰!");

                const res = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: email, plan: plan })
                });
                const data = await res.json();
                if(data.url) window.location.href = data.url;
                else alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Stripe");
            }
        };

        // --- SOCKET LISTENERS ---
        socket.on('pin-status', (data) => {
            document.getElementById('pinModal').style.display = 'flex';
            if (data.hasPin) {
                currentPinMode = 'enter';
                document.getElementById('pinTitle').innerText = t('enter_pin') || "Î•Î™Î£Î‘Î“Î©Î“Î— PIN";
                document.getElementById('pinSub').innerText = t('enter_your_pin') || "Î’Î¬Î»Ï„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚";
                document.getElementById('btnForgot').style.display = 'block';
            } else {
                currentPinMode = 'create';
                document.getElementById('pinTitle').innerText = t('create_pin') || "Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ PIN";
                document.getElementById('pinSub').innerText = t('set_new_pin') || "ÎŸÏÎ¯ÏƒÏ„Îµ Î­Î½Î±Î½ Î½Î­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ";
                document.getElementById('btnForgot').style.display = 'none';
            }
        });

        socket.on('pin-success', (data) => {
            const sessionData = { name: adminUser.displayName, store: adminUser.email, role: 'admin', email: adminUser.email, plan: adminPlan };
            localStorage.setItem('bellgo_session', JSON.stringify(sessionData));
            
            if(adminPlan === 'premium') {
                const adminMode = localStorage.getItem('bellgo_admin_mode');
                if (adminMode === 'kitchen') {
                    window.location.replace("/manage/kitchen.html");
                } else {
                    window.location.replace("/manage/premium.html");
                }
            }
            else window.location.replace("/manage/index.html");
        });

        socket.on('pin-verified', (res) => {
            // ğŸ”¥ FIXED: Only run if Modal is OPEN (Admin Flow)
            if (document.getElementById('pinModal').style.display === 'flex' && currentPinMode === 'enter') {
                if (res.success) {
                    const sessionData = { name: adminUser.displayName, store: adminUser.email, role: 'admin', email: adminUser.email, plan: adminPlan };
                    localStorage.setItem('bellgo_session', JSON.stringify(sessionData));
                    
                    if(adminPlan === 'premium') {
                        const adminMode = localStorage.getItem('bellgo_admin_mode');
                        if (adminMode === 'kitchen') {
                            window.location.replace("/manage/kitchen.html");
                        } else {
                            window.location.replace("/manage/premium.html");
                        }
                    }
                    else window.location.replace("/manage/index.html");
                } else {
                    alert("Î›Î¬Î¸Î¿Ï‚ PIN!");
                    PIN.clear();
                }
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user && !localStorage.getItem('bellgo_session')) {
                document.getElementById('adminEmailInp').value = user.email;
            }
        });

        window.setLanguage = async (lang) => {
            localStorage.setItem('bellgo_lang', lang);
            try {
                const response = await fetch(`/i18n/${lang}.json`);
                translations = await response.json();
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[key]) el.innerText = translations[key];
                });
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    if (translations[key]) el.placeholder = translations[key];
                });
            } catch (error) { console.error(`Lang Error: ${lang}`, error); }
        };
    </script>
</body>
</html>
