<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Login</title>
    <link rel="manifest" id="dynamicManifest" href="manifest.json?icon=admin">
    
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100dvh; margin: 0; overflow: hidden; }
        
        .login-container { width: 90%; max-width: 400px; background: #1e1e1e; padding: 30px; border-radius: 12px; border: 1px solid #333; text-align: center; }
        h1 { color: #FFD700; margin-bottom: 20px; font-size: 28px; }
        
        /* TABS */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #444; }
        .tab { flex: 1; padding: 10px; background: transparent; border: none; color: #777; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; font-size: 16px; }
        .tab.active { color: #FFD700; border-bottom-color: #FFD700; }

        /* FORMS */
        .form-section { display: none; flex-direction: column; gap: 15px; }
        .form-section.active { display: flex; }

        /* Input mode numeric triggers number pad on mobile */
        .inp { padding: 12px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: white; font-size: 16px; width: 100%; box-sizing: border-box; text-align: center; }
        
        .btn-main { padding: 14px; border-radius: 6px; border: none; background: #FFD700; color: black; font-weight: bold; font-size: 18px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-google { background: #DB4437; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* PIN MODAL */
        #pinModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
        .pin-box { background: #222; padding: 25px; border-radius: 10px; border: 2px solid #FFD700; text-align: center; width: 80%; max-width: 300px; }
        .pin-display { font-size: 30px; letter-spacing: 10px; margin: 20px 0; font-weight: bold; color: #00E676; min-height: 40px; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .num-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; font-size: 20px; border-radius: 8px; cursor: pointer; }
        .num-btn:active { background: #555; }
        
        /* FORGOT PIN LINK */
        .forgot-link { margin-top: 15px; color: #aaa; text-decoration: underline; font-size: 12px; cursor: pointer; background: none; border: none; display: none; }
    </style>
</head>
<body>

    <div class="login-container">
        <h1>BellGo ğŸ””</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('staff')">Î Î¡ÎŸÎ£Î©Î Î™ÎšÎŸ</button>
            <button class="tab" onclick="switchTab('admin')">ADMIN</button>
        </div>

        <div id="staffForm" class="form-section active">
            <input type="text" id="stStore" class="inp" placeholder="Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ (Admin Email)">
            <input type="text" id="stName" class="inp" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
            <input type="password" id="stPin" class="inp" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ ÎšÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ (PIN)" inputmode="numeric">
            
            <select id="stRole" class="inp">
                <option value="waiter">Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚ ğŸ¤µ</option>
                <option value="driver">Î”Î¹Î±Î½Î¿Î¼Î­Î±Ï‚ ğŸ›µ</option>
            </select>

            <button class="btn-main" onclick="Staff.login()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
        </div>

        <div id="adminForm" class="form-section">
            <p style="color:#aaa;">Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î¼Îµ Google Î³Î¹Î± Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·</p>
            <button class="btn-main btn-google" onclick="Admin.googleLogin()">
                <span>G</span> Î£ÏÎ½Î´ÎµÏƒÎ· Google
            </button>
        </div>
    </div>

    <div id="pinModal">
        <div class="pin-box">
            <h3 id="pinTitle" style="margin:0; color:#FFD700;">Î•Î™Î£Î‘Î“Î©Î“Î— PIN</h3>
            <p id="pinSub" style="font-size:12px; color:#aaa;">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚</p>
            <div id="pinDisplay" class="pin-display"></div>
            <div class="numpad">
                <button class="num-btn" onclick="PIN.add(1)">1</button>
                <button class="num-btn" onclick="PIN.add(2)">2</button>
                <button class="num-btn" onclick="PIN.add(3)">3</button>
                <button class="num-btn" onclick="PIN.add(4)">4</button>
                <button class="num-btn" onclick="PIN.add(5)">5</button>
                <button class="num-btn" onclick="PIN.add(6)">6</button>
                <button class="num-btn" onclick="PIN.add(7)">7</button>
                <button class="num-btn" onclick="PIN.add(8)">8</button>
                <button class="num-btn" onclick="PIN.add(9)">9</button>
                <button class="num-btn" style="background:#D32F2F;" onclick="PIN.clear()">C</button>
                <button class="num-btn" onclick="PIN.add(0)">0</button>
                <button class="num-btn" style="background:#00E676; color:black;" onclick="PIN.submit()">OK</button>
            </div>
            <button id="btnForgot" class="forgot-link" onclick="PIN.resetFlow()">ÎÎ­Ï‡Î±ÏƒÎ± Ï„Î¿ PIN</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
            authDomain: "bellgo-5dbe5.firebaseapp.com", 
            projectId: "bellgo-5dbe5", 
            storageBucket: "bellgo-5dbe5.firebasestorage.app", 
            messagingSenderId: "799314495253", 
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const socket = io({ transports: ['polling', 'websocket'] });

        let currentPinMode = 'enter'; 
        let tempPin = '';
        let pinValue = '';
        let adminUser = null;

        // âœ… PWA LOGIC: Fix Browser Confusion
        // Î‘Î½ Ï„Î¿ URL Î­Ï‡ÎµÎ¹ ?store=..., Ï„Î¿ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ manifest
        const urlParams = new URLSearchParams(window.location.search);
        const storeParam = urlParams.get('store');
        if (storeParam) {
            document.getElementById('dynamicManifest').href = `manifest.json?store=${storeParam}&icon=admin`;
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            
            if (tab === 'staff') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('staffForm').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('adminForm').classList.add('active');
            }
        };

        window.PIN = {
            add: (n) => {
                if (pinValue.length < 4) {
                    pinValue += n;
                    PIN.updateDisplay();
                }
            },
            clear: () => {
                pinValue = '';
                PIN.updateDisplay();
            },
            updateDisplay: () => {
                document.getElementById('pinDisplay').innerText = '*'.repeat(pinValue.length);
            },
            // âœ… FORGOT PIN LOGIC
            resetFlow: () => {
                if(!confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î¿ÏÎ¯ÏƒÎµÏ„Îµ Î½Î­Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ;")) return;
                currentPinMode = 'create';
                pinValue = '';
                PIN.updateDisplay();
                document.getElementById('pinTitle').innerText = "ÎÎ•ÎŸ PIN";
                document.getElementById('pinSub').innerText = "ÎŸÏÎ¯ÏƒÏ„Îµ Î½Î­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ";
                document.getElementById('btnForgot').style.display = 'none'; // Hide button during creation
            },
            submit: () => {
                if (pinValue.length < 4) return alert("Î¤Î¿ PIN Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ 4 ÏˆÎ·Ï†Î¯Î±");
                
                if (currentPinMode === 'enter') {
                    socket.emit('verify-pin', pinValue);
                } else if (currentPinMode === 'create') {
                    tempPin = pinValue;
                    pinValue = '';
                    PIN.updateDisplay();
                    currentPinMode = 'confirm';
                    document.getElementById('pinTitle').innerText = "Î•Î Î™Î’Î•Î’Î‘Î™Î©Î£Î—";
                    document.getElementById('pinSub').innerText = "Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï„Î¿ Î¾Î±Î½Î¬";
                } else if (currentPinMode === 'confirm') {
                    if (pinValue === tempPin) {
                        socket.emit('set-new-pin', { pin: pinValue, email: adminUser.email });
                    } else {
                        alert("ÎŸÎ¹ ÎºÏ‰Î´Î¹ÎºÎ¿Î¯ Î´ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½. Î ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÏ„Îµ Î¾Î±Î½Î¬.");
                        currentPinMode = 'create';
                        pinValue = '';
                        tempPin = '';
                        PIN.updateDisplay();
                        document.getElementById('pinTitle').innerText = "ÎÎ•ÎŸ PIN";
                    }
                }
            }
        };

        // --- STAFF LOGIC ---
        window.Staff = {
            login: () => {
                const name = document.getElementById('stName').value.trim();
                const pin = document.getElementById('stPin').value.trim();
                const role = document.getElementById('stRole').value;

                if (!name || !pin) return alert("Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Ï€ÎµÎ´Î¯Î±!");

                // Check PIN & Get Store ID from Server
                socket.emit('verify-pin', pin);
                
                socket.once('pin-verified', (res) => {
                    if (res.success) {
                        // Use Server-Provided StoreID
                        const sessionData = { name: name, store: res.storeId, role: role };
                        localStorage.setItem('bellgo_session', JSON.stringify(sessionData));
                        window.location.href = "stafpremium.html";
                    } else {
                        alert("Î›Î¬Î¸Î¿Ï‚ ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ ÎšÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ (PIN)!");
                        PIN.clear();
                    }
                });
            }
        };

        // --- ADMIN LOGIC ---
        window.Admin = {
            googleLogin: () => {
                signInWithPopup(auth, provider).then((result) => {
                    adminUser = result.user;
                    // Check if PIN exists
                    socket.emit('check-pin-status');
                }).catch((error) => alert(error.message));
            }
        };

        // --- SOCKET LISTENERS ---
        socket.on('pin-status', (data) => {
            document.getElementById('pinModal').style.display = 'flex';
            if (data.hasPin) {
                currentPinMode = 'enter';
                document.getElementById('pinTitle').innerText = "Î•Î™Î£Î‘Î“Î©Î“Î— PIN";
                document.getElementById('pinSub').innerText = "Î’Î¬Î»Ï„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚";
                // Show forgot button ONLY in enter mode
                document.getElementById('btnForgot').style.display = 'block';
            } else {
                currentPinMode = 'create';
                document.getElementById('pinTitle').innerText = "Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ PIN";
                document.getElementById('pinSub').innerText = "ÎŸÏÎ¯ÏƒÏ„Îµ Î­Î½Î±Î½ Î½Î­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ";
                document.getElementById('btnForgot').style.display = 'none';
            }
        });

        socket.on('pin-success', (data) => {
            // PIN Created/Reset successfully
            const sessionData = { name: adminUser.displayName, store: adminUser.email, role: 'admin', email: adminUser.email };
            localStorage.setItem('bellgo_session', JSON.stringify(sessionData));
            window.location.href = "premium.html";
        });

        // Verification Listener (For Admin Login via Modal)
        socket.on('pin-verified', (res) => {
            if (currentPinMode === 'enter' && document.getElementById('pinModal').style.display === 'flex') {
                if (res.success) {
                    const sessionData = { name: adminUser.displayName, store: adminUser.email, role: 'admin', email: adminUser.email };
                    localStorage.setItem('bellgo_session', JSON.stringify(sessionData));
                    window.location.href = "premium.html";
                } else {
                    alert("Î›Î¬Î¸Î¿Ï‚ PIN!");
                    PIN.clear();
                }
            }
        });

        // Auto Login Check
        if (localStorage.getItem('bellgo_session')) {
            const saved = JSON.parse(localStorage.getItem('bellgo_session'));
            if (saved.role === 'admin') window.location.href = "premium.html";
            else window.location.href = "stafpremium.html";
        }

    </script>
</body>
</html>
