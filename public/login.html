<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BellGo Login</title>
    
    <link rel="manifest" id="dynamicManifest" href="manifest.json?icon=admin">
    
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="admin.png">
    
    <script>
        (function() {
            const params = new URLSearchParams(window.location.search);
            const pStore = params.get('store');
            const manifestLink = document.getElementById('dynamicManifest');
            let url = `manifest.json?icon=admin`; 
            if (pStore) url += `&store=${pStore}`;
            manifestLink.href = url;
        })();
    </script>
    
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #121212; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100dvh; margin: 0; overflow: hidden; }
        
        .login-container { width: 90%; max-width: 400px; background: #1e1e1e; padding: 30px; border-radius: 12px; border: 1px solid #333; text-align: center; position: relative; }
        h1 { color: #FFD700; margin-bottom: 20px; font-size: 28px; }
        
        #btnInstall { display: none; margin-bottom: 15px; background: #00E676; color: black; padding: 12px; border-radius: 8px; border: none; font-weight: bold; width: 100%; cursor: pointer; animation: pulse 2s infinite; font-size: 14px; }
        
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #444; }
        .tab { flex: 1; padding: 10px; background: transparent; border: none; color: #777; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; font-size: 16px; }
        .tab.active { color: #FFD700; border-bottom-color: #FFD700; }

        .form-section { display: none; flex-direction: column; gap: 15px; }
        .form-section.active { display: flex; }

        .inp { padding: 12px; border-radius: 6px; border: 1px solid #444; background: #2a2a2a; color: white; font-size: 16px; width: 100%; box-sizing: border-box; text-align: center; }
        
        .btn-main { padding: 14px; border-radius: 6px; border: none; background: #FFD700; color: black; font-weight: bold; font-size: 18px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-google { background: #DB4437; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .pricing-box { display: flex; gap: 10px; margin-top: 15px; }
        .btn-price { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #333; color: white; cursor: pointer; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .btn-price:hover { background: #444; }
        .price-tag { font-size: 18px; font-weight: bold; color: #FFD700; }
        
        .divider { display: flex; align-items: center; text-align: center; color: #555; margin: 10px 0; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #333; }
        .divider:not(:empty)::before { margin-right: .25em; }
        .divider:not(:empty)::after { margin-left: .25em; }

        #pinModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; align-items: center; justify-content: center; flex-direction: column; }
        .pin-box { background: #222; padding: 25px; border-radius: 10px; border: 2px solid #FFD700; text-align: center; width: 80%; max-width: 300px; }
        .pin-display { font-size: 30px; letter-spacing: 10px; margin: 20px 0; font-weight: bold; color: #00E676; min-height: 40px; }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .num-btn { padding: 15px; background: #333; border: 1px solid #555; color: white; font-size: 20px; border-radius: 8px; cursor: pointer; }
        .num-btn:active { background: #555; }
        .forgot-link { margin-top: 15px; color: #aaa; text-decoration: underline; font-size: 12px; cursor: pointer; background: none; border: none; display: none; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="login-container">
        <h1>BellGo ğŸ””</h1>
        <button id="btnInstall" onclick="handleInstall()">ğŸ“² Î•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—Î£</button>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('staff')">Î Î¡ÎŸÎ£Î©Î Î™ÎšÎŸ</button>
            <button class="tab" onclick="switchTab('admin')">ADMIN</button>
        </div>

        <div id="staffForm" class="form-section active">
            <input type="text" id="stStore" class="inp" placeholder="Email Î•Ï€Î¹Ï‡ÎµÎ¯ÏÎ·ÏƒÎ·Ï‚ (Admin Email)">
            <input type="text" id="stName" class="inp" placeholder="Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ ÏƒÎ¿Ï…">
            <input type="password" id="stPin" class="inp" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ ÎšÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚ (PIN)" inputmode="numeric">
            <select id="stRole" class="inp">
                <option value="waiter">Î£ÎµÏÎ²Î¹Ï„ÏŒÏÎ¿Ï‚ ğŸ¤µ</option>
                <option value="driver">Î”Î¹Î±Î½Î¿Î¼Î­Î±Ï‚ ğŸ›µ</option>
            </select>
            <button class="btn-main" id="btnStaffLogin" onclick="Staff.login()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
        </div>

        <div id="adminForm" class="form-section">
            <input type="email" id="adminEmailInp" class="inp" placeholder="Email (Î³Î¹Î± ÎµÎ¯ÏƒÎ¿Î´Î¿ Î® Î±Î³Î¿ÏÎ¬)">
            <button class="btn-main" id="btnAdminLogin" style="background:#2196F3; color:white;" onclick="Admin.manualLogin()">Î•Î™Î£ÎŸÎ”ÎŸÎ£</button>
            <div class="pricing-box">
                <button class="btn-price" onclick="Admin.buyPackage('basic')"><span class="price-tag">4â‚¬</span><span>Basic (Index)</span></button>
                <button class="btn-price" onclick="Admin.buyPackage('premium')"><span class="price-tag">10â‚¬</span><span>Premium (Full)</span></button>
            </div>
            <div class="divider">Î‰</div>
            <button class="btn-main btn-google" onclick="Admin.googleLogin()"><span>G</span> Î£ÏÎ½Î´ÎµÏƒÎ· Google</button>
        </div>
    </div>

    <div id="pinModal">
        <div class="pin-box">
            <h3 id="pinTitle" style="margin:0; color:#FFD700;">Î•Î™Î£Î‘Î“Î©Î“Î— PIN</h3>
            <p id="pinSub" style="font-size:12px; color:#aaa;">Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚</p>
            <div id="pinDisplay" class="pin-display"></div>
            <div class="numpad">
                <button class="num-btn" onclick="PIN.add(1)">1</button>
                <button class="num-btn" onclick="PIN.add(2)">2</button>
                <button class="num-btn" onclick="PIN.add(3)">3</button>
                <button class="num-btn" onclick="PIN.add(4)">4</button>
                <button class="num-btn" onclick="PIN.add(5)">5</button>
                <button class="num-btn" onclick="PIN.add(6)">6</button>
                <button class="num-btn" onclick="PIN.add(7)">7</button>
                <button class="num-btn" onclick="PIN.add(8)">8</button>
                <button class="num-btn" onclick="PIN.add(9)">9</button>
                <button class="num-btn" style="background:#D32F2F;" onclick="PIN.clear()">C</button>
                <button class="num-btn" onclick="PIN.add(0)">0</button>
                <button class="num-btn" style="background:#00E676; color:black;" onclick="PIN.submit()">OK</button>
            </div>
            <button id="btnForgot" class="forgot-link" onclick="PIN.resetFlow()">ÎÎ­Ï‡Î±ÏƒÎ± Ï„Î¿ PIN</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => console.log("âœ… Login SW Registered"));
        }

        let deferredPrompt;
        const btnInstall = document.getElementById('btnInstall');
        const isAndroid = /Android/i.test(navigator.userAgent);

        if (isAndroid) {
            btnInstall.innerText = "ğŸ¤– ÎšÎ‘Î¤Î•Î’Î‘Î£Î¤Î• Î¤ÎŸ APP (APK)";
            btnInstall.style.display = "block";
            btnInstall.style.background = "#FF9800";
        } else {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                btnInstall.innerText = "ğŸ“² Î•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—Î£";
                btnInstall.style.display = 'block';
            });
        }

        window.handleInstall = async () => {
            if (isAndroid) {
                window.location.href = "https://github.com/theroasters84-wq/bellgo-final/releases/download/v.1.5.0/app-release.apk";
            } else if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') btnInstall.style.display = 'none';
                deferredPrompt = null;
            }
        };

        const firebaseConfig = { 
            apiKey: "AIzaSyBDOAlwLn4P5PMlwkg_Hms6-4f9fEcBKn8", 
            authDomain: "bellgo-5dbe5.firebaseapp.com", 
            projectId: "bellgo-5dbe5", 
            storageBucket: "bellgo-5dbe5.firebasestorage.app", 
            messagingSenderId: "799314495253", 
            appId: "1:799314495253:web:baf6852f2a065c3a2e8b1c"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const socket = io({ transports: ['polling', 'websocket'] });

        let currentPinMode = 'enter'; 
        let tempPin = '';
        let pinValue = '';
        let adminUser = null; 
        let adminPlan = 'basic';

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            if (emailParam) {
                document.getElementById('adminEmailInp').value = emailParam;
                Admin.manualLogin();
            }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            if (tab === 'staff') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('staffForm').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('adminForm').classList.add('active');
            }
        };

        window.PIN = {
            add: (n) => { if (pinValue.length < 4) { pinValue += n; PIN.updateDisplay(); } },
            clear: () => { pinValue = ''; PIN.updateDisplay(); },
            updateDisplay: () => { document.getElementById('pinDisplay').innerText = '*'.repeat(pinValue.length); },
            resetFlow: () => {
                if(!confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î¿ÏÎ¯ÏƒÎµÏ„Îµ Î½Î­Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ;")) return;
                currentPinMode = 'create'; pinValue = ''; PIN.updateDisplay();
                document.getElementById('pinTitle').innerText = "ÎÎ•ÎŸ PIN";
                document.getElementById('pinSub').innerText = "ÎŸÏÎ¯ÏƒÏ„Îµ Î½Î­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ";
                document.getElementById('btnForgot').style.display = 'none';
            },
            submit: () => {
                if (pinValue.length < 4) return alert("Î¤Î¿ PIN Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ 4 ÏˆÎ·Ï†Î¯Î±");
                if (currentPinMode === 'enter') {
                    socket.emit('verify-pin', { pin: pinValue, email: adminUser.email });
                } else if (currentPinMode === 'create') {
                    tempPin = pinValue; pinValue = ''; PIN.updateDisplay();
                    currentPinMode = 'confirm';
                    document.getElementById('pinTitle').innerText = "Î•Î Î™Î’Î•Î’Î‘Î™Î©Î£Î—";
                    document.getElementById('pinSub').innerText = "Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï„Î¿ Î¾Î±Î½Î¬";
                } else if (currentPinMode === 'confirm') {
                    if (pinValue === tempPin) {
                        socket.emit('set-new-pin', { pin: pinValue, email: adminUser.email });
                    } else { alert("ÎŸÎ¹ ÎºÏ‰Î´Î¹ÎºÎ¿Î¯ Î´ÎµÎ½ Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½."); currentPinMode = 'create'; pinValue = ''; PIN.updateDisplay(); }
                }
            }
        };

        window.Staff = {
            login: () => {
                const name = document.getElementById('stName').value.trim();
                const pin = document.getElementById('stPin').value.trim();
                const role = document.getElementById('stRole').value;
                const adminEmail = document.getElementById('stStore').value.trim(); 

                if (!name || !pin || !adminEmail) return alert("Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± Ï€ÎµÎ´Î¯Î±!");
                
                const btn = document.getElementById('btnStaffLogin');
                btn.innerText = "Î•Î›Î•Î“Î§ÎŸÎ£..."; btn.disabled = true;

                socket.emit('verify-pin', { pin: pin, email: adminEmail });
                
                socket.once('pin-verified', async (res) => {
                    if (res.success) {
                        try {
                            const subRes = await fetch('/check-subscription', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email: adminEmail })
                            });
                            const subData = await subRes.json();
                            
                            if (subData.active) {
                                const sessionData = { name: name, store: res.storeId, role: role, plan: subData.plan };
                                localStorage.setItem('bellgo_session', JSON.stringify(sessionData));

                                if (subData.plan === 'premium') {
                                    window.location.href = "stafpremium.html";
                                } else {
                                    window.location.href = "index.html"; 
                                }
                            } else {
                                alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±.");
                                btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                            }
                        } catch (e) { 
                            alert("Î£Ï†Î¬Î»Î¼Î± Î´Î¹ÎºÏ„ÏÎ¿Ï…."); 
                            btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                        }
                    } else {
                        alert("Î›Î¬Î¸Î¿Ï‚ PIN!");
                        PIN.clear();
                        btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                    }
                });
            }
        };

        window.Admin = {
            manualLogin: async () => {
                const email = document.getElementById('adminEmailInp').value.trim();
                if(!email) return alert("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ email.");
                
                const btn = document.getElementById('btnAdminLogin');
                btn.innerText = "Î•Î›Î•Î“Î§ÎŸÎ£..."; btn.disabled = true;

                try {
                    const response = await fetch('/check-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    const data = await response.json();

                    if (data.active) {
                        adminUser = { email: email, displayName: "Admin" };
                        adminPlan = data.plan; 
                        socket.emit('check-pin-status', { email: email });
                        btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                    } else {
                        alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®.");
                        btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                    }
                } catch (e) { 
                    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚."); 
                    btn.innerText = "Î•Î™Î£ÎŸÎ”ÎŸÎ£"; btn.disabled = false;
                }
            },

            googleLogin: () => {
                signInWithPopup(auth, provider).then(async (result) => {
                    const email = result.user.email;
                    const response = await fetch('/check-subscription', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    const data = await response.json();
                    
                    if(data.active) {
                        adminUser = result.user;
                        adminPlan = data.plan;
                        socket.emit('check-pin-status', { email: email });
                    } else {
                        alert("Î¤Î¿ Google Email Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÎ½ÎµÏÎ³Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®.");
                    }
                }).catch((error) => alert(error.message));
            },

            buyPackage: async (plan) => {
                const email = document.getElementById('adminEmailInp').value.trim();
                if(!email) return alert("Î’Î¬Î»Ï„Îµ Ï„Î¿ email ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Ï€ÎµÎ´Î¯Î¿ Î±Ï€ÏŒ Ï€Î¬Î½Ï‰!");

                const res = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: email, plan: plan })
                });
                const data = await res.json();
                if(data.url) window.location.href = data.url;
                else alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Stripe");
            }
        };

        // --- SOCKET LISTENERS ---
        socket.on('pin-status', (data) => {
            document.getElementById('pinModal').style.display = 'flex';
            if (data.hasPin) {
                currentPinMode = 'enter';
                document.getElementById('pinTitle').innerText = "Î•Î™Î£Î‘Î“Î©Î“Î— PIN";
                document.getElementById('pinSub').innerText = "Î’Î¬Î»Ï„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚";
                document.getElementById('btnForgot').style.display = 'block';
            } else {
                currentPinMode = 'create';
                document.getElementById('pinTitle').innerText = "Î”Î—ÎœÎ™ÎŸÎ¥Î¡Î“Î™Î‘ PIN";
                document.getElementById('pinSub').innerText = "ÎŸÏÎ¯ÏƒÏ„Îµ Î­Î½Î±Î½ Î½Î­Î¿ 4-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ";
                document.getElementById('btnForgot').style.display = 'none';
            }
        });

        socket.on('pin-success', (data) => {
            const sessionData = { name: adminUser.displayName, store: adminUser.email, role: 'admin', email: adminUser.email, plan: adminPlan };
            localStorage.setItem('bellgo_session', JSON.stringify(sessionData));
            
            if(adminPlan === 'premium') window.location.href = "premium.html";
            else window.location.href = "index.html";
        });

        socket.on('pin-verified', (res) => {
            // ğŸ”¥ FIXED: Only run if Modal is OPEN (Admin Flow)
            if (document.getElementById('pinModal').style.display === 'flex' && currentPinMode === 'enter') {
                if (res.success) {
                    const sessionData = { name: adminUser.displayName, store: adminUser.email, role: 'admin', email: adminUser.email, plan: adminPlan };
                    localStorage.setItem('bellgo_session', JSON.stringify(sessionData));
                    
                    if(adminPlan === 'premium') window.location.href = "premium.html";
                    else window.location.href = "index.html";
                } else {
                    alert("Î›Î¬Î¸Î¿Ï‚ PIN!");
                    PIN.clear();
                }
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user && !localStorage.getItem('bellgo_session')) {
                document.getElementById('adminEmailInp').value = user.email;
                switchTab('admin'); 
            }
        });
    </script>
</body>
</html>
