<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>BellGo Premium</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #121212; 
            color: #fff; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* HEADER */
        .header { height: 60px; background: #1e1e1e; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; flex-shrink: 0; z-index: 1000; }
        .user-info { display: flex; flex-direction: column; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn-logout { background: #D32F2F; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-icon { background: transparent; border: 1px solid #aaa; color: #aaa; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; position: relative; }
        .btn-icon:active { background: #333; }

        /* BADGE */
        .pending-badge {
            position: absolute; top: -5px; right: -5px; background: #D32F2F; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 2px solid #121212; z-index: 1100;
        }

        /* MENU FLOW SYSTEM (DYNAMIKO) */
        .menu-section { min-height: 60px; background: #1a1a1a; border-bottom: 2px solid #333; padding: 10px; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; max-height: 35vh; }
        .menu-flow { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; }
        .menu-flow-input { background: #000; border: 1px solid #444; color: #FFD700; padding: 5px 10px; border-radius: 4px; font-size: 14px; min-width: 100px; width: auto; flex-grow: 1; text-align: left; }

        /* WINDOWS LAYER (ELEUTHERO) */
        #windowsContainer { position: absolute; inset: 0; pointer-events: none; z-index: 9999; }
        .order-window { position: absolute; width: 300px; background: #2b2b2b; border: 2px solid #FFD700; border-radius: 8px; pointer-events: auto; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.95); z-index: 3000; }
        .win-header { background: #444; padding: 10px; border-top-left-radius: 6px; border-top-right-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: move; }

        /* LAYOUT */
        #mainApp { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; height: 100%; }

        /* STAFF LIST & SIDEBAR */
        #adminStaffSidebar { width: 220px; background: #181818; border-left: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-title { padding: 10px; background: #222; border-bottom: 1px solid #333; font-weight: bold; text-align: center; color: #aaa; font-size: 12px; }
        #staffList { flex: 1; overflow-y: auto; padding: 10px; }
        .staff-row { display: flex; width: 100%; gap: 5px; margin-bottom: 10px; }
        .btn-staff { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 14px; color: white; text-align: left; background: #333; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* TABS */
        .tabs { display: flex; background: #222; border-bottom: 1px solid #333; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 15px; background: transparent; color: #888; border: none; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid #FFD700; background: #333; }
        .tab-content { flex: 1; display: none; flex-direction: column; overflow: hidden; position: relative; height: 100%; }
        .tab-content.active { display: flex; }

        #fakeLockOverlay { display: none; position: fixed; inset: 0; background: black; z-index: 20000; align-items: center; justify-content: center; flex-direction: column; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 10% { transform: translate(-1px, -2px); } 100% { transform: translate(1px, -2px); } }
        .ringing { animation: shake 0.2s infinite; }
    </style>
</head>
<body>

    <div id="waiterOrdersModal" style="display:none; position:fixed; top:70px; right:10px; background:#2b2b2b; border:2px solid #FFD700; border-radius:10px; width:280px; z-index:10000; box-shadow:0 10px 30px #000;">
        <div style="padding:10px; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;"><b>Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î•Î£</b> <button onclick="UI.toggleOrdersList()" style="background:none; border:none; color:white; font-size:20px;">âœ•</button></div>
        <div id="waiterOrdersListContent" style="padding:10px; max-height:60vh; overflow-y:auto;"></div>
    </div>

    <div id="mainApp">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <span id="connDot" style="width:10px; height:10px; border-radius:50%; background:gray; margin-right:8px;" onclick="App.forceReconnect()"></span>
                <div class="user-info">
                    <span id="headerName" style="font-weight:bold; font-size:14px; color:#FFD700;">...</span>
                    <small id="headerStore" style="opacity:0.6; font-size:10px;">...</small>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="UI.showInfo()" style="color:#2196F3; border:1px solid #2196F3;">i</button>
                <div style="position: relative;">
                    <button class="btn-icon" onclick="UI.toggleOrdersList()">ğŸ“‹</button>
                    <span id="ordersCountBadge" class="pending-badge" style="display:none;">0</span>
                </div>
                <button id="staffBellBtn" class="btn-icon" onclick="App.acceptAlarmStaff()" style="background:#FFD700; color:black; display:none;">ğŸ””</button>
                <button class="btn-icon" onclick="App.toggleFakeLock()">ğŸŒ™</button>
                <button class="btn-logout" onclick="App.logout()">EXIT</button>
            </div>
        </div>

        <div class="content">
            <div id="menuSection" class="menu-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="color:#FFD700; font-weight:bold;">ğŸ“œ ÎšÎ‘Î¤Î‘Î›ÎŸÎ“ÎŸÎ£</span>
                    <button id="adminSaveBtn" class="btn-logout" style="background:#00E676; color:black; display:none;" onclick="App.saveMenu()">SAVE</button>
                </div>
                <div id="menuFlow" class="menu-flow"></div>
            </div>

            <div id="adminPanel" style="display:none; flex:1; flex-direction:column;">
                <div class="admin-main-area">
                    <div id="desktopArea" style="flex:1; position:relative; background:#222; padding:20px; display:flex; flex-wrap:wrap; gap:20px; overflow-y:auto; align-content: flex-start;"></div>
                    <div id="windowsContainer"></div>
                    <div id="adminStaffSidebar">
                        <div class="sidebar-title">Î Î¡ÎŸÎ£Î©Î Î™ÎšÎŸ (ONLINE)</div>
                        <div id="staffList"></div>
                    </div>
                </div>
            </div>

            <div id="waiterPanel" style="display:none; flex:1; flex-direction:column;">
                <div class="tabs">
                    <button id="tabChatBtn" class="tab-btn active" onclick="UI.showTab('chat')">ğŸ’¬ CHAT</button>
                    <button id="tabOrderBtn" class="tab-btn" onclick="UI.showTab('order')">ğŸ“ Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘</button>
                </div>
                <div id="tabChat" class="tab-content active">
                    <div id="waiterChatBox" class="chat-messages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
                    <div style="padding:10px; display:flex; gap:5px; background:#1e1e1e; border-top:1px solid #333;">
                        <input type="text" id="waiterChatInp" class="chat-inp" style="flex:1; padding:12px; border-radius:25px; background:#111; color:white; border:1px solid #444;" placeholder="ÎœÎ®Î½Ï…Î¼Î±...">
                        <button onclick="App.sendChat()" style="width:45px; height:45px; border-radius:50%; border:none; background:#00E676; color:black;">â¤</button>
                    </div>
                </div>
                <div id="tabOrder" class="tab-content" style="padding:15px; gap:15px;">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="inpTable" placeholder="Î¤Î¡Î‘Î Î•Î–Î™" style="flex:1; padding:15px; background:#333; color:white; border-radius:8px; text-align:center; font-weight:bold; border:1px solid #444;">
                        <input type="number" id="inpCovers" placeholder="Î‘Î¤ÎŸÎœÎ‘" style="flex:1; padding:15px; background:#333; color:white; border-radius:8px; text-align:center; font-weight:bold; border:1px solid #444;">
                    </div>
                    <textarea id="inpOrderText" style="flex:1; padding:15px; background:#333; color:white; border-radius:8px; font-size:18px; resize:none; border:1px solid #444;" placeholder="Î“ÏÎ¬ÏˆÎµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±..."></textarea>
                    <button onclick="App.sendOrder()" style="padding:20px; background:#FFD700; color:black; border:none; border-radius:10px; font-size:20px; font-weight:bold; cursor:pointer;">Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="fakeLockOverlay" onclick="App.toggleFakeLock()"><div style="color:#333;">Tap to Unlock</div></div>

    <script>
        const AudioEngine = {
            keepAlivePlayer: null, alarmPlayer: null, isRinging: false,
            async init() {
                if (!this.keepAlivePlayer) {
                    this.keepAlivePlayer = document.createElement("audio");
                    this.keepAlivePlayer.src = "tone19hz.wav"; this.keepAlivePlayer.loop = true;
                    document.body.appendChild(this.keepAlivePlayer);
                }
                if (!this.alarmPlayer) {
                    this.alarmPlayer = document.createElement("audio");
                    this.alarmPlayer.src = "alert.mp3"; this.alarmPlayer.loop = true;
                    document.body.appendChild(this.alarmPlayer);
                }
                try { await this.keepAlivePlayer.play(); } catch (e) {}
            },
            triggerAlarm() { this.isRinging = true; this.alarmPlayer.play().catch(e=>{}); },
            stopAlarm() { this.isRinging = false; this.alarmPlayer.pause(); this.alarmPlayer.currentTime = 0; }
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        const userData = JSON.parse(localStorage.getItem('bellgo_session') || '{}');
        if (!userData.store) window.location.href = "login.html";

        let orderAlertSound = new Audio('alert.mp3'); orderAlertSound.loop = true;

        window.UI = {
            showTab: (t) => {
                document.getElementById('tabChat').classList.toggle('active', t==='chat');
                document.getElementById('tabOrder').classList.toggle('active', t==='order');
                document.getElementById('tabChatBtn').classList.toggle('active', t==='chat');
                document.getElementById('tabOrderBtn').classList.toggle('active', t==='order');
            },
            showInfo: () => alert("ğŸ“¢ ÎŸÎ”Î—Î“Î™Î•Î£:\n1. ÎœÎ·Î½ ÎºÎ±Ï„ÎµÎ²Î¬Î¶ÎµÏ„Îµ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î· (Swipe Down).\n2. ÎœÎµÎ¯Î½ÎµÏ„Îµ Ï€Î¬Î½Ï„Î± ÏƒÏ„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®."),
            toggleOrdersList: () => {
                const m = document.getElementById('waiterOrdersModal');
                m.style.display = (m.style.display === 'block') ? 'none' : 'block';
                if(m.style.display==='block') UI.renderWaiterOrders();
            },
            renderWaiterOrders: () => {
                const c = document.getElementById('waiterOrdersListContent');
                c.innerHTML = App.activeOrders.map(o => `
                    <div style="background:#111; padding:10px; border-radius:5px; margin-bottom:5px; border-left:4px solid ${o.status==='ready'?'#00E676':'#FFD700'};">
                        <b style="color:#FFD700;">${o.text.split('\n')[0]}</b><br><small>${o.text.split('\n').slice(1).join(' ')}</small>
                    </div>
                `).join('');
            }
        };

        window.App = {
            activeOrders: [],
            init() {
                document.getElementById('headerName').innerText = userData.name;
                document.getElementById('headerStore').innerText = userData.store;
                if(userData.role==='admin') {
                    document.getElementById('adminPanel').style.display='flex';
                    document.getElementById('adminSaveBtn').style.display='block';
                } else {
                    document.getElementById('waiterPanel').style.display='flex';
                }
                document.body.addEventListener('click', () => AudioEngine.init(), {once:true});
                this.connectSocket();
            },
            connectSocket() {
                window.socket = io({ reconnection: true });
                socket.on('connect', () => {
                    document.getElementById('connDot').style.background = '#00E676';
                    socket.emit('join-store', { storeName: userData.store, username: userData.name, role: userData.role });
                });
                socket.on('disconnect', () => document.getElementById('connDot').style.background = 'red');

                socket.on('menu-update', (txt) => {
                    const flow = document.getElementById('menuFlow');
                    flow.innerHTML = '';
                    const items = txt ? txt.split('\n') : ["", "", ""];
                    items.forEach(val => {
                        const inp = document.createElement('input');
                        inp.className = 'menu-flow-input';
                        inp.value = val;
                        inp.readOnly = (userData.role !== 'admin');
                        if(userData.role==='admin') inp.oninput = App.liveUpdateMenu;
                        flow.appendChild(inp);
                    });
                });

                socket.on('orders-update', (orders) => {
                    App.activeOrders = orders;
                    const badge = document.getElementById('ordersCountBadge');
                    badge.style.display = orders.length > 0 ? 'flex' : 'none';
                    badge.innerText = orders.length;
                    if(userData.role==='admin') App.renderDesktopIcons(orders);
                });

                socket.on('ring-bell', () => {
                    if(userData.role==='admin') {
                        orderAlertSound.play().catch(()=>{});
                    } else {
                        AudioEngine.triggerAlarm();
                        const b = document.getElementById('staffBellBtn');
                        b.style.display='flex'; b.classList.add('ringing');
                    }
                });

                socket.on('chat-message', (data) => {
                    const box = document.getElementById('waiterChatBox');
                    if(box) {
                        box.innerHTML += `<div style="align-self:${data.sender===userData.name ? 'flex-end':'flex-start'}; background:${data.sender===userData.name ? '#00E676':'#333'}; color:${data.sender===userData.name ? 'black':'white'}; padding:10px; border-radius:12px; max-width:80%; font-size:14px; margin-bottom:5px;"><b>${data.sender}:</b> ${data.text}</div>`;
                        box.scrollTop = box.scrollHeight;
                    }
                });

                socket.on('staff-list-update', (list) => App.renderStaffList(list));
            },
            liveUpdateMenu() {
                const txt = Array.from(document.querySelectorAll('.menu-flow-input')).map(i=>i.value).join('\n');
                socket.emit('live-menu-type', txt);
            },
            saveMenu() {
                const txt = Array.from(document.querySelectorAll('.menu-flow-input')).map(i=>i.value).join('\n');
                socket.emit('save-menu', txt);
                alert("Î¤Î¿ Î¼ÎµÎ½Î¿Ï Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!");
            },
            sendOrder() {
                const t = document.getElementById('inpTable').value;
                const c = document.getElementById('inpCovers').value;
                const txt = document.getElementById('inpOrderText').value;
                if(!txt.trim()) return alert("Î“ÏÎ¬ÏˆÎµ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±!");
                socket.emit('new-order', `Î¤Î¡Î‘Î Î•Î–Î™ ${t||'-'} (${c||'0'} Î¬Ï„.)\n${txt}`);
                document.getElementById('inpTable').value=''; document.getElementById('inpCovers').value=''; document.getElementById('inpOrderText').value='';
                alert("ğŸš€ Î•ÏƒÏ„Î¬Î»Î·!");
            },
            acceptAlarmStaff() {
                AudioEngine.stopAlarm();
                document.getElementById('staffBellBtn').style.display='none';
                socket.emit('alarm-accepted', { store: userData.store, username: userData.name });
            },
            renderDesktopIcons(orders) {
                const d = document.getElementById('desktopArea'); d.innerHTML = '';
                orders.forEach(o => {
                    const icon = document.createElement('div');
                    icon.className = `order-folder ${o.status==='pending'?'ringing':''}`;
                    icon.innerHTML = `<div style="font-size:50px;">ğŸ“‚</div><div style="font-size:12px; color:white; background:rgba(0,0,0,0.5); padding:2px; border-radius:4px;">${o.from}</div>`;
                    icon.onclick = () => App.openOrderWindow(o);
                    d.appendChild(icon);
                });
            },
            openOrderWindow(o) {
                orderAlertSound.pause();
                let win = document.getElementById(`win-${o.id}`);
                if(!win) {
                    win = document.createElement('div'); win.id=`win-${o.id}`;
                    win.className = 'order-window';
                    win.style.top = "100px"; win.style.left = "50px";
                    document.getElementById('windowsContainer').appendChild(win);
                    
                    let isD=false, ox, oy;
                    win.onmousedown = (e) => { if(e.target.closest('.win-header')){ isD=true; ox=e.clientX-win.offsetLeft; oy=e.clientY-win.offsetTop; win.style.zIndex=10000; }};
                    document.onmousemove = (e) => { if(isD){ win.style.left=(e.clientX-ox)+'px'; win.style.top=(e.clientY-oy)+'px'; }};
                    document.onmouseup = () => isD=false;
                }
                win.innerHTML = `
                    <div class="win-header"><b>${o.from}</b> <button onclick="this.parentElement.parentElement.remove()" style="background:red; color:white; border:none; border-radius:4px; cursor:pointer;">X</button></div>
                    <div style="padding:20px; font-weight:bold; white-space:pre-wrap; flex:1; overflow-y:auto;">${o.text}</div>
                    <div style="padding:10px; display:flex; gap:5px; border-top:1px solid #444;">
                        ${o.status==='pending' ? `<button onclick="App.acceptOrder('${o.id}')" style="flex:1; background:#2196F3; color:white; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Î‘Î ÎŸÎ”ÎŸÎ§Î—</button>` : `<button onclick="App.completeOrder('${o.id}')" style="flex:1; background:#00E676; padding:15px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Î•Î¤ÎŸÎ™ÎœÎŸ</button>`}
                    </div>
                `;
            },
            acceptOrder: (id) => socket.emit('accept-order', Number(id)),
            completeOrder: (id) => { if(confirm("ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿;")) socket.emit('close-order', Number(id)); document.getElementById(`win-${id}`)?.remove(); },
            renderStaffList(list) {
                const s = document.getElementById('staffList'); s.innerHTML = '';
                list.forEach(u => {
                    if(u.role==='admin') return;
                    const row = document.createElement('div');
                    row.className = 'staff-row';
                    row.innerHTML = `<button class="btn-staff"><span>${u.username}</span><span style="color:${u.status==='online'?'#00E676':'#FF9800'}; font-size:10px;">${u.status.toUpperCase()}</span></button>`;
                    row.onclick = () => socket.emit('trigger-alarm', u.username);
                    s.appendChild(row);
                });
            },
            toggleFakeLock: () => {
                const l = document.getElementById('fakeLockOverlay');
                l.style.display = (l.style.display==='flex') ? 'none' : 'flex';
            },
            logout: () => { socket.emit('manual-logout'); localStorage.clear(); window.location.href="login.html"; },
            forceReconnect: () => { socket.disconnect(); setTimeout(()=>socket.connect(), 500); },
            startHeartbeat: () => setInterval(() => { if(window.socket?.connected) socket.emit('heartbeat'); }, 3000)
        };
        window.onload = App.init;
    </script>
</body>
</html>
