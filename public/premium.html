<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>BellGo Premium</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: #121212; 
            color: #fff; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        
        /* HEADER */
        .header { height: 60px; background: #1e1e1e; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; flex-shrink: 0; z-index: 1000; }
        .user-info { display: flex; flex-direction: column; }
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .btn-logout { background: #D32F2F; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-icon { background: transparent; border: 1px solid #aaa; color: #aaa; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; position: relative; }
        .btn-icon:active { background: #333; }

        /* BADGES */
        .pending-badge {
            position: absolute; top: -5px; right: -5px; background: #D32F2F; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 2px solid #121212; z-index: 1100;
        }

        /* --- MENU GRID SYSTEM --- */
        .menu-section { 
            min-height: 100px; 
            background: #1a1a1a; 
            border-bottom: 2px solid #333; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            flex-shrink: 0; 
            overflow-y: auto;
            max-height: 40vh; /* ÎœÎµÎ³Î±Î»ÏÎ½ÎµÎ¹ Î¼Î­Ï‡ÏÎ¹ Ï„Î¿ 40% Ï„Î·Ï‚ Î¿Î¸ÏŒÎ½Î·Ï‚ */
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }
        .menu-item-input {
            background: #000;
            border: 1px solid #444;
            color: #FFD700;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            width: 100%;
        }

        /* LAYOUT */
        #mainApp { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* WAITER MODAL */
        #waiterOrdersModal {
            display: none; position: fixed; top: 70px; right: 10px; background: #2b2b2b; 
            border: 2px solid #FFD700; border-radius: 10px; width: 280px; max-height: 70vh; 
            z-index: 5000; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* --- ADMIN UI --- */
        #adminPanel { display: none; flex-direction: column; height: 100%; position: relative; }
        .admin-main-area { flex: 1; display: flex; overflow: hidden; position: relative; }
        #desktopArea { flex: 1; position: relative; background: #222; padding: 20px; display: flex; flex-wrap: wrap; align-content: flex-end; align-items: flex-end; gap: 20px; overflow-y: auto; }
        #adminStaffSidebar { width: 220px; background: #181818; border-left: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        
        /* --- WAITER UI --- */
        #waiterPanel { display: none; flex-direction: column; height: 100%; flex: 1; overflow: hidden; }
        .tabs { display: flex; background: #222; border-bottom: 1px solid #333; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 15px; background: transparent; color: #888; border: none; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid #FFD700; background: #333; }
        .tab-content { flex: 1; display: none; flex-direction: column; overflow: hidden; position: relative; }
        .tab-content.active { display: flex; }

        /* ANIMATIONS & OTHERS */
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-2px,0); } 20%, 40%, 60%, 80% { transform: translate(2px,0); } }
        #fakeLockOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 20000; align-items: center; justify-content: center; flex-direction: column; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; display: inline-block; }
    </style>
</head>
<body>

    <div id="waiterOrdersModal">
        <div style="padding:12px; background:#333; font-weight:bold; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;">
            <span>ğŸ“‹ Î•ÎÎ•Î¡Î“Î•Î£ Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î•Î£</span>
            <button onclick="UI.toggleOrdersList()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">âœ•</button>
        </div>
        <div id="waiterOrdersListContent" style="padding:10px;"></div>
    </div>

    <div id="mainApp">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <span id="connDot" class="status-dot" onclick="App.forceReconnect()" style="background: gray;"></span>
                <div class="user-info">
                    <span id="headerName" style="font-weight:bold; font-size:14px; color:#FFD700;">PREMIUM</span>
                    <small id="headerStore" style="opacity:0.6; font-size:10px;">...</small>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="UI.showInfo()" title="ÎŸÎ´Î·Î³Î¯ÎµÏ‚" style="color:#2196F3; border:1px solid #2196F3;">i</button>
                
                <div style="position: relative;">
                    <button class="btn-icon" onclick="UI.toggleOrdersList()" title="Î›Î¯ÏƒÏ„Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¹ÏÎ½">ğŸ“‹</button>
                    <span id="ordersCountBadge" class="pending-badge" style="display:none;">0</span>
                </div>

                <button id="staffBellBtn" class="btn-icon" onclick="App.acceptAlarmStaff()" title="Î‘Î ÎŸÎ”ÎŸÎ§Î—" style="background:#FFD700; color:black; border:2px solid #FFD700; display:none;">ğŸ””</button>
                <button class="btn-icon" onclick="App.toggleFakeLock()" title="Black Screen">ğŸŒ™</button>
                <button class="btn-logout" onclick="App.logout()">EXIT</button>
            </div>
        </div>

        <div class="content">
            <div id="menuSection" class="menu-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="color:#FFD700; font-weight:bold; font-size:13px;">ğŸ“œ ÎšÎ‘Î¤Î‘Î›ÎŸÎ“ÎŸÎ£</span>
                    <button id="adminSaveMenuBtn" class="btn-logout" style="background:#00E676; color:black; display:none;" onclick="App.saveMenu()">SAVE</button>
                </div>
                <div id="menuGrid" class="menu-grid"></div>
            </div>
            
            <div id="adminPanel">
                <div class="admin-main-area">
                    <div id="desktopArea"></div>
                    <div id="windowsContainer" style="position:absolute; inset:0; pointer-events:none; z-index:2000;"></div>
                    <div id="adminStaffSidebar">
                        <div style="padding:10px; background:#222; border-bottom:1px solid #333; font-weight:bold; text-align:center; color:#aaa; font-size:11px;">ONLINE</div>
                        <div id="staffList" style="flex:1; overflow-y:auto; padding:10px;"></div>
                    </div>
                </div>
            </div>

            <div id="waiterPanel">
                <div class="tabs">
                    <button class="tab-btn active" id="tabChatBtn" onclick="UI.showTab('chat')">ğŸ’¬ CHAT</button>
                    <button class="tab-btn" id="tabOrderBtn" onclick="UI.showTab('order')">ğŸ“ Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘</button>
                </div>

                <div id="tabChat" class="tab-content active">
                    <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                        <div id="waiterChatBox" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
                        <div style="display:flex; padding:10px; background:#1e1e1e; border-top:1px solid #333;">
                            <input type="text" id="waiterChatInp" style="flex:1; padding:12px; border-radius:25px; border:1px solid #444; background:#111; color:white;" placeholder="ÎœÎ®Î½Ï…Î¼Î±...">
                            <button onclick="App.sendChat()" style="margin-left:10px; width:45px; height:45px; border-radius:50%; border:none; background:#00E676; color:black; font-weight:bold;">â¤</button>
                        </div>
                    </div>
                </div>

                <div id="tabOrder" class="tab-content" style="padding:15px; gap:15px;">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label style="font-size:11px; color:#888;">Î¤Î¡Î‘Î Î•Î–Î™</label><input type="number" id="inpTable" style="width:100%; padding:15px; background:#333; border:1px solid #444; color:white; border-radius:8px; text-align:center; font-weight:bold;"></div>
                        <div style="flex:1;"><label style="font-size:11px; color:#888;">Î‘Î¤ÎŸÎœÎ‘</label><input type="number" id="inpCovers" style="width:100%; padding:15px; background:#333; border:1px solid #444; color:white; border-radius:8px; text-align:center; font-weight:bold;"></div>
                    </div>
                    <textarea id="inpOrderText" style="flex:1; padding:15px; background:#333; border:1px solid #444; color:white; border-radius:8px; font-size:18px; resize:none;" placeholder="Î“ÏÎ¬ÏˆÎµ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î±..."></textarea>
                    <button onclick="App.sendOrder()" style="width:100%; padding:20px; background:#FFD700; color:black; border:none; border-radius:10px; font-size:20px; font-weight:bold;">Î‘Î ÎŸÎ£Î¤ÎŸÎ›Î— ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="fakeLockOverlay" onclick="App.toggleFakeLock()">
        <div style="color: #333; font-size: 14px;">Tap to Unlock</div>
    </div>

    <script>
        // AUDIO ENGINE & WAKELOCK (Î”Î¹Î±Ï„Î·ÏÎµÎ¯Ï„Î±Î¹ Î¯Î´Î¹Î¿)
        const AudioEngine = {
            keepAlivePlayer: null, alarmPlayer: null, isRinging: false,
            async init() {
                if (!this.keepAlivePlayer) {
                    this.keepAlivePlayer = document.createElement("audio");
                    this.keepAlivePlayer.src = "tone19hz.wav"; this.keepAlivePlayer.loop = true;
                    document.body.appendChild(this.keepAlivePlayer);
                }
                if (!this.alarmPlayer) {
                    this.alarmPlayer = document.createElement("audio");
                    this.alarmPlayer.src = "alert.mp3"; this.alarmPlayer.loop = true;
                    document.body.appendChild(this.alarmPlayer);
                }
                try { await this.keepAlivePlayer.play(); } catch (e) {}
            },
            triggerAlarm() { this.isRinging = true; this.alarmPlayer.play().catch(e=>{}); },
            stopAlarm() { this.isRinging = false; this.alarmPlayer.pause(); this.alarmPlayer.currentTime = 0; }
        };
    </script>

    <script type="module">
        const savedSession = localStorage.getItem('bellgo_session');
        if (!savedSession) window.location.href = "login.html";
        const userData = JSON.parse(savedSession);

        let orderAlertSound = new Audio('alert.mp3'); orderAlertSound.loop = true;

        window.UI = {
            showTab: (tab) => {
                document.getElementById('tabChat').classList.toggle('active', tab==='chat');
                document.getElementById('tabOrder').classList.toggle('active', tab==='order');
                document.getElementById('tabChatBtn').classList.toggle('active', tab==='chat');
                document.getElementById('tabOrderBtn').classList.toggle('active', tab==='order');
            },
            showInfo: () => {
                alert("ğŸ“¢ Î Î¡ÎŸÎ£ÎŸÎ§Î—:\n1. ÎœÎ·Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Îµ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¿ÏÏ‚ players.\n2. ÎœÎ·Î½ ÎºÎ±Ï„ÎµÎ²Î¬Î¶ÎµÏ„Îµ Ï„Î·Î½ Î¿Î¸ÏŒÎ½Î· (swipe down).\n3. Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î¼Î­Î½ÎµÎ¹ Ï€Î¬Î½Ï„Î± Î±Î½Î¿Î¹Ï‡Ï„Î®.");
            },
            toggleOrdersList: () => {
                const modal = document.getElementById('waiterOrdersModal');
                modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
                if(modal.style.display === 'block') UI.renderWaiterOrders();
            },
            renderWaiterOrders: () => {
                const content = document.getElementById('waiterOrdersListContent');
                if(!App.activeOrders.length) { content.innerHTML="<p style='color:#666; text-align:center;'>ÎšÎ±Î¼Î¯Î± Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</p>"; return; }
                content.innerHTML = App.activeOrders.map(o => `
                    <div style="background:#111; padding:10px; border-radius:6px; margin-bottom:8px; border-left:4px solid ${o.status==='ready' ? '#00E676':'#FFD700'};">
                        <div style="color:#FFD700; font-weight:bold; font-size:14px;">${o.text.split('\n')[0]}</div>
                        <div style="font-size:12px; white-space:pre-wrap;">${o.text.split('\n').slice(1).join('\n')}</div>
                        <div style="text-align:right; font-size:10px; color:#888;">${o.status.toUpperCase()}</div>
                    </div>
                `).join('');
            }
        };

        window.App = {
            activeOrders: [],
            init: () => {
                document.getElementById('headerName').innerText = userData.name;
                document.getElementById('headerStore').innerText = userData.store;
                
                if (userData.role === 'admin') {
                    document.getElementById('adminPanel').style.display = 'flex';
                    document.getElementById('adminSaveMenuBtn').style.display = 'block';
                } else {
                    document.getElementById('waiterPanel').style.display = 'flex';
                }

                document.body.addEventListener('click', () => AudioEngine.init(), {once:true});
                App.connectSocket();
            },

            connectSocket: () => {
                window.socket = io({ reconnection: true });
                const socket = window.socket;

                socket.on('connect', () => {
                    document.getElementById('connDot').style.background = '#00E676';
                    socket.emit('join-store', { storeName: userData.store, username: userData.name, role: userData.role });
                });

                socket.on('disconnect', () => { document.getElementById('connDot').style.background = 'red'; });

                // Î”Î¥ÎÎ‘ÎœÎ™ÎšÎŸ ÎœÎ•ÎÎŸÎ¥ GRID
                socket.on('menu-update', (txt) => {
                    const grid = document.getElementById('menuGrid');
                    const items = txt ? txt.split('\n') : ["", "", "", ""];
                    grid.innerHTML = '';
                    items.forEach((item, idx) => {
                        const input = document.createElement('input');
                        input.className = 'menu-item-input';
                        input.value = item;
                        input.placeholder = "...";
                        input.readOnly = (userData.role !== 'admin');
                        if(userData.role === 'admin') input.oninput = App.liveUpdateMenu;
                        grid.appendChild(input);
                    });
                });

                socket.on('orders-update', (orders) => {
                    App.activeOrders = orders;
                    // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Badge
                    const badge = document.getElementById('ordersCountBadge');
                    if(orders.length > 0) { badge.style.display='flex'; badge.innerText=orders.length; }
                    else { badge.style.display='none'; }
                    
                    if(userData.role === 'admin') App.renderDesktopIcons(orders);
                    else UI.renderWaiterOrders();
                });

                socket.on('ring-bell', () => {
                    if (userData.role === 'admin') { orderAlertSound.play(); } 
                    else {
                        AudioEngine.triggerAlarm();
                        const bell = document.getElementById('staffBellBtn');
                        bell.style.display = 'flex'; bell.classList.add('ringing');
                    }
                });

                socket.on('chat-message', (data) => {
                    const box = document.getElementById('waiterChatBox');
                    if(box) {
                        box.innerHTML += `<div style="align-self:${data.sender===userData.name ? 'flex-end':'flex-start'}; background:${data.sender===userData.name ? '#00E676':'#333'}; color:${data.sender===userData.name ? 'black':'white'}; padding:10px; border-radius:12px; max-width:80%; font-size:14px;"><b>${data.sender}:</b> ${data.text}</div>`;
                        box.scrollTop = box.scrollHeight;
                    }
                });

                socket.on('staff-list-update', (list) => App.renderStaffList(list));
            },

            liveUpdateMenu: () => {
                const inputs = document.querySelectorAll('.menu-item-input');
                const txt = Array.from(inputs).map(i => i.value).join('\n');
                window.socket.emit('live-menu-type', txt);
            },
            saveMenu: () => {
                const inputs = document.querySelectorAll('.menu-item-input');
                const txt = Array.from(inputs).map(i => i.value).join('\n');
                window.socket.emit('save-menu', txt);
                alert("Î¤Î¿ Î¼ÎµÎ½Î¿Ï Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!");
            },
            sendOrder: () => {
                const t = document.getElementById('inpTable').value;
                const c = document.getElementById('inpCovers').value;
                const txt = document.getElementById('inpOrderText').value;
                if(!txt.trim()) return alert("Î“ÏÎ¬ÏˆÎµ Ï„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±!");
                window.socket.emit('new-order', `Î¤Î¡Î‘Î Î•Î–Î™ ${t||'-'} (${c||'0'} Î¬Ï„Î¿Î¼Î±)\n${txt}`);
                document.getElementById('inpTable').value=''; document.getElementById('inpCovers').value=''; document.getElementById('inpOrderText').value='';
                alert("Î•ÏƒÏ„Î¬Î»Î·! ğŸš€");
            },
            acceptAlarmStaff: () => {
                AudioEngine.stopAlarm();
                document.getElementById('staffBellBtn').style.display = 'none';
                window.socket.emit('alarm-accepted', { store: userData.store, username: userData.name });
            },
            renderDesktopIcons: (orders) => {
                const desktop = document.getElementById('desktopArea'); desktop.innerHTML = '';
                orders.forEach(o => {
                    const div = document.createElement('div');
                    div.className = `order-folder ${o.status==='pending' ? 'ringing':''}`;
                    div.style = "width:80px; text-align:center; cursor:pointer;";
                    div.innerHTML = `<div style="font-size:40px;">ğŸ“‚</div><div style="font-size:10px; background:rgba(0,0,0,0.5); border-radius:4px;">${o.from}</div>`;
                    div.onclick = () => App.openOrderWindow(o);
                    desktop.appendChild(div);
                });
            },
            openOrderWindow: (o) => {
                orderAlertSound.pause(); orderAlertSound.currentTime=0;
                let win = document.getElementById(`win-${o.id}`);
                if(!win) {
                    win = document.createElement('div'); win.id=`win-${o.id}`;
                    win.style = "position:absolute; top:20%; left:20%; width:300px; background:#2b2b2b; border:2px solid #FFD700; border-radius:8px; pointer-events:auto; z-index:3000; display:flex; flex-direction:column;";
                    document.getElementById('windowsContainer').appendChild(win);
                }
                win.innerHTML = `
                    <div style="background:#444; padding:8px; display:flex; justify-content:space-between; color:white; font-weight:bold;"><span>${o.from}</span><button onclick="this.parentElement.parentElement.remove()" style="background:red; color:white; border:none;">X</button></div>
                    <div style="padding:15px; font-weight:bold; white-space:pre-wrap;">${o.text}</div>
                    <div style="padding:10px; display:flex; gap:5px;">
                        ${o.status==='pending' ? `<button onclick="App.acceptOrder('${o.id}')" style="flex:1; padding:10px; background:#2196F3; color:white; border:none; border-radius:4px;">Î‘Î ÎŸÎ”ÎŸÎ§Î—</button>` : `<button onclick="App.completeOrder('${o.id}')" style="flex:1; padding:10px; background:#00E676; border:none; border-radius:4px;">Î•Î¤ÎŸÎ™ÎœÎŸ</button>`}
                    </div>
                `;
            },
            acceptOrder: (id) => window.socket.emit('accept-order', Number(id)),
            completeOrder: (id) => { if(confirm("ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿;")) window.socket.emit('close-order', Number(id)); document.getElementById(`win-${id}`)?.remove(); },
            renderStaffList: (list) => {
                const sidebar = document.getElementById('staffList'); sidebar.innerHTML = '';
                list.forEach(u => {
                    if(u.role==='admin') return;
                    const d = document.createElement('div');
                    d.style = "padding:8px; margin-bottom:5px; background:#333; border-radius:4px; font-size:12px; display:flex; justify-content:space-between;";
                    d.innerHTML = `<span>${u.username}</span><span style="color:${u.status==='online'?'#00E676':'#FF9800'}">${u.status}</span>`;
                    d.onclick = () => window.socket.emit('trigger-alarm', u.username);
                    sidebar.appendChild(d);
                });
            },
            toggleFakeLock: () => {
                const el = document.getElementById('fakeLockOverlay');
                el.style.display = (el.style.display==='flex') ? 'none' : 'flex';
            },
            logout: () => { localStorage.removeItem('bellgo_session'); window.location.href="login.html"; }
        };

        window.onload = App.init;
    </script>
</body>
</html>
