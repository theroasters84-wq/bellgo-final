// --- UNIFIED MASTER AUDIO ENGINE ---
const AudioEngine = {
    master: null,
    isRinging: false,

    init: function() {
        this.master = document.getElementById('silence'); // Χρησιμοποιούμε αυτόν ως Master Player
        this.master.muted = false;
        this.master.volume = 0.2;
        this.playSilence();
        this.startWatchdog();
    },

    playSilence: function() {
        this.isRinging = false;
        this.master.src = "/silence.mp3";
        this.master.loop = true;
        this.master.play().catch(e => console.log("Audio logic wait for click"));
    },

    playAlarm: function() {
        this.isRinging = true;
        this.master.pause();
        this.master.src = "/alert.mp3"; // Αλλάζουμε το αρχείο στον ίδιο player
        this.master.loop = true;
        this.master.volume = 1.0;
        this.master.play().catch(e => {
            // Αν το iOS μπλοκάρει, δοκιμάζουμε ξανά επιθετικά
            setTimeout(() => this.master.play(), 500);
        });
    },

    stopAlarm: function() {
        this.master.pause();
        this.master.volume = 0.2;
        this.playSilence(); // Επιστροφή στη σιωπή στον ίδιο player
    },

    startWatchdog: function() {
        setInterval(() => {
            // Αν δεν χτυπάει ο συναγερμός και ο player σταμάτησε, ξαναξεκίνα τον
            if (!this.isRinging && (this.master.paused || this.master.ended)) {
                this.master.play().catch(e => {});
            }
            // Κράτα τη μπάρα μουσικής ενεργή στο Κέντρο Ελέγχου
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = "playing";
            }
        }, 3000);
    }
};
